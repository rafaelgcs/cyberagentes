<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cyber Agentes - Miss√£o Seguran√ßa</title>
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon.ico">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Press+Start+2P&family=Roboto:wght@300;400;700&display=swap');

        /* --- ESTILOS GERAIS --- */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            visibility: hidden;
            cursor: grab;
        }

        #game-container:active {
            cursor: grabbing;
        }

        /* --- UI --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #240b36 0%, #8314c3 30%, #8314c3 70%, #05d9ff 100%);
            color: white;
            transition: opacity 0.5s;
        }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #00eaff;
            text-align: center;
            line-height: 1.5;
            color: #ff00ff;
        }

        h2 {
            font-family: 'Rajdhani', sans-serif;
            color: #00eaff;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn {
            background: rgba(0, 0, 0, 0.6);
            color: #00eaff;
            border: 2px solid #00eaff;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.4);
            transition: all 0.2s;
            text-transform: uppercase;
            backdrop-filter: blur(5px);
        }

        .btn:hover {
            transform: scale(1.1);
            background: #00eaff;
            color: #000;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.8);
        }

        .btn-secondary {
            border-color: #ff00ff;
            color: #ff00ff;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.4);
        }

        .btn-secondary:hover {
            background: #ff00ff;
            color: #fff;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.8);
        }

        /* Bot√£o de Som Flutuante */
        #sound-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00eaff;
            color: #00eaff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 234, 255, 0.5);
            transition: all 0.3s;
        }

        #sound-toggle:hover {
            transform: scale(1.1);
            background: #00eaff;
            color: #000;
        }

        #sound-toggle.muted {
            border-color: #ff5555;
            color: #ff5555;
            box-shadow: 0 0 10px rgba(255, 85, 85, 0.5);
        }

        .credits-content,
        .guide-content {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00eaff;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
            font-family: 'Roboto', sans-serif;
            box-shadow: 0 0 20px rgba(0, 234, 255, 0.2);
            max-height: 70vh;
            overflow-y: auto;
        }

        .agent-selector {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }

        .agent-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #444;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            width: 180px;
        }

        .agent-card:hover {
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .agent-card.selected {
            border-color: #ffd54f;
            background: rgba(255, 213, 79, 0.2);
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 0 25px #ffd54f;
        }

        #agent-1 .agent-icon {
            color: #00eaff;
            text-shadow: 0 0 15px #00eaff;
        }

        #agent-2 .agent-icon {
            color: #d500f9;
            text-shadow: 0 0 15px #d500f9;
        }

        .agent-icon {
            font-size: 4rem;
            margin-bottom: 10px;
            display: block;
        }

        #game-ui {
            display: none;
        }

        #mission-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 10, 30, 0.9);
            border: 2px solid #00eaff;
            padding: 15px;
            width: 280px;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.3);
            z-index: 10;
            border-radius: 10px;
            font-family: 'Rajdhani', sans-serif;
        }

        #mission-hud h4 {
            margin: 0 0 5px 0;
            color: #00eaff;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 234, 255, 0.3);
            padding-bottom: 5px;
        }

        #dialog-box {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 700px;
            background: rgba(10, 10, 40, 0.95);
            border: 2px solid #ff00ff;
            border-radius: 15px;
            padding: 20px;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.4);
            z-index: 20;
            color: #fff;
            cursor: pointer;
        }

        #npc-name {
            font-weight: bold;
            color: #ff00ff;
            margin-bottom: 5px;
            display: block;
            font-size: 1.2rem;
            text-shadow: 0 0 5px #ff00ff;
        }

        #dialog-text {
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .quiz-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .quiz-btn {
            background: #333;
            border: 1px solid #fff;
            color: #fff;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
        }

        .quiz-btn:hover {
            background: #00eaff;
            color: #000;
            border-color: #00eaff;
        }

        #joystick-zone {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            z-index: 20;
        }

        /* CUTSCENE & TUTORIAL */
        .overlay-full {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 200;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            text-align: center;
            padding: 40px;
            box-sizing: border-box;
        }

        .cutscene-text {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.5rem;
            color: #00eaff;
            margin-bottom: 30px;
            line-height: 1.8;
            text-shadow: 0 0 10px #00eaff;
            max-width: 800px;
            min-height: 100px;
        }

        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-end infinite;
            color: #00eaff;
            margin-left: 5px;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .tutorial-box {
            background: rgba(0, 20, 40, 0.95);
            border: 2px solid #ffd54f;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            text-align: center;
        }

        .key-icon {
            display: inline-block;
            padding: 5px 10px;
            border: 1px solid #fff;
            border-radius: 5px;
            margin: 0 2px;
            background: #333;
            font-family: monospace;
            font-weight: bold;
        }

        #transition-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 150;
            display: none;
            justify-content: center;
            align-items: center;
            color: #00eaff;
            font-size: 2rem;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 0 0 10px #00eaff;
        }

        #computer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 60;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .pc-window {
            width: 800px;
            height: 600px;
            background: #0d0d1a;
            border: 2px solid #00eaff;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(0, 234, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            position: relative;
        }

        .pc-header {
            background: linear-gradient(90deg, #00eaff 0%, #0077ff 100%);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #000;
            font-weight: bold;
            border-bottom: 1px solid #00eaff;
        }

        .close-btn {
            background: #ff0055;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        .pc-content {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #00eaff;
            background: repeating-linear-gradient(0deg,
                    rgba(0, 234, 255, 0.05) 0px,
                    rgba(0, 234, 255, 0.05) 1px,
                    transparent 1px,
                    transparent 20px);
            overflow-y: auto;
        }

        /* ESTILOS DO DESKTOP SIMULADO */
        .desktop-grid {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            width: 100%;
            height: 100%;
            padding: 20px;
        }

        .desktop-icon {
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 15px;
            border-radius: 8px;
            transition: 0.2s;
            color: white;
            text-shadow: 0 0 5px black;
            text-align: center;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .desktop-icon-img {
            font-size: 40px;
            margin-bottom: 5px;
        }

        /* ESTILO DE JANELA INTERNA (APP) */
        .app-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 85%;
            background: #f0f2f5;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #444;
        }

        .app-header-bar {
            background: #1877f2;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
        }

        .app-close-btn {
            cursor: pointer;
            background: #ff3333;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .login-form input {
            padding: 15px;
            width: 300px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 2px solid #00eaff;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .password-feedback {
            font-size: 14px;
            margin-top: 15px;
            color: #ff5555;
            min-height: 20px;
            text-shadow: 0 0 5px rgba(255, 85, 85, 0.5);
        }

        .sequence-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .seq-btn {
            width: 100px;
            height: 100px;
            border-radius: 15px;
            cursor: pointer;
            border: 4px solid #333;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .seq-btn:active {
            transform: scale(0.95);
        }

        .seq-btn.active {
            opacity: 1;
            box-shadow: 0 0 30px currentColor;
            border-color: white;
            transform: scale(1.1);
        }

        .seq-btn.red {
            background-color: #ff0055;
            color: #ff0055;
        }

        .seq-btn.green {
            background-color: #00ff88;
            color: #00ff88;
        }

        .seq-btn.blue {
            background-color: #00eaff;
            color: #00eaff;
        }

        .seq-btn.yellow {
            background-color: #ffd54f;
            color: #ffd54f;
        }

        .social-feed {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: #eef2f5;
            color: #333;
            padding: 20px;
        }

        .post {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        .post-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1877f2;
            display: flex;
            align-items: center;
        }

        .fake-news-btn {
            background: #ff0055;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 0, 85, 0.4);
            transition: transform 0.2s;
        }

        .fake-news-btn:hover {
            transform: scale(1.05);
        }

        .custom-interface {
            width: 100%;
            max-width: 600px;
            background: rgba(13, 13, 26, 0.9);
            border: 1px solid #00eaff;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .custom-interface h3 {
            margin: 0 0 25px 0;
            color: #fff;
            font-size: 1.8rem;
            text-shadow: 0 0 10px #00eaff;
            letter-spacing: 2px;
            border-bottom: 2px solid #00eaff;
            padding-bottom: 10px;
            width: 100%;
            text-align: center;
        }

        .custom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            margin-bottom: 30px;
        }

        .custom-section {
            background: rgba(0, 234, 255, 0.05);
            border: 1px solid rgba(0, 234, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .custom-section label {
            font-size: 0.9rem;
            color: #00eaff;
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 1px;
            text-align: center;
            width: 100%;
        }

        .cyber-input {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #555;
            border-bottom: 2px solid #00eaff;
            color: #fff;
            padding: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            outline: none;
            transition: 0.3s;
            width: 90%;
        }

        .cyber-input:focus {
            border-color: #fff;
            background: rgba(0, 234, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.2);
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            background: none;
            padding: 0;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: 2px solid #fff;
            border-radius: 50%;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border: 1px solid #555;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 0 5px #fff;
        }

        input:checked+.slider {
            background-color: #00eaff;
            border-color: #00eaff;
            box-shadow: 0 0 15px #00eaff;
        }

        input:checked+.slider:before {
            transform: translateX(30px);
            background-color: #000;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }

        .cyber-btn {
            background: #00eaff;
            color: #000;
            border: none;
            font-weight: bold;
            padding: 12px 30px;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            cursor: pointer;
        }

        .cyber-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px #00eaff;
        }

        /* ARCADE STYLES */
        .arcade-btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            margin-top: 20px;
        }

        .arcade-opt-btn {
            background: #222;
            border: 2px solid #fff;
            color: #fff;
            padding: 15px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: 0.2s;
        }

        .arcade-opt-btn:hover {
            background: #00eaff;
            color: #000;
            border-color: #00eaff;
            transform: scale(1.05);
        }

        .arcade-big-text {
            font-size: 2rem;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px currentColor;
        }

        .hair-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 5px;
            border-radius: 20px;
        }

        .hair-arrow-btn {
            background: rgba(0, 234, 255, 0.2);
            border: 1px solid #00eaff;
            color: #00eaff;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .hair-arrow-btn:hover {
            background: #00eaff;
            color: #000;
        }

        #hair-style-label {
            font-family: 'Rajdhani', sans-serif;
            color: #fff;
            min-width: 80px;
            text-align: center;
        }

        @media (max-width: 500px) {
            .game-board {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
        }
    </style>

    <!-- Bot√£o de Toggle de Som -->
    <div id="sound-toggle" onclick="toggleMusic()">üîä</div>

    <!-- PLACEHOLDER PARA O SEU √ÅUDIO DE DITITA√á√ÉO -->
    <audio id="typing-audio" loop hidden>
        <source src="./assets/sounds/typing.mp3" type="audio/mpeg">
    </audio>

    <!-- √ÅUDIO DE FUNDO (LOOP) -->
    <audio id="bg-music" loop>
        <source src="./assets/sounds/musica.mp3" type="audio/mpeg">
    </audio>

    <!-- Scripts -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
</head>

<body>

    <div id="screen-menu" class="screen">
        <div>
            <img src="./assets/img/logo_cyber_agentes.png" width="350" alt="Cyber Agentes Logo"
                onerror="this.style.display='none'; document.querySelector('h1').style.display='block';" />
        </div>
        <h1>Miss√£o Seguran√ßa</h1>
        <div style="text-align: center;">
            <button class="btn" onclick="goToSelect()">JOGAR</button>
            <button class="btn btn-secondary" onclick="goToGuide()">GUIA</button>
            <button class="btn btn-secondary" onclick="goToCredits()">CR√âDITOS</button>
        </div>
    </div>

    <div id="screen-credits" class="screen hidden">
        <h2>QUEM FEZ O JOGO?</h2>
        <div class="credits-content">
            <p><strong>Cria√ß√£o:</strong> Equipe Cyber Agentes</p>
            <p><strong>Miss√£o:</strong> Ensinar seguran√ßa online para todos!</p>
            <p style="text-align:justify;">
                <strong>Agradecimentos:</strong>
                O jogo Cyber Agentes foi desenvolvido com o apoio inestim√°vel da professora orientadora Lynn Alves, que
                nos forneceu a base de conhecimento necess√°ria. Ressaltamos que ferramentas de Intelig√™ncia Artificial
                foram utilizadas durante o processo criativo para auxiliar em defini√ß√µes t√©cnicas e na gera√ß√£o de
                imagens para fins de idea√ß√£o e conceito.
            </p>
            <p style="font-size: 0.9em; font-style: italic; color: #ff00ff;">"Jogue seguro, jogue feliz!"</p>
        </div>
        <button class="btn btn-secondary" onclick="goToMenu()" style="margin-top: 30px;">VOLTAR</button>
    </div>

    <div id="screen-guide" class="screen hidden">
        <h2>GUIA DO AGENTE</h2>
        <div class="guide-content">
            <h3>HIST√ìRIA</h3>
            <p>No futuro, o mundo digital √© nossa segunda casa. A ordem dos <strong>Cyber Agentes</strong> foi criada
                para proteger essa casa de invasores, fake news e pessoas mal intencionadas.</p>
            <hr style="border-color: #00eaff; margin: 20px 0;">
            <h3>COMO JOGAR</h3>
            <p><strong class="key-icon">W</strong> <strong class="key-icon">A</strong> <strong
                    class="key-icon">S</strong> <strong class="key-icon">D</strong> ou <strong>JOYSTICK</strong> para
                andar.</p>
            <p>Encoste em <strong>Portais</strong> para viajar.</p>
            <p>Complete as miss√µes dadas pelo Comandante Motta para subir de n√≠vel!</p>
        </div>
        <button class="btn btn-secondary" onclick="goToMenu()" style="margin-top: 30px;">ENTENDIDO</button>
    </div>

    <div id="screen-select" class="screen hidden">
        <h2>ESCOLHA SEU AGENTE</h2>
        <div class="agent-selector">
            <div class="agent-card" id="agent-1" onclick="selectAgent(1)">
                <div class="agent-icon">ü§ñ</div>
                <h3 style="color: #fff;">Agente ANDROIDE</h3>
                <small style="color: #00eaff;">Resist√™ncia Digital</small>
            </div>
            <div class="agent-card" id="agent-2" onclick="selectAgent(2)">
                <div class="agent-icon">üßë‚ÄçüöÄ</div>
                <h3 style="color: #fff;">Agente HUMANO</h3>
                <small style="color: #d500f9;">Intui√ß√£o Humana</small>
            </div>
        </div>
        <button id="btn-start-game" class="btn" style="opacity: 0.5; pointer-events: none;"
            onclick="launchGame()">COME√áAR MISS√ÉO</button>
        <br>
        <button class="btn btn-secondary" style="font-size: 1rem; padding: 10px 20px;"
            onclick="goToMenu()">VOLTAR</button>
    </div>

    <!-- CUTSCENE OVERLAY -->
    <div id="cutscene-overlay" class="hidden overlay-full">
        <div id="cutscene-content" class="cutscene-text"></div>
        <button id="skip-btn" class="btn" style="position:absolute; bottom:20px; right:20px; z-index:201;"
            onclick="skipCutscene()">PULAR >></button>
    </div>

    <!-- TUTORIAL OVERLAY -->
    <div id="tutorial-overlay" class="hidden overlay-full" style="background: rgba(0,0,0,0.8);">
        <div class="tutorial-box">
            <h3 style="color:#ffd54f; margin-bottom:20px;">PRIMEIROS PASSOS</h3>
            <p>Bem-vindo ao Centro de Opera√ß√µes!</p>
            <p style="margin: 20px 0;">Use <span class="key-icon">W</span><span class="key-icon">A</span><span
                    class="key-icon">S</span><span class="key-icon">D</span> ou o <strong>Joystick</strong> na tela para
                se mover.</p>
            <p>Procure por personagens ou objetos com um sinal de <strong>!</strong> amarelo e CHEGUE PERTO deles para
                interagir.</p>
            <button class="btn" onclick="closeTutorial()">VAMOS L√Å!</button>
        </div>
    </div>

    <div id="game-container"></div>
    <div id="transition-screen">VIAJANDO PELA REDE...</div>

    <!-- Interface Computador / Arcade -->
    <div id="computer-overlay">
        <div class="pc-window">
            <div class="pc-header">
                <span id="overlay-title">üîí Sistema de Defesa Online</span>
                <span class="close-btn" onclick="closePC()">X</span>
            </div>

            <!-- 1. Customiza√ß√£o -->
            <div class="pc-content hidden" id="pc-view-custom" style="padding: 0;">
                <div class="custom-interface">
                    <h3>PERFIL DE AGENTE</h3>

                    <div class="custom-grid">
                        <div class="custom-section" style="grid-column: span 2;">
                            <label>CODINOME SECRETO</label>
                            <input type="text" id="custom-name" placeholder="Ex: Capit√£o Net" class="cyber-input">
                        </div>

                        <!-- SE√á√ÉO DE CABELO NOVA -->
                        <div class="custom-section">
                            <label>ESTILO DE CABELO</label>
                            <div class="hair-selector">
                                <button class="hair-arrow-btn" onclick="cycleHairStyle(-1)">
                                    < </button>
                                        <span id="hair-style-label">Careca</span>
                                        <button class="hair-arrow-btn" onclick="cycleHairStyle(1)">></button>
                            </div>
                        </div>
                        <div class="custom-section">
                            <label>COR DO CABELO</label>
                            <div class="color-picker-container">
                                <input type="color" id="custom-hair-color" value="#553311">
                            </div>
                        </div>

                        <div class="custom-section">
                            <label>COR DA MOCHILA</label>
                            <div class="color-picker-container">
                                <input type="color" id="custom-backpack-color" value="#222222">
                            </div>
                        </div>
                        <div class="custom-section">
                            <label>USAR CAPACETE?</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="custom-helmet-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="custom-section hidden" id="helmet-color-section">
                            <label>COR DO CAPACETE</label>
                            <div class="color-picker-container">
                                <input type="color" id="custom-helmet-color" value="#00eaff">
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn cyber-btn" onclick="applyCustomization()">SALVAR IDENTIDADE</button>
                    </div>
                </div>
            </div>

            <!-- 2. Login (Desafio de Senha) -->
            <div class="pc-content hidden" id="pc-view-login">
                <h3 style="margin-bottom: 20px; text-shadow: 0 0 10px #00eaff;">SENHA SUPER SECRETA</h3>
                <div class="login-form" style="text-align: center;">
                    <p style="font-size: 16px; margin-bottom: 20px; color: #fff;">
                        Crie uma senha que ningu√©m descubra!<br>
                        <small style="color:#aaa;">(Use 8 letras, 1 Mai√∫scula, 1 N√∫mero e 1 S√≠mbolo como ! ou @)</small>
                    </p>
                    <input type="password" id="pc-pass-input" placeholder="Digite aqui a senha...">
                    <br>
                    <button class="btn" style="padding: 10px 30px; font-size: 1rem; border-radius: 25px;"
                        onclick="checkPassword()">TESTAR SENHA</button>
                    <div class="password-feedback" id="pass-feedback"></div>
                </div>
            </div>

            <!-- 3. Puzzle (Sequ√™ncia / Simon Says) -->
            <div class="pc-content hidden" id="pc-view-sequence">
                <h3 style="margin-bottom: 10px; color: #ffd54f;">MEM√ìRIA DE FERRO</h3>
                <p style="margin-bottom: 20px;">Repita a sequ√™ncia de cores para provar que √© um rob√¥ esperto!</p>
                <div id="seq-status" style="height: 30px; color: #fff; font-weight: bold;">Prepare-se...</div>
                <div class="sequence-grid">
                    <div class="seq-btn red" id="btn-0" onclick="handleSeqInput(0)"></div>
                    <div class="seq-btn green" id="btn-1" onclick="handleSeqInput(1)"></div>
                    <div class="seq-btn blue" id="btn-2" onclick="handleSeqInput(2)"></div>
                    <div class="seq-btn yellow" id="btn-3" onclick="handleSeqInput(3)"></div>
                </div>
                <button id="btn-start-seq" class="btn" style="margin-top: 20px; padding: 10px 20px; font-size: 1rem;"
                    onclick="startSequenceGame()">COME√áAR JOGO</button>
            </div>

            <!-- 4. AREA DE TRABALHO (Desktop) -->
            <div class="pc-content hidden" id="pc-view-desktop"
                style="padding: 0; justify-content: flex-start; align-items: flex-start;">
                <div class="desktop-grid">
                    <div class="desktop-icon" onclick="openFaceLook()">
                        <div class="desktop-icon-img">üìò</div>
                        <div>FaceLook</div>
                    </div>
                    <div class="desktop-icon" onclick="alert('Acesso restrito a administradores!')">
                        <div class="desktop-icon-img">üìÅ</div>
                        <div>Arquivos</div>
                    </div>
                    <div class="desktop-icon">
                        <div class="desktop-icon-img">üóëÔ∏è</div>
                        <div>Lixeira</div>
                    </div>
                </div>

                <!-- JANELA FLUTUANTE DA REDE SOCIAL -->
                <div id="social-app-window" class="app-window hidden">
                    <div class="app-header-bar">
                        <span>FaceLook - Feed Seguro</span>
                        <span class="app-close-btn" onclick="closeFaceLook()">X</span>
                    </div>
                    <div class="social-feed">
                        <div class="post">
                            <div class="post-header"> <span style="margin-right: 5px;">üò∫</span> Clube dos Gatinhos
                            </div>
                            <p>Olha que foto fofa! üí§ #soneca</p>
                        </div>
                        <div class="post" style="border: 2px solid #ff0055; background-color: #fff0f5;">
                            <div class="post-header" style="color: #d32f2f;">‚ö†Ô∏è CUIDADO: GOLPE!</div>
                            <p style="font-weight: bold;">"GANHE ROBUX E DIAMANTES GR√ÅTIS! Basta me passar sua senha!"
                                üò±üö´</p>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">Usu√°rio: Trapaceiro123</p>
                            <button class="fake-news-btn" onclick="reportFakeNews()">üö® DENUNCIAR GOLPE</button>
                        </div>
                        <div class="post">
                            <div class="post-header"><span style="margin-right: 5px;">üè´</span> Escola do Futuro</div>
                            <p>Amanh√£ teremos aula de seguran√ßa digital.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. ARCADE VIEW -->
            <div class="pc-content hidden" id="pc-view-arcade">
                <div id="arcade-game-container" style="text-align: center; width: 100%;">
                    <h3 id="arcade-title" style="color: #ff00ff; text-transform: uppercase; letter-spacing: 2px;">ARCADE
                    </h3>
                    <div id="arcade-display">
                        <!-- Conte√∫do do Puzzle √© injetado aqui -->
                    </div>
                    <div id="arcade-feedback" style="margin-top: 20px; font-weight: bold; height: 30px;"></div>
                </div>
            </div>

        </div>
    </div>

    <div id="game-ui">
        <div id="mission-hud">
            <h4>SUA MISS√ÉO</h4>
            <div style="font-size: 14px; display: flex; align-items: center; margin-top: 8px;">
                <span style="color: #00eaff; margin-right: 8px; font-size: 18px;">‚û§</span>
                <span id="obj-text">Fale com o Comandante</span>
            </div>
        </div>

        <div id="dialog-box">
            <span id="npc-name">SISTEMA</span>
            <div id="dialog-text">...</div>
            <div id="dialog-options" class="quiz-options hidden"></div>
            <div style="text-align: right; color: #aaa; font-size: 12px; margin-top: 10px;" id="dialog-click-hint">[
                TOQUE PARA CONTINUAR ]</div>
        </div>

        <div id="joystick-zone"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- CONFIGURA√á√ÉO ---
        const CONFIG = {
            speed: 12,
            colors: {
                background: 0x050510,
                fog: 0x100020,
                floorGrid: 0x220044,
                agent1: 0x00eaff,
                agent2: 0xd500f9,
                commander: 0xff6f00,
                npc: 0x00ff88,
                skin: 0xffdbac,
                backpack: 0x111111,
                neonLight: 0x00eaff,
                defaultHair: 0x553311
            }
        };

        // Globais
        let scene, camera, renderer, clock, composer;
        let player, playerBody;
        let levelObjects = [], obstacles = [], interactables = [], floors = [], markers = [];
        let wallMeshes = []; // Array para controle de transpar√™ncia
        let drones = [], mazeDoors = []; // Novos arrays para o labirinto
        let selectedAgentId = null, missionProgress = 0, currentLevel = "LOBBY";
        let isTransitioning = false; // Flag para evitar m√∫ltiplas transi√ß√µes

        // Estado de Di√°logo
        let isDialogOpen = false, currentDialogQueue = [];
        let isQuizMode = false;

        // --- ESTADO DO JOGADOR ---
        let playerState = {
            name: "Agente",
            hasHelmet: false,
            backpackColor: 0x111111,
            helmetColor: 0x00eaff,
            hairStyle: 0,
            hairColor: CONFIG.colors.defaultHair
        };

        const HAIR_STYLES = ["Careca", "Curto Espetado", "Tigela M√©dio", "Longo Rabo de Cavalo"];
        let uiSelectedHairStyleIndex = 0;

        let wallTextureBase, doorTextureBase, floorTextureBase, carpetTexture, portalTexture, screenTexture, hologramTexture, posterTexture;
        let serverFloorTexture, serverWallTexture, strategicMapTexture;
        let posterRulesTexture, posterDownloadsTexture, posterChatTexture, arcadeMarqueeTexture, arcadeSideTexture;

        let keys = { w: false, a: false, s: false, d: false };
        let joystickVec = new THREE.Vector3(), cameraAngle = 0;
        let isMouseDown = false, dragStartX = 0, isDraggingView = false, walkTime = 0;

        const groundRaycaster = new THREE.Raycaster();
        const wallRaycaster = new THREE.Raycaster(); // Raycaster para transpar√™ncia

        // --- SISTEMA DE SOM ---
        const bgMusic = document.getElementById('bg-music');
        const soundBtn = document.getElementById('sound-toggle');
        const touchButtonSoundUrls = [
            './assets/sounds/wave_1.mp3',
            './assets/sounds/wave_2.mp3',
            './assets/sounds/wave_3.mp3',
            './assets/sounds/wave_4.mp3'
        ];
        let isMusicPlaying = false;

        window.toggleMusic = function () {
            if (bgMusic.paused) {
                bgMusic.play().then(() => {
                    isMusicPlaying = true;
                    soundBtn.innerText = "üîä";
                    soundBtn.classList.remove('muted');
                }).catch(e => console.log("Audio play failed:", e));
            } else {
                bgMusic.pause();
                isMusicPlaying = false;
                soundBtn.innerText = "üîá";
                soundBtn.classList.add('muted');
            }
        }

        document.body.addEventListener('click', () => {
            if (bgMusic.paused && !soundBtn.classList.contains('muted')) {
                bgMusic.play().catch(() => { });
                soundBtn.innerText = "üîä";
            }
        }, { once: true });

        // --- CUTSCENES ---
        const CUTSCENES = {
            intro: [
                "Ano 2077... O mundo digital √© vasto e incr√≠vel.",
                "Mas hackers e vil√µes tentam estragar a divers√£o.",
                "A 'Ordem dos Cyber Agentes' precisa de novos recrutas.",
                "Voc√™ foi escolhido para proteger o futuro!"
            ]
        };

        let currentCutsceneLines = [];
        let currentCutsceneIndex = 0;
        let typeWriterTimeout;

        function playCutscene(id) {
            const lines = CUTSCENES[id];
            if (!lines) return;
            currentCutsceneLines = lines;
            currentCutsceneIndex = 0;
            const overlay = document.getElementById('cutscene-overlay');
            overlay.classList.remove('hidden');
            showCutsceneLine();
        }

        function typeWriter(text, element, speed, callback) {
            let i = 0;
            element.innerHTML = "";
            const audio = document.getElementById('typing-audio');
            if (audio) { audio.currentTime = 0; audio.play().catch(() => { }); }

            function type() {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                    typeWriterTimeout = setTimeout(type, speed);
                } else {
                    if (audio) audio.pause();
                    typeWriterTimeout = setTimeout(callback, 2000);
                }
            }
            type();
        }

        function showCutsceneLine() {
            const content = document.getElementById('cutscene-content');
            content.classList.add('typing-cursor');

            if (currentCutsceneIndex < currentCutsceneLines.length) {
                const line = currentCutsceneLines[currentCutsceneIndex];
                currentCutsceneIndex++;
                typeWriter(line, content, 50, showCutsceneLine);
            } else {
                content.classList.remove('typing-cursor');
                document.getElementById('cutscene-overlay').classList.add('hidden');
                if (missionProgress === 6) {
                    goToCredits();
                } else {
                    startGameWorld();
                }
            }
        }

        window.skipCutscene = function () {
            clearTimeout(typeWriterTimeout);
            const audio = document.getElementById('typing-audio');
            if (audio) audio.pause();

            document.getElementById('cutscene-overlay').classList.add('hidden');
            if (missionProgress === 6) {
                goToCredits();
            } else {
                startGameWorld();
            }
        };

        // --- TUTORIAL ---
        function showTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('hidden');
        }

        window.closeTutorial = () => {
            document.getElementById('tutorial-overlay').classList.add('hidden');
            startDialog("SISTEMA", ["Bem-vindo, Recruta!", "Sua miss√£o √© aprender a se defender na internet.", "Fale com o Comandante Motta para come√ßar."]);
        };

        // --- ARCADE (RESTAURADO COMPLETO) ---
        let arcadeActive = false;

        function startArcadeGame() {
            window.arcadeMemState = { cards: [], flippedIndices: [], matchedCount: 0, lockBoard: false };
            window.initArcadeMemory = function (cards) {
                window.arcadeMemState = { cards: cards, flippedIndices: [], matchedCount: 0, lockBoard: false };
            };
            window.arcadeFlip = function (index) {
                const state = window.arcadeMemState;
                const cardEl = document.getElementById(`mem-card-${index}`);
                if (!cardEl || state.lockBoard || state.flippedIndices.includes(index) || cardEl.classList.contains('matched')) return;

                cardEl.innerText = state.cards[index];
                cardEl.style.backgroundColor = '#fff';
                cardEl.style.color = '#000';
                cardEl.style.transform = "scale(1.1)";
                state.flippedIndices.push(index);

                if (state.flippedIndices.length === 2) {
                    state.lockBoard = true;
                    const idx1 = state.flippedIndices[0];
                    const idx2 = state.flippedIndices[1];
                    const val1 = state.cards[idx1];
                    const val2 = state.cards[idx2];

                    if (val1 === val2) {
                        const el1 = document.getElementById(`mem-card-${idx1}`);
                        const el2 = document.getElementById(`mem-card-${idx2}`);
                        el1.classList.add('matched'); el2.classList.add('matched');
                        el1.style.borderColor = '#2ecc71'; el2.style.borderColor = '#2ecc71';
                        state.matchedCount++;
                        state.flippedIndices = [];
                        state.lockBoard = false;
                        if (state.matchedCount === state.cards.length / 2) {
                            document.getElementById('arcade-feedback').innerText = "SISTEMA SEGURO! üõ°Ô∏è";
                            setTimeout(closePC, 1500);
                        }
                    } else {
                        setTimeout(() => {
                            const el1 = document.getElementById(`mem-card-${idx1}`);
                            const el2 = document.getElementById(`mem-card-${idx2}`);
                            if (el1) { el1.innerText = '‚ùì'; el1.style.backgroundColor = 'rgba(255,255,255,0.1)'; el1.style.color = '#fff'; el1.style.transform = "scale(1)"; }
                            if (el2) { el2.innerText = '‚ùì'; el2.style.backgroundColor = 'rgba(255,255,255,0.1)'; el2.style.color = '#fff'; el2.style.transform = "scale(1)"; }
                            state.flippedIndices = [];
                            state.lockBoard = false;
                        }, 1000);
                    }
                }
            };

            // --- LISTA COMPLETA DE PUZZLES ---
            const puzzles = [
                // 1. Matem√°tica
                {
                    type: 'math',
                    title: 'HACK MATEM√ÅTICO',
                    setup: (p) => {
                        const a = Math.floor(Math.random() * 10);
                        const b = Math.floor(Math.random() * 10);
                        const ans = a + b;
                        const opts = [ans, ans + 1, ans - 1].sort(() => Math.random() - 0.5);

                        return `<div class="arcade-big-text">${a} + ${b} = ?</div>
                                <div class="arcade-btn-group">
                                    ${opts.map(o => `<div class="arcade-opt-btn" onclick="checkArcadeAnswer('${o}', '${ans}')">${o}</div>`).join('')}
                                </div>`;
                    }
                },
                // 2. Quiz
                {
                    type: 'quiz',
                    title: 'QUIZ SEGURO',
                    q: { text: "Algu√©m pediu sua foto na internet. O que fazer?", opts: ["Mandar logo", "N√£o mandar e avisar um adulto", "Mandar s√≥ uma"], ans: "N√£o mandar e avisar um adulto" },
                    setup: (p) => {
                        return `<div style="font-size: 1.2rem; margin-bottom: 20px;">${p.q.text}</div>
                                <div style="display:flex; flex-direction:column; gap:10px;">
                                    ${p.q.opts.map(o => `<div class="arcade-opt-btn" onclick="checkArcadeAnswer('${o}', '${p.q.ans}')">${o}</div>`).join('')}
                                </div>`;
                    }
                },
                // 3. Reflexo
                {
                    type: 'reflex',
                    title: 'REFLEXO R√ÅPIDO',
                    setup: () => {
                        setTimeout(() => {
                            const btn = document.getElementById('reflex-btn');
                            if (btn) {
                                btn.style.display = 'block';
                                btn.style.backgroundColor = '#00ff00';
                                btn.innerText = 'CLIQUE AGORA!';
                                btn.dataset.start = Date.now();
                            }
                        }, 1000 + Math.random() * 2000);
                        return `<div id="reflex-msg">Espere ficar verde...</div>
                                <div id="reflex-btn" class="arcade-opt-btn" style="display:none; margin-top:20px; background:red;" onclick="checkReflex()">ESPERE...</div>`;
                    }
                },
                // 4. Decodificador
                {
                    type: 'unscramble',
                    title: 'DECODIFICADOR',
                    word: 'SENHA',
                    scrambled: 'ASNEH',
                    setup: (p) => {
                        return `<p>Desembaralhe: <strong style="font-size:1.5rem; color:#00eaff;">${p.scrambled}</strong></p>
                                <input type="text" id="unscramble-in" class="cyber-input" style="text-transform:uppercase; margin-top:10px;">
                                <button class="btn" style="margin-top:10px; font-size:1rem;" onclick="checkUnscramble('${p.word}')">VERIFICAR</button>`;
                    }
                },
                // 5. Cor
                {
                    type: 'color',
                    title: 'ATEN√á√ÉO √Ä COR',
                    target: 'AZUL',
                    colorCode: '#00eaff',
                    setup: (p) => {
                        return `<div class="arcade-big-text" style="color:${p.colorCode}">CLIQUE NO ${p.target}</div>
                                <div class="arcade-btn-group">
                                    <div class="arcade-opt-btn" style="background:red;" onclick="checkArcadeAnswer('red', '${p.colorCode}')"></div>
                                    <div class="arcade-opt-btn" style="background:#00eaff;" onclick="checkArcadeAnswer('#00eaff', '${p.colorCode}')"></div>
                                    <div class="arcade-opt-btn" style="background:green;" onclick="checkArcadeAnswer('green', '${p.colorCode}')"></div>
                                    <div class="arcade-opt-btn" style="background:yellow;" onclick="checkArcadeAnswer('yellow', '${p.colorCode}')"></div>
                                </div>`;
                    }
                },
                // 6. Memory
                {
                    type: 'memory',
                    title: 'MEM√ìRIA CRIPTOGRAFADA',
                    setup: (p) => {
                        const icons = ['üîí', 'üõ°Ô∏è', 'üîë', 'üëÅÔ∏è'];
                        let deck = [...icons, ...icons].sort(() => 0.5 - Math.random());
                        initArcadeMemory(deck);
                        return `<div style="font-size: 1rem; margin-bottom: 10px;">Encontre os pares para desbloquear!</div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; max-width: 300px; margin: 0 auto;">
                                    ${deck.map((icon, i) => `
                                        <div id="mem-card-${i}" onclick="arcadeFlip(${i})"
                                            style="height: 50px; background: rgba(255,255,255,0.1); border: 2px solid #00eaff; padding: 3px; border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.5rem; user-select: none;">
                                            ‚ùì
                                        </div>
                                    `).join('')}
                                </div>`;
                    }
                }
            ];

            const puzzle = puzzles[Math.floor(Math.random() * puzzles.length)];

            document.getElementById('overlay-title').innerText = "üëæ FLIPERAMA 3000";
            document.getElementById('arcade-title').innerText = puzzle.title;
            document.getElementById('arcade-display').innerHTML = puzzle.setup(puzzle);
            document.getElementById('arcade-feedback').innerText = "";

            const arcadeView = document.getElementById('pc-view-arcade');
            if (arcadeView) arcadeView.classList.remove('hidden');

            ['pc-view-custom', 'pc-view-login', 'pc-view-sequence', 'pc-view-desktop', 'pc-view-social'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            document.getElementById('computer-overlay').style.display = 'flex';
        }

        window.checkArcadeAnswer = (val, correct) => {
            const fb = document.getElementById('arcade-feedback');
            if (val == correct) {
                fb.style.color = '#00ff88'; fb.innerText = "CORRETO! +100 PONTOS";
                setTimeout(closePC, 1500);
                // Check if it's a door puzzle
                if (window.currentDoor) {
                    const door = window.currentDoor;
                    scene.remove(door);
                    const idx = interactables.indexOf(door.children.find(c => c.userData.isInteractable));
                    if (idx > -1) interactables.splice(idx, 1);
                    // Remove collision box
                    // This is simplified; real collision removal would require tracking ID
                    obstacles = obstacles.filter(o => !o.containsPoint(door.position)); // Rough removal

                    window.currentDoor = null;
                }
            } else {
                fb.style.color = '#ff5555'; fb.innerText = "ERROU! TENTE DE NOVO.";
            }
        };

        window.checkReflex = () => {
            const btn = document.getElementById('reflex-btn');
            const fb = document.getElementById('arcade-feedback');
            if (btn.style.backgroundColor === 'rgb(0, 255, 0)' || btn.style.backgroundColor === '#00ff00') {
                const time = Date.now() - parseInt(btn.dataset.start);
                fb.style.color = '#00ff88'; fb.innerText = `√ìTIMO! ${time}ms`;
                setTimeout(closePC, 1500);
                if (window.currentDoor) {
                    const door = window.currentDoor;
                    scene.remove(door);
                    const idx = interactables.indexOf(door.children.find(c => c.userData.isInteractable));
                    if (idx > -1) interactables.splice(idx, 1);
                    obstacles = obstacles.filter(o => !o.containsPoint(door.position));
                    window.currentDoor = null;
                }
            } else {
                fb.style.color = '#ff5555'; fb.innerText = "MUITO CEDO!";
            }
        };

        window.checkUnscramble = (correct) => {
            const val = document.getElementById('unscramble-in').value.toUpperCase();
            window.checkArcadeAnswer(val, correct);
        }

        // --- COLIS√ÉO ---
        function addCollisionBox(centerX, centerY, centerZ, w, h, d) {
            const box = new THREE.Box3();
            box.setFromCenterAndSize(new THREE.Vector3(centerX, centerY, centerZ), new THREE.Vector3(w, h, d));
            obstacles.push(box);
        }

        // --- GLOBAL FUNCS ---
        window.cycleHairStyle = (direction) => {
            uiSelectedHairStyleIndex += direction;
            if (uiSelectedHairStyleIndex < 0) uiSelectedHairStyleIndex = HAIR_STYLES.length - 1;
            if (uiSelectedHairStyleIndex >= HAIR_STYLES.length) uiSelectedHairStyleIndex = 0;
            document.getElementById('hair-style-label').innerText = HAIR_STYLES[uiSelectedHairStyleIndex];
        };

        window.advanceDialog = function () {
            if (!isDialogOpen || isQuizMode) return;
            if (currentDialogQueue.length > 0) {
                const item = currentDialogQueue.shift();
                if (typeof item === 'object') showQuiz(item);
                else document.getElementById('dialog-text').innerText = item;
            } else {
                document.getElementById('dialog-box').style.display = 'none';
                isDialogOpen = false;
            }
        }

        function showQuiz(quizData) {
            isQuizMode = true;
            document.getElementById('dialog-text').innerText = quizData.question;
            const optsDiv = document.getElementById('dialog-options');
            optsDiv.innerHTML = '';
            optsDiv.classList.remove('hidden');
            document.getElementById('dialog-click-hint').classList.add('hidden');
            quizData.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'quiz-btn';
                btn.innerText = opt.text;
                btn.onclick = (e) => { e.stopPropagation(); handleQuizAnswer(opt.correct); };
                optsDiv.appendChild(btn);
            });
        }

        function handleQuizAnswer(isCorrect) {
            const optsDiv = document.getElementById('dialog-options');
            optsDiv.classList.add('hidden');
            document.getElementById('dialog-click-hint').classList.remove('hidden');
            isQuizMode = false;
            if (isCorrect) {
                if (missionProgress === 3) { currentDialogQueue = ["Resposta Certa! Muito bem!", ...currentDialogQueue]; missionProgress = 4; updateHUD("Use o Computador da Miss√£o", "#ff00ff"); }
                if (missionProgress === 6) { currentDialogQueue = ["Maravilha! Fale com a agente Julia para obter mais informa√ß√µes.", ...currentDialogQueue]; missionProgress = 7; updateHUD("Fale com a agente J√∫lia para obter mais informa√ß√µes.", "#00ff88"); }
            } else {
                currentDialogQueue = ["Hmm, tudo bem, quando quiser, estarei aqui!"];
            }
            advanceDialog();
        }

        // --- JOGO DA SEQU√äNCIA (RESTAURADO) ---
        let gameSequence = [], playerSequence = [], isPlayingSequence = false;
        window.startSequenceGame = () => {
            document.getElementById('btn-start-seq').style.display = 'none';
            gameSequence = []; playerSequence = []; isPlayingSequence = false;
            document.getElementById('seq-status').innerText = "Observe a sequ√™ncia...";
            addToSequence();
        };

        function addToSequence() {
            gameSequence.push(Math.floor(Math.random() * 4));
            playSequence();
        }

        function playSequence() {
            isPlayingSequence = false; let i = 0;
            const interval = setInterval(() => {
                lightUpBtn(gameSequence[i]); i++;
                if (i >= gameSequence.length) {
                    clearInterval(interval);
                    setTimeout(() => {
                        isPlayingSequence = true; playerSequence = [];
                        document.getElementById('seq-status').innerText = "Sua vez! Repita.";
                    }, 300);
                }
            }, 500);
        }

        function lightUpBtn(id) {
            const btn = document.getElementById(`btn-${id}`);
            btn.classList.add('active');
            setTimeout(() => btn.classList.remove('active'), 400);
        }

        window.handleSeqInput = (id) => {
            if (!isPlayingSequence) return;
            lightUpBtn(id); playerSequence.push(id);
            if (playerSequence[playerSequence.length - 1] !== gameSequence[playerSequence.length - 1]) {
                document.getElementById('seq-status').innerText = "Ops! Errou. Tente de novo!";
                document.getElementById('seq-status').style.color = "#ff5555";
                setTimeout(() => {
                    document.getElementById('seq-status').style.color = "#fff";
                    window.startSequenceGame();
                }, 1500);
                return;
            }
            if (playerSequence.length === gameSequence.length) {
                if (gameSequence.length >= 3) { // Reduzi para 3 para n√£o ser t√£o longo
                    document.getElementById('seq-status').innerText = "PARAB√âNS! ACESSO LIBERADO!";
                    document.getElementById('seq-status').style.color = "#00ff88";
                    setTimeout(() => {
                        document.getElementById('pc-view-sequence').classList.add('hidden');
                        document.getElementById('pc-view-desktop').classList.remove('hidden');
                    }, 1500);
                } else {
                    document.getElementById('seq-status').innerText = "Muito bem! Pr√≥xima rodada...";
                    isPlayingSequence = false; setTimeout(addToSequence, 1000);
                }
            }
        };

        // --- UI GERAL ---
        window.openFaceLook = () => { document.getElementById('social-app-window').classList.remove('hidden'); };
        window.closeFaceLook = () => { document.getElementById('social-app-window').classList.add('hidden'); };

        window.checkPassword = () => {
            const pass = document.getElementById('pc-pass-input').value;
            const feedback = document.getElementById('pass-feedback');
            const ok = pass.length >= 8 && /[A-Z]/.test(pass) && /[0-9]/.test(pass) && /[!@#$%^&*]/.test(pass);
            if (ok) {
                feedback.style.color = "#00ff88"; feedback.innerText = "SENHA SEGURA!";
                setTimeout(() => {
                    document.getElementById('pc-view-login').classList.add('hidden');
                    document.getElementById('pc-view-sequence').classList.remove('hidden');
                    document.getElementById('btn-start-seq').style.display = 'block';
                }, 1500);
            } else {
                feedback.style.color = "#ff5555"; feedback.innerText = "Senha fraca! Use Letras, N√∫meros e S√≠mbolos.";
            }
        };

        window.applyCustomization = () => {
            const newName = document.getElementById('custom-name').value;
            if (newName) playerState.name = newName;
            playerState.backpackColor = parseInt(document.getElementById('custom-backpack-color').value.replace('#', ''), 16);
            playerState.hasHelmet = document.getElementById('custom-helmet-toggle').checked;
            playerState.helmetColor = parseInt(document.getElementById('custom-helmet-color').value.replace('#', ''), 16);
            playerState.hairStyle = uiSelectedHairStyleIndex;
            playerState.hairColor = parseInt(document.getElementById('custom-hair-color').value.replace('#', ''), 16);

            if (player && player.userData.parts) {
                if (player.userData.parts.backpack) player.userData.parts.backpack.material.color.setHex(playerState.backpackColor);
                if (player.userData.parts.helmet) {
                    player.userData.parts.helmet.visible = playerState.hasHelmet;
                    player.userData.parts.helmet.material.color.setHex(playerState.helmetColor);
                    if (player.userData.parts.hair) player.userData.parts.hair.visible = !playerState.hasHelmet;
                }
                const headGroup = player.userData.parts.head;
                if (player.userData.parts.hair) headGroup.remove(player.userData.parts.hair);
                const newHairMesh = createHair(playerState.hairStyle, playerState.hairColor);
                if (newHairMesh) {
                    newHairMesh.visible = !playerState.hasHelmet;
                    headGroup.add(newHairMesh);
                    player.userData.parts.hair = newHairMesh;
                }
            }
            startDialog("SISTEMA", ["Excelente, Agente " + playerState.name + "!", "Voc√™ atualizou sua identidade com sucesso!"]);
            if (missionProgress === 1) { missionProgress = 2; updateHUD("Pegue sua permiss√£o de uso do portal com a Agente J√∫lia", "#d500f9"); }
            closePC();
        };

        document.getElementById('custom-helmet-toggle').addEventListener('change', (e) => {
            const colorSection = document.getElementById('helmet-color-section');
            if (e.target.checked) colorSection.classList.remove('hidden');
            else colorSection.classList.add('hidden');
        });

        window.reportFakeNews = () => {
            alert("VOC√ä PEGOU O GOLPISTA! Bom trabalho!");
            closeFaceLook();
            closePC();
            startDialog("COMANDANTE", ["Excelente, Agente " + playerState.name + "!", "Voc√™ n√£o caiu no golpe do Robux Gr√°tis.", "Fale com o Rob√¥ Fair Play antes de sair."]);
            missionProgress = 5;
            updateHUD("Fale com o Rob√¥ Fair Play", "#00ff88");
        };

        window.closePC = () => { document.getElementById('computer-overlay').style.display = 'none'; };
        window.goToSelect = () => { document.getElementById('screen-menu').classList.add('hidden'); document.getElementById('screen-select').classList.remove('hidden'); };
        window.goToGuide = () => { document.getElementById('screen-menu').classList.add('hidden'); document.getElementById('screen-guide').classList.remove('hidden'); };
        window.goToCredits = () => { document.getElementById('screen-menu').classList.add('hidden'); document.getElementById('screen-credits').classList.remove('hidden'); };
        window.goToMenu = () => {
            document.getElementById('screen-credits').classList.add('hidden');
            document.getElementById('screen-guide').classList.add('hidden');
            document.getElementById('screen-select').classList.add('hidden');
            document.getElementById('screen-menu').classList.remove('hidden');
        };
        window.selectAgent = (id) => {
            selectedAgentId = id;
            document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('agent-' + id).classList.add('selected');
            const btn = document.getElementById('btn-start-game');
            btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; btn.style.background = '#ffd54f'; btn.style.color = '#000';
        };

        window.launchGame = () => {
            document.getElementById('screen-select').classList.add('hidden');
            playCutscene('intro');
        };

        function startGameWorld() {
            document.getElementById('game-container').style.visibility = 'visible';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('dialog-box').onclick = advanceDialog;
            initGame();
            showTutorial();
        }

        // --- THREE.JS ENGINE ---
        function initGame() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(CONFIG.colors.background);
            scene.fog = new THREE.FogExp2(CONFIG.colors.fog, 0.02);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 35, 40); camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('game-container').appendChild(renderer.domElement);

            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.2; bloomPass.strength = 1.2; bloomPass.radius = 0.5;
            composer = new EffectComposer(renderer); composer.addPass(renderScene); composer.addPass(bloomPass);

            const ambient = new THREE.AmbientLight(0xffffff, 0.3); scene.add(ambient);
            const lights = [[-10, 15, -10, 0x00eaff], [10, 15, 10, 0xff00ff]].forEach(l => {
                const light = new THREE.PointLight(l[3], 1, 40); light.position.set(l[0], l[1], l[2]); scene.add(light);
            });
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6); dirLight.position.set(0, 30, 15); dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048; scene.add(dirLight);

            clock = new THREE.Clock();
            createTextures();
            loadScene("LOBBY");
            createPlayer(selectedAgentId);
            setupInputs();
            animate();
        }

        function createTextures() {
            const createTex = (w, h, drawFn) => {
                const c = document.createElement('canvas'); c.width = w; c.height = h;
                const ctx = c.getContext('2d'); drawFn(ctx);
                const t = new THREE.CanvasTexture(c); t.magFilter = THREE.NearestFilter; t.wrapS = t.wrapT = THREE.RepeatWrapping;
                return t;
            };

            wallTextureBase = createTex(512, 512, (c) => {
                c.fillStyle = '#000033'; c.fillRect(0, 0, 512, 512); c.fillStyle = '#0066cc';
                const bw = 64, bh = 32, gt = 4;
                for (let y = 0; y < 512; y += bh + gt) {
                    const o = (Math.floor(y / (bh + gt)) % 2 === 0) ? 0 : bw / 2;
                    for (let x = -bw; x < 512; x += bw + gt) c.fillRect(x + o, y, bw, bh);
                }
            });
            wallTextureBase.repeat.set(2, 2);

            serverWallTexture = createTex(512, 512, (c) => {
                c.fillStyle = '#222233'; c.fillRect(0, 0, 512, 512);
                c.strokeStyle = '#444455'; c.lineWidth = 4; c.strokeRect(10, 10, 492, 492);
                for (let i = 0; i < 10; i++) { c.fillStyle = Math.random() > 0.5 ? '#00ff00' : '#ff0000'; c.fillRect(60 + Math.random() * 300, 60 + Math.random() * 300, 10, 5); }
                c.strokeStyle = '#00eaff'; c.lineWidth = 2; c.beginPath(); c.moveTo(0, 256); c.lineTo(512, 256); c.stroke();
            });

            floorTextureBase = createTex(512, 512, (c) => {
                c.fillStyle = '#0056b3'; c.fillRect(0, 0, 512, 512);
                c.fillStyle = '#4a90e2'; c.fillRect(0, 0, 256, 256); c.fillRect(256, 256, 256, 256);
            });
            floorTextureBase.repeat.set(4, 8);

            serverFloorTexture = createTex(512, 512, (c) => {
                c.fillStyle = '#111122'; c.fillRect(0, 0, 512, 512);
                c.strokeStyle = '#333344'; c.lineWidth = 4;
                for (let i = 0; i <= 512; i += 64) { c.beginPath(); c.moveTo(i, 0); c.lineTo(i, 512); c.stroke(); c.beginPath(); c.moveTo(0, i); c.lineTo(512, i); c.stroke(); }
                c.fillStyle = '#00eaff';
                for (let y = 0; y <= 512; y += 64) for (let x = 0; x <= 512; x += 64) { c.beginPath(); c.arc(x, y, 3, 0, Math.PI * 2); c.fill(); }
            });
            serverFloorTexture.repeat.set(4, 4);

            hologramTexture = createTex(256, 256, (c) => {
                c.clearRect(0, 0, 256, 256);
                const g = c.createRadialGradient(128, 128, 20, 128, 128, 120);
                g.addColorStop(0, 'rgba(0, 234, 255, 0.8)'); g.addColorStop(1, 'rgba(0, 234, 255, 0)');
                c.fillStyle = g; c.fillRect(0, 0, 256, 256);
                c.strokeStyle = '#00eaff'; c.lineWidth = 5;
                c.beginPath(); c.moveTo(128, 50); c.quadraticCurveTo(200, 50, 200, 128); c.quadraticCurveTo(200, 200, 128, 220);
                c.quadraticCurveTo(56, 200, 56, 128); c.quadraticCurveTo(56, 50, 128, 50); c.stroke();
            });

            strategicMapTexture = createTex(512, 256, (c) => {
                c.fillStyle = 'rgba(0, 10, 30, 0.8)'; c.fillRect(0, 0, 512, 256);
                c.strokeStyle = '#00eaff'; c.lineWidth = 2; c.beginPath();
                c.moveTo(50, 50); c.lineTo(150, 80); c.lineTo(200, 40); c.lineTo(350, 100); c.lineTo(450, 60);
                c.stroke();
            });

            carpetTexture = createTex(512, 512, (c) => {
                c.fillStyle = '#4a148c'; c.fillRect(0, 0, 512, 512);
                for (let i = 0; i < 1000; i++) { c.fillStyle = Math.random() > 0.5 ? '#6a1b9a' : '#38006b'; c.fillRect(Math.random() * 512, Math.random() * 512, 4, 4); }
            });

            arcadeMarqueeTexture = createTex(256, 64, (c) => {
                const g = c.createLinearGradient(0, 0, 256, 0); g.addColorStop(0, '#ff00ff'); g.addColorStop(1, '#00eaff');
                c.fillStyle = g; c.fillRect(0, 0, 256, 64);
                c.fillStyle = '#fff'; c.font = 'bold 30px "Press Start 2P"'; c.textAlign = 'center'; c.textBaseline = 'middle';
                c.fillText("ARCADE ZONE", 128, 32);
            });

            arcadeSideTexture = createTex(256, 512, (c) => {
                c.fillStyle = '#220033'; c.fillRect(0, 0, 256, 512);
                c.strokeStyle = '#00eaff'; c.lineWidth = 5;
                c.beginPath(); c.moveTo(20, 20); c.lineTo(236, 50); c.lineTo(100, 400); c.stroke();
                c.fillStyle = '#ff00ff'; c.beginPath(); c.arc(128, 256, 50, 0, Math.PI * 2); c.fill();
            });


            // NOVA FUN√á√ÉO PARA POSTERS
            window.createPosterTexture = (title, text, bgColor) => {
                return createTex(512, 512, (c) => {
                    c.fillStyle = bgColor || '#111'; c.fillRect(0, 0, 512, 512);
                    c.strokeStyle = '#ffffff'; c.lineWidth = 10; c.strokeRect(20, 20, 472, 472);
                    c.fillStyle = '#ffffff';
                    c.font = 'bold 60px Arial'; c.textAlign = 'center'; c.fillText(title, 256, 100);
                    c.font = '30px Arial';
                    const lines = text.split('\n');
                    for (let i = 0; i < lines.length; i++) {
                        c.fillText(lines[i], 256, 180 + (i * 40));
                    }
                });
            };

            // Cria√ß√£o das novas texturas de poster
            posterRulesTexture = window.createPosterTexture("REGRAS DO JOGO", "1. Respeito sempre!\n2. N√£o xingue.\n3. Jogue limpo.\n4. Divirta-se!", "#0000ff");
            posterDownloadsTexture = window.createPosterTexture("PERIGO: DOWNLOADS", "N√£o baixe arquivos\nde estranhos.\nPodem conter v√≠rus!", "#ff0000");
            posterChatTexture = window.createPosterTexture("CHAT SEGURO", "Nunca passe:\n- Endere√ßo\n- Telefone\n- Senha\npara ningu√©m!", "#00ff00");

            // Textura de poster antiga (mantida por compatibilidade, mas n√£o usada)
            posterTexture = createTex(256, 256, (c) => {
                c.fillStyle = '#111'; c.fillRect(0, 0, 256, 256);
                c.strokeStyle = '#ffff00'; c.lineWidth = 10; c.strokeRect(10, 10, 236, 236);
                c.fillStyle = '#ffff00'; c.font = 'bold 150px Arial'; c.textAlign = 'center'; c.textBaseline = 'middle'; c.fillText('!', 128, 128);
            });

            window.createScreenTexture = (text) => {
                return createTex(512, 256, (c) => {
                    c.fillStyle = '#000'; c.fillRect(0, 0, 512, 256);
                    c.strokeStyle = '#00eaff'; c.lineWidth = 5; c.strokeRect(0, 0, 512, 256);
                    c.fillStyle = '#00eaff'; c.font = 'bold 30px Arial'; c.textAlign = 'center'; c.fillText("DICA DE SEGURAN√áA:", 256, 50);
                    c.fillStyle = '#fff'; c.font = '26px Arial'; c.fillText(text, 256, 100);
                });
            };
            screenTexture = window.createScreenTexture("NUNCA COMPARTILHE SUA SENHA!");
        }

        function clearLevel() {
            levelObjects.forEach(obj => scene.remove(obj));
            markers.forEach(m => scene.remove(m));
            // Limpa o array de paredes para transpar√™ncia
            wallMeshes = [];
            drones = []; mazeDoors = []; // Limpa labirinto
            levelObjects = []; obstacles = []; interactables = []; floors = []; markers = [];
        }

        function loadScene(sceneName) {
            document.getElementById('transition-screen').style.display = 'flex';
            setTimeout(() => {
                clearLevel(); currentLevel = sceneName;
                if (sceneName === "LOBBY") createLobbyLevel();
                else if (sceneName === "CYBER_OPS") createRoomLevel();
                else if (sceneName === "MAZE_LEVEL") createMazeLevel();
                document.getElementById('transition-screen').style.display = 'none';
                isTransitioning = false;
                updateMarkers(); // FIX: Update markers after scene load
            }, 500);
        }

        // --- LEVELS ---
        function createLobbyLevel() {
            createFloor(0, 0, 16, 30, floorTextureBase);
            createFloor(-16, -1.5, 16, 30, carpetTexture);
            createFloor(16, -1.5, 16, 30, carpetTexture);

            // Paredes Externas (Altura 8, Espessura alterada para 1)
            createWall(0, 3, -15, 48, 8, 1); // Fundo
            createWall(0, 3, 15, 48, 8, 1); // Frente
            createWall(-24, 3, 0, 1, 8, 30); // Esquerda
            createWall(24, 3, -9, 1, 8, 12); createWall(24, 3, 9, 1, 8, 12); // Direita (partes da janela)
            createWall(24, 0, 0, 1, 2, 6); createWall(24, 5.5, 0, 1, 3, 6);
            createWindow(24, 2.5, 0, 3, 6);

            // Paredes Internas (Altura 5, Espessura 0.5)
            createWall(-8, 1, 9, 0.5, 5, 12); createWall(-8, 1, -9, 0.5, 5, 12);
            createWall(8, 1, 9, 0.5, 5, 12); createWall(8, 1, -9, 0.5, 5, 12);

            // Escadas (Alargadas para 8 e ajustadas)
            // FIX: Ajuste de yStart para -1.52 para evitar Z-fighting no topo
            createStairs(-10, -1.52, 0, 0.8, 1.5, 8, 5, "left");
            createStairs(10, -1.52, 0, 0.8, 1.5, 8, 5, "right");

            // --- DECORA√á√ÉO EXTRA (ENRICHED LOBBY) ---

            // 1. "LAN HOUSE" SEGURA
            const lanTable = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 10), new THREE.MeshStandardMaterial({ color: 0x556677 }));
            lanTable.position.set(-20, -0.75, 8);
            scene.add(lanTable); levelObjects.push(lanTable); addCollisionBox(-20, -0.75, 8, 2, 1.5, 10);

            for (let i = 0; i < 3; i++) {
                const z = 5 + (i * 3);
                createPropComputer(-20, 0, z, Math.PI / 2);
                createChair(-18.5, -1.5, z, -Math.PI / 2);
            }

            // 2. QUADROS DE AVISO / POSTERS (CORRIGIDOS)
            // Movidos para a parede da frente (Z=14.4) e rotacionados 180 graus (Math.PI)
            createPoster(-10, 4, 14.4, Math.PI, "REGRAS DO JOGO", "1. Respeito sempre!\n2. N√£o xingue.\n3. Jogue limpo.\n4. Divirta-se!", "#0000ff");
            createPoster(0, 4, 14.4, Math.PI, "PERIGO: DOWNLOADS", "N√£o baixe arquivos\nde estranhos.\nPodem conter v√≠rus!", "#ff0000");
            createPoster(10, 4, 14.4, Math.PI, "CHAT SEGURO", "Nunca passe:\n- Endere√ßo\n- Telefone\n- Senha\npara ningu√©m!", "#00ff00");

            // 3. PLANTAS SCI-FI
            createSciFiPlant(-22, -1.5, -13);
            createSciFiPlant(22, -1.5, -13);
            createSciFiPlant(22, -1.5, 13);
            createSciFiPlant(-22, -1.5, 13);

            // 4. BANCOS CENTRAIS
            createBench(0, 0, 5, 0);
            createBench(0, 0, -5, Math.PI);

            // --- FIM DA DECORA√á√ÉO EXTRA ---

            const globe = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 32), new THREE.MeshBasicMaterial({ map: hologramTexture, transparent: true, opacity: 0.8, side: THREE.DoubleSide, blending: THREE.AdditiveBlending }));
            globe.position.set(0, 2.5, 0); scene.add(globe); levelObjects.push(globe);
            const animGlobe = () => { if (globe) { globe.rotation.y += 0.01; requestAnimationFrame(animGlobe); } }; animGlobe();

            // Terminal de Personaliza√ß√£o
            const pcHit = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), new THREE.MeshBasicMaterial({ visible: false }));
            pcHit.position.set(0, 1, 0); pcHit.userData = { isInteractable: true, type: "PC_CUSTOM", name: "Personaliza√ß√£o" };
            scene.add(pcHit); levelObjects.push(pcHit); interactables.push(pcHit);

            const totem = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1, 8), new THREE.MeshStandardMaterial({ color: 0x333 }));
            totem.position.set(0, 0.5, 0); scene.add(totem); levelObjects.push(totem);

            // Portal logic: Updates based on mission
            const portalTarget = (missionProgress >= 8) ? "MAZE_LEVEL" : "CYBER_OPS";
            createPortalDoor(0, 0, -13.8, portalTarget, 0);

            // CAPIT√ÉO NA SALA DA LAN HOUSE (CORRIGIDO)
            createTable(-18, -0.75, -10, 0, 6, 3, false);
            // Afastado o capit√£o e a cadeira para Z = -12.5
            createChair(-18, -0.75, -12.5, 0);
            createNPC(-18, -0.75, -12.5, CONFIG.colors.commander, "Comandante Motta", null, 1, 0xaaaaaa, 0);

            createNPC(16, -1.5, 0, CONFIG.colors.npc, "Agente J√∫lia", null, 3, 0xff4400, -Math.PI / 2);
            createNPC(-22, -1.5, 5, 0xffff00, "Agente Firewall", ["Fique esperto: N√£o aceite arquivos de estranhos!", "Se algu√©m te pedir fotos, saia correndo e avise seus pais!"], 2, 0x222222, Math.PI / 2);
            createNPC(20, -1.5, -5, 0x00ff00, "Agente Guardi√£o", ["O respeito √© a regra #1 do jogo.", "Se algu√©m for malvado com voc√™, bloqueie e denuncie!"], 1, 0x3333ff, -Math.PI / 2);
            createNPC(-2, 0, 2, CONFIG.colors.npc, "Agente Info", ["Ol√°! A plataforma central √© segura.", "Use as escadas laterais para acessar as √°reas de treinamento."], 2, 0x555555, Math.PI / 4);

            // Novo NPC "Agente Pixel" pr√≥ximo ao arcade
            // Moved from 15, 8 to 12, 6 to give space
            createNPC(12, -1.5, 6, 0x00ffff, "Agente Pixel", ["Ei! Quer bater meu recorde no Arcade?", "Lembre-se: Jogos s√£o para divers√£o, n√£o para bullying."], 1, 0xff00ff, -Math.PI / 2);

            // MAPA HOLOGR√ÅFICO (CORRIGIDO: PLANO)
            const holoMap = new THREE.Mesh(new THREE.PlaneGeometry(5.8, 2.8), new THREE.MeshBasicMaterial({ map: strategicMapTexture, transparent: true, opacity: 0.8, side: THREE.DoubleSide, blending: THREE.AdditiveBlending }));
            holoMap.rotation.x = -Math.PI / 2;
            // holoMap.rotation.z = Math.PI / 2; // <--- REMOVE THIS to fix rotation
            holoMap.position.set(-18, 1.05, -10); // Altura 1.05
            scene.add(holoMap); levelObjects.push(holoMap);

            // ARCADE MACHINE "FUN"
            createFunArcade(18, -1.5, 10, -Math.PI / 2);

            // TELA DE DICA (CORRIGIDA: Rota√ß√£o 0 para ficar de frente)
            createScreen(-12, 5, -14.5, 0, window.createScreenTexture("DICA: Use senhas fortes!"));

            if (player) player.position.set(0, 0, 10);
        }

        function createRoomLevel() {
            createFloor(0, 0, 30, 20, serverFloorTexture);
            createWall(0, 4, -10, 30, 8, 2, serverWallTexture);
            createWall(0, 4, 10, 30, 8, 1, serverWallTexture);
            createWall(15, 4, 0, 1, 8, 20, serverWallTexture);
            createWall(-15, 4, 0, 1, 8, 20, serverWallTexture);

            createPortalDoor(-13.8, 0, 0, "LOBBY", Math.PI / 2);

            createServerRack(5, -8, 0); createServerRack(10, -8, 0);
            createServerRack(5, 8, Math.PI); createServerRack(10, 8, Math.PI);

            const desk = new THREE.Mesh(new THREE.BoxGeometry(6, 1.5, 3), new THREE.MeshStandardMaterial({ color: 0x556677 }));
            desk.position.set(10, 0.75, 0); scene.add(desk); levelObjects.push(desk); addCollisionBox(10, 0.75, 0, 6, 1.5, 3);

            const pcScreen = new THREE.Mesh(new THREE.BoxGeometry(2, 1.5, 0.2), new THREE.MeshStandardMaterial({ color: 0x111 }));
            pcScreen.position.set(10, 2.0, 0);
            scene.add(pcScreen); levelObjects.push(pcScreen);
            const pcDisplay = new THREE.Mesh(new THREE.PlaneGeometry(1.8, 1.3), new THREE.MeshBasicMaterial({ color: 0x00ff00, emissive: 0x00ff00, emissiveIntensity: 0.5 }));
            pcDisplay.position.set(10, 2.0, -0.11); pcDisplay.rotation.y = Math.PI;
            scene.add(pcDisplay); levelObjects.push(pcDisplay);

            const pcHit = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), new THREE.MeshBasicMaterial({ visible: false }));
            pcHit.position.set(10, 1.5, 0); pcHit.userData = { isInteractable: true, type: "PC_MISSION", name: "Terminal de Miss√£o" };
            scene.add(pcHit); levelObjects.push(pcHit); interactables.push(pcHit);

            createNPC(6, 0, 0, 0xff0055, "Capit√£ Dados", null, 3, 0x000000, -Math.PI / 2);
            createNPC(0, 0, -5, 0x0000ff, "Rob√¥ Fair Play", null, 0, CONFIG.colors.defaultHair, Math.PI);

            if (player) { player.position.set(-8, 0, 0); player.rotation.y = -Math.PI / 2; }
        }

        // --- NOVO N√çVEL: LABIRINTO (COMPLEXO DE SALAS) ---
        function createMazeLevel() {
            // Ch√£o maior
            createFloor(0, 0, 60, 80, serverFloorTexture);

            // PAREDES EXTERNAS GERAIS
            createWall(0, 4, 40, 60, 8, 1, serverWallTexture); // Fundo
            createWall(0, 4, -40, 60, 8, 1, serverWallTexture); // Frente
            createWall(-30, 4, 0, 1, 8, 80, serverWallTexture); // Esquerda
            createWall(30, 4, 0, 1, 8, 80, serverWallTexture); // Direita

            // --- SALA 1: ENTRADA (Z=20 a Z=40) ---
            // Paredes divis√≥rias
            createWall(-10, 4, 20, 20, 8, 1, serverWallTexture); // Parede frente esquerda
            createWall(10, 4, 20, 20, 8, 1, serverWallTexture); // Parede frente direita
            // (gap no meio para corredor)

            // --- CORREDOR 1 (Z=0 a Z=20) ---
            createWall(-5, 4, 10, 1, 8, 20, serverWallTexture);
            createWall(5, 4, 10, 1, 8, 20, serverWallTexture);

            // PORTA PUZZLE 1 (Bloqueando o corredor em Z=10)
            createPuzzleDoor(0, 2, 10, 'math', 1);

            // --- SALA 2: SERVIDORES (Z=-20 a Z=0) ---
            // Paredes laterais da sala central
            createWall(-20, 4, -10, 1, 8, 20, serverWallTexture);
            createWall(20, 4, -10, 1, 8, 20, serverWallTexture);

            // Obst√°culos internos (Servidores) para se esconder
            createServerRack(-10, -10, 0);
            createServerRack(10, -10, 0);
            createServerRack(-10, -5, 0);
            createServerRack(10, -5, 0);

            // Drones patrulhando a Sala 2
            createDrone(-15, -10, [{ x: -15, z: -5 }, { x: -15, z: -15 }, { x: 0, z: -15 }, { x: 0, z: -5 }]);
            createDrone(15, -10, [{ x: 15, z: -15 }, { x: 15, z: -5 }, { x: 0, z: -5 }, { x: 0, z: -15 }]);

            // PORTA PUZZLE 2 (Sa√≠da da Sala 2 em Z=-20)
            createWall(-10, 4, -20, 20, 8, 1, serverWallTexture);
            createWall(10, 4, -20, 20, 8, 1, serverWallTexture);
            createPuzzleDoor(0, 2, -20, 'quiz', 2);

            // --- SALA 3: N√öCLEO FINAL (Z=-40 a Z=-20) ---
            // Drones finais
            createDrone(0, -30, [{ x: -20, z: -30 }, { x: 20, z: -30 }]); // Patrulha horizontal r√°pida

            // Objetivo Final
            const finish = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshStandardMaterial({ color: 0x00ff00, emissive: 0x00ff00 }));
            finish.position.set(0, 1, -35);
            finish.userData = { isInteractable: true, name: "Final do Labirinto", dialogs: ["Parab√©ns! Voc√™ completou o desafio final!"] };
            scene.add(finish); levelObjects.push(finish); interactables.push(finish);

            // Player start
            if (player) { player.position.set(0, 0, 35); player.rotation.y = Math.PI; }
        }

        function createDrone(x, z, path) {
            const g = new THREE.Group();
            const body = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
            g.add(body);
            const eye = new THREE.Mesh(new THREE.SphereGeometry(0.2), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
            eye.position.set(0, 0, 0.4); g.add(eye);

            g.position.set(x, 2, z);
            g.userData.path = path;
            g.userData.pathIndex = 0;
            g.userData.speed = 4; // Drones mais r√°pidos

            scene.add(g); drones.push(g); levelObjects.push(g);
        }

        function createPuzzleDoor(x, y, z, type, id) {
            const g = new THREE.Group();
            const door = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 0.5), new THREE.MeshStandardMaterial({ color: 0xff3333, transparent: true, opacity: 0.7 }));
            g.add(door);
            g.position.set(x, y, z);

            // Hitbox for interaction
            const hitBox = new THREE.Mesh(new THREE.BoxGeometry(5, 6, 2), new THREE.MeshBasicMaterial({ visible: false }));
            hitBox.userData = { isInteractable: true, type: "ARCADE", name: "Porta de Seguran√ßa" }; // Reusing ARCADE type triggers puzzle logic
            g.add(hitBox);

            scene.add(g); mazeDoors.push(g); levelObjects.push(g); interactables.push(hitBox);
            // Store current door to remove on success
            hitBox.onInteract = () => { window.currentDoor = g; };

            addCollisionBox(x, y, z, 4, 6, 0.5);
        }

        // --- NOVA FUN√á√ÉO DE ESCADAS (CORRIGIDA) ---
        function createStairs(x, yStart, z, treadLen, heightDiff, stairWidth, steps, direction) {
            const stepHeight = heightDiff / steps;

            for (let i = 0; i < steps; i++) {
                const mesh = new THREE.Mesh(
                    new THREE.BoxGeometry(treadLen, stepHeight, stairWidth),
                    new THREE.MeshStandardMaterial({ map: floorTextureBase })
                );

                const xPos = direction === "left" ? x + (i * treadLen) : x - (i * treadLen);
                const yPos = yStart + (i * stepHeight) + (stepHeight / 2);

                mesh.position.set(xPos, yPos, z);
                scene.add(mesh); levelObjects.push(mesh); floors.push(mesh);
            }
        }

        // --- OBJETOS DECORATIVOS NOVOS ---
        function createPropComputer(x, y, z, rot) {
            const g = new THREE.Group();
            const mon = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 0.1), new THREE.MeshStandardMaterial({ color: 0x222 }));
            mon.position.set(0, 0.5, 0); g.add(mon);
            const screen = new THREE.Mesh(new THREE.PlaneGeometry(1.4, 0.9), new THREE.MeshBasicMaterial({ color: 0x00eaff }));
            screen.position.set(0, 0.5, 0.06); g.add(screen);
            const base = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.1, 0.5), new THREE.MeshStandardMaterial({ color: 0x111 }));
            base.position.set(0, 0, 0); g.add(base);
            const kb = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.05, 0.6), new THREE.MeshStandardMaterial({ color: 0x111 }));
            kb.position.set(0, 0, 0.5); kb.rotation.x = 0.1; g.add(kb);
            g.position.set(x, y, z); g.rotation.y = rot;
            scene.add(g); levelObjects.push(g);
        }

        // Fun√ß√£o de Poster Atualizada (CORRIGIDA: Removido flip para consertar orienta√ß√£o)
        function createPoster(x, y, z, rot, title, text, color) {
            const frame = new THREE.Mesh(new THREE.BoxGeometry(3, 4, 0.1), new THREE.MeshStandardMaterial({ color: 0x111 }));

            let texture = posterTexture;
            if (title === "REGRAS DO JOGO") texture = posterRulesTexture;
            else if (title === "PERIGO: DOWNLOADS") texture = posterDownloadsTexture;
            else if (title === "CHAT SEGURO") texture = posterChatTexture;

            // FIX: Removido o espelhamento que estava deixando de cabe√ßa para baixo
            // texture.repeat.set(-1, 1); 
            // texture.center.set(0.5, 0.5);

            const paper = new THREE.Mesh(new THREE.PlaneGeometry(2.8, 3.8), new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide }));
            paper.position.z = 0.06;
            const g = new THREE.Group(); g.add(frame); g.add(paper);
            g.position.set(x, y, z);
            g.rotation.y = rot; // Adicionada rota√ß√£o
            scene.add(g); levelObjects.push(g);
        }

        function createSciFiPlant(x, y, z) {
            const g = new THREE.Group();
            const pot = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.3, 0.8, 6), new THREE.MeshStandardMaterial({ color: 0x444 }));
            pot.position.y = 0.4; g.add(pot);
            const geo = new THREE.ConeGeometry(0.2, 1.5, 4);
            const mat = new THREE.MeshBasicMaterial({ color: 0x00ff88, transparent: true, opacity: 0.5, wireframe: true });
            for (let i = 0; i < 5; i++) {
                const leaf = new THREE.Mesh(geo, mat); leaf.position.y = 1; leaf.rotation.z = 0.5; leaf.rotation.y = (i / 5) * Math.PI * 2; g.add(leaf);
            }
            g.position.set(x, y, z); scene.add(g); levelObjects.push(g);
        }

        // NOVA FUN√á√ÉO: Criar Banco
        function createBench(x, y, z, rot) {
            const g = new THREE.Group();
            const seat = new THREE.Mesh(new THREE.BoxGeometry(3, 0.2, 1), new THREE.MeshStandardMaterial({ color: 0x333 })); seat.position.y = 0.6; g.add(seat);
            const leg1 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.6, 0.8), new THREE.MeshStandardMaterial({ color: 0x222 })); leg1.position.set(-1.3, 0.3, 0); g.add(leg1);
            const leg2 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.6, 0.8), new THREE.MeshStandardMaterial({ color: 0x222 })); leg2.position.set(1.3, 0.3, 0); g.add(leg2);
            g.position.set(x, y, z); g.rotation.y = rot; scene.add(g); levelObjects.push(g); addCollisionBox(x, y, z, 3, 0.6, 1);
        }

        // --- OBJETOS 3D EXISTENTES ---

        // PORTAL REVERTIDO (SIMPLES E CL√ÅSSICO)
        function createPortalDoor(x, y, z, target, rot) {
            const g = new THREE.Group(); g.position.set(x, y, z); g.rotation.y = rot;
            const frame = new THREE.Mesh(new THREE.TorusGeometry(3.5, 0.2, 16, 50), new THREE.MeshStandardMaterial({ color: 0x222, emissive: 0x00eaff, emissiveIntensity: 0.2 })); frame.position.y = 3; g.add(frame);

            // Anel 1 (Original - Azul)
            const energyRing1 = new THREE.Mesh(new THREE.TorusGeometry(3.0, 0.1, 16, 50), new THREE.MeshBasicMaterial({ color: 0x00eaff, transparent: true, opacity: 0.6 })); energyRing1.position.y = 3; g.add(energyRing1);
            // Anel 2 (Original - Rosa)
            const energyRing2 = new THREE.Mesh(new THREE.TorusGeometry(2.5, 0.05, 16, 50), new THREE.MeshBasicMaterial({ color: 0xff00ff, transparent: true, opacity: 0.6 })); energyRing2.position.y = 3; energyRing2.rotation.x = Math.PI / 4; g.add(energyRing2);

            const particlesGeo = new THREE.BufferGeometry(); const particlesCount = 50; const posArray = new Float32Array(particlesCount * 3);
            for (let i = 0; i < particlesCount * 3; i++) { posArray[i] = (Math.random() - 0.5) * 4; }
            particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
            const particles = new THREE.Points(particlesGeo, new THREE.PointsMaterial({ size: 0.1, color: 0x00eaff, transparent: true, opacity: 0.8 })); particles.position.y = 3; g.add(particles);

            // Anima√ß√£o original
            g.userData.animate = () => {
                energyRing1.rotation.z -= 0.02;
                energyRing2.rotation.z += 0.03; energyRing2.rotation.x += 0.01;
                particles.rotation.y += 0.01;
            };

            const hitBox = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 4), new THREE.MeshBasicMaterial({ visible: false })); hitBox.position.set(0, 3, 0);
            // Adicionando nome do Portal para a fun√ß√£o updateMarkers
            hitBox.userData = { isInteractable: true, type: "DOOR", target: target, name: "Portal" };
            g.add(hitBox);

            scene.add(g); levelObjects.push(g); interactables.push(hitBox);
        }

        function createFloor(x, y, w, h, tex) {
            const m = new THREE.Mesh(new THREE.PlaneGeometry(w, h), new THREE.MeshStandardMaterial({ map: tex, roughness: 0.5 }));
            m.rotation.x = -Math.PI / 2; m.position.set(x, y, 0); m.receiveShadow = true;
            scene.add(m); levelObjects.push(m); floors.push(m);
        }

        function createWall(x, y, z, w, h, d, texture) {
            // FIX TEXTURA ESTICADA: Calcular repeti√ß√£o baseada na MAIOR dimens√£o (width ou depth)
            const tex = texture ? texture.clone() : wallTextureBase.clone();
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            // Usa Math.max para pegar a dimens√£o dominante da parede
            const maxDim = Math.max(w, d);
            tex.repeat.set(maxDim / 8, h / 8);

            // FIX TRANSPAR√äNCIA: Habilitar transpar√™ncia no material
            const mat = new THREE.MeshStandardMaterial({ map: tex, transparent: true, opacity: 1.0 });

            const m = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
            m.position.set(x, y, z); m.castShadow = true; m.receiveShadow = true;

            scene.add(m); levelObjects.push(m); wallMeshes.push(m); // Adiciona √† lista de paredes para raio-x
            addCollisionBox(x, y, z, w, h, d);
        }

        function createWindow(x, y, z, h, d) {
            const g = new THREE.Group();
            const frameMat = new THREE.MeshStandardMaterial({ color: 0x333 });
            const fThickness = 1.2, fWidth = 0.2;
            const fTop = new THREE.Mesh(new THREE.BoxGeometry(fThickness, fWidth, d), frameMat); fTop.position.y = h / 2;
            const fBot = new THREE.Mesh(new THREE.BoxGeometry(fThickness, fWidth, d), frameMat); fBot.position.y = -h / 2;
            const fLeft = new THREE.Mesh(new THREE.BoxGeometry(fThickness, h, fWidth), frameMat); fLeft.position.z = -d / 2;
            const fRight = new THREE.Mesh(new THREE.BoxGeometry(fThickness, h, fWidth), frameMat); fRight.position.z = d / 2;
            g.add(fTop, fBot, fLeft, fRight);
            const glass = new THREE.Mesh(new THREE.PlaneGeometry(d - fWidth, h - fWidth), new THREE.MeshPhysicalMaterial({ color: 0x88ccff, transparent: true, opacity: 0.3, roughness: 0, metalness: 0.9, side: THREE.DoubleSide }));
            glass.rotation.y = Math.PI / 2; g.add(glass);
            g.position.set(x, y, z); scene.add(g); levelObjects.push(g); addCollisionBox(x, y, z, 1, h, d);
        }

        function createScreen(x, y, z, rot, texture) {
            const g = new THREE.Group();
            const frame = new THREE.Mesh(new THREE.BoxGeometry(6.2, 3.2, 0.2), new THREE.MeshStandardMaterial({ color: 0x111 })); g.add(frame);
            const screen = new THREE.Mesh(new THREE.PlaneGeometry(6, 3), new THREE.MeshBasicMaterial({ map: texture || screenTexture, side: THREE.DoubleSide })); screen.position.z = 0.11; g.add(screen);
            g.position.set(x, y, z); g.rotation.y = rot; scene.add(g); levelObjects.push(g);
        }

        // FUN√á√ÉO FLIPERAMA 2.0 (MAIS DIVERTIDO E COLORIDO)
        function createFunArcade(x, y, z, rot) {
            const g = new THREE.Group();

            // Gabinete Principal (Roxo Neon)
            const cabinetMat = new THREE.MeshStandardMaterial({ color: 0x9900ff, roughness: 0.3, metalness: 0.5 });
            const sideMat = new THREE.MeshBasicMaterial({ map: arcadeSideTexture });

            const body = new THREE.Mesh(new THREE.BoxGeometry(2.4, 4, 2.2), cabinetMat);
            body.position.y = 2;

            // Pain√©is Laterais com Arte (Simulado)
            const sideL = new THREE.Mesh(new THREE.PlaneGeometry(2.2, 4), sideMat);
            sideL.position.set(-1.21, 2, 0); sideL.rotation.y = -Math.PI / 2;
            const sideR = new THREE.Mesh(new THREE.PlaneGeometry(2.2, 4), sideMat);
            sideR.position.set(1.21, 2, 0); sideR.rotation.y = Math.PI / 2;

            // Tela Inclinada
            const screenCase = new THREE.Mesh(new THREE.BoxGeometry(2.0, 1.8, 0.5), new THREE.MeshStandardMaterial({ color: 0x222 }));
            screenCase.position.set(0, 3.0, 0.6);
            screenCase.rotation.x = -0.4;

            // Tela Brilhante com Anima√ß√£o de Pixel (Simples cor mudando)
            const screenMat = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            const screen = new THREE.Mesh(new THREE.PlaneGeometry(1.8, 1.5), screenMat);
            screen.position.set(0, 0, 0.26);
            screenCase.add(screen);

            // Anima√ß√£o da Tela
            g.userData.animate = () => {
                const time = Date.now() * 0.005;
                const hue = (Math.sin(time) + 1) / 2;
                screenMat.color.setHSL(hue, 1.0, 0.5);
            };

            // Marquise Luminosa (Topo)
            const marquee = new THREE.Mesh(new THREE.BoxGeometry(2.4, 0.8, 2.4), new THREE.MeshBasicMaterial({ map: arcadeMarqueeTexture }));
            marquee.position.y = 4.4;

            // Mesa de Controle
            const controlPanel = new THREE.Mesh(new THREE.BoxGeometry(2.4, 0.3, 1.2), new THREE.MeshStandardMaterial({ color: 0x00eaff }));
            controlPanel.position.set(0, 2.0, 1.1);
            controlPanel.rotation.x = 0.2;

            // Joysticks
            const joyStick1 = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshStandardMaterial({ color: 0xff0000 }));
            joyStick1.position.set(-0.6, 2.3, 1.0);
            const joyStick2 = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshStandardMaterial({ color: 0xffff00 }));
            joyStick2.position.set(0.6, 2.3, 1.0);

            // Luz Ambiente do Arcade
            const arcadeLight = new THREE.PointLight(0x00eaff, 2, 5);
            arcadeLight.position.set(0, 3, 2);

            g.add(body, sideL, sideR, screenCase, marquee, controlPanel, joyStick1, joyStick2, arcadeLight);

            g.position.set(x, y, z); g.rotation.y = rot;

            // Hitbox
            const hitBox = new THREE.Mesh(new THREE.BoxGeometry(2.8, 5, 2.8), new THREE.MeshBasicMaterial({ visible: false }));
            hitBox.position.y = 2.5;
            hitBox.userData = { isInteractable: true, type: "ARCADE", name: "Fliperama" };
            g.add(hitBox);

            scene.add(g); levelObjects.push(g); interactables.push(hitBox); addCollisionBox(x, y, z, 2.4, 4, 2.4);
        }

        // ROBOT CREATION
        function createRobot(color) {
            const c = new THREE.Group(); c.scale.set(1.4, 1.4, 1.4);
            const metalMat = new THREE.MeshStandardMaterial({ color: 0x888888, roughness: 0.4, metalness: 0.8 });
            const armorMat = new THREE.MeshStandardMaterial({ color: color, emissive: color, emissiveIntensity: 0.4, metalness: 0.6 });

            const body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.6, 0.35), armorMat);
            body.position.y = 1.0; c.add(body);

            const headG = new THREE.Group(); headG.position.y = 1.65;
            const headGeo = new THREE.BoxGeometry(0.4, 0.4, 0.4);
            headG.add(new THREE.Mesh(headGeo, metalMat));
            const visor = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.1, 0.1), new THREE.MeshBasicMaterial({ color: 0x00ff00 }));
            visor.position.set(0, 0.05, 0.21); headG.add(visor);
            const antL = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.3), metalMat); antL.position.set(0.15, 0.35, 0); headG.add(antL);
            const antR = new THREE.Mesh(new THREE.CylinderGeometry(0.02, 0.02, 0.3), metalMat); antR.position.set(-0.15, 0.35, 0); headG.add(antR);
            c.add(headG);

            const limbG = new THREE.BoxGeometry(0.12, 0.6, 0.12);
            const lArm = new THREE.Mesh(limbG, metalMat); lArm.position.set(0.35, 1.0, 0); c.add(lArm);
            const rArm = new THREE.Mesh(limbG, metalMat); rArm.position.set(-0.35, 1.0, 0); c.add(rArm);
            const legG = new THREE.BoxGeometry(0.15, 0.7, 0.15);
            const lLeg = new THREE.Mesh(legG, armorMat); lLeg.position.set(0.15, 0.35, 0); c.add(lLeg);
            const rLeg = new THREE.Mesh(legG, armorMat); rLeg.position.set(-0.15, 0.35, 0); c.add(rLeg);
            const pack = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.4, 0.15), new THREE.MeshStandardMaterial({ color: 0x333 }));
            pack.position.set(0, 1.0, -0.25); c.add(pack);

            c.userData.parts = { body, head: headG, leftArm: lArm, rightArm: rArm, leftLeg: lLeg, rightLeg: rLeg, backpack: pack };
            return c;
        }

        function createServerRack(x, z, rot) {
            const g = new THREE.Group();
            const rack = new THREE.Mesh(new THREE.BoxGeometry(3, 6, 2), new THREE.MeshStandardMaterial({ color: 0x111 })); rack.position.y = 3; g.add(rack);
            for (let i = 0; i < 5; i++) { const l = new THREE.Mesh(new THREE.PlaneGeometry(2.5, 0.2), new THREE.MeshBasicMaterial({ color: 0x00ff00 })); l.position.set(0, 1 + i, 1.01); g.add(l); }
            g.position.set(x, 0, z); g.rotation.y = rot; scene.add(g); levelObjects.push(g); addCollisionBox(x, 0, z, 3, 6, 2);
        }

        function createTable(x, y, z, rot, width, depth, addChairs = false) {
            const g = new THREE.Group();
            const top = new THREE.Mesh(new THREE.BoxGeometry(width, 0.2, depth), new THREE.MeshStandardMaterial({ color: 0x556677 })); top.position.y = 1.5; g.add(top);
            const leg1 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.5, depth - 0.5), new THREE.MeshStandardMaterial({ color: 0x555 })); leg1.position.set(-(width / 2 - 0.2), 0.75, 0); g.add(leg1);
            const leg2 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.5, depth - 0.5), new THREE.MeshStandardMaterial({ color: 0x555 })); leg2.position.set(width / 2 - 0.2, 0.75, 0); g.add(leg2);
            g.position.set(x, y, z); g.rotation.y = rot; scene.add(g); levelObjects.push(g); addCollisionBox(x, y, z, width, 1.5, depth);
        }

        function createChair(x, y, z, rot) {
            const g = new THREE.Group();
            const seat = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.2, 1.2), new THREE.MeshStandardMaterial({ color: 0x333 })); seat.position.y = 1; g.add(seat);
            const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1), new THREE.MeshStandardMaterial({ color: 0x888 })); leg.position.y = 0.5; g.add(leg);
            const base = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.1), new THREE.MeshStandardMaterial({ color: 0x888 })); base.position.y = 0.05; g.add(base);
            const back = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.5, 0.2), new THREE.MeshStandardMaterial({ color: 0x333 })); back.position.set(0, 1.8, -0.5); g.add(back);
            g.position.set(x, y, z); g.rotation.y = rot; scene.add(g); levelObjects.push(g);
        }

        function createQuestMarker(target) {
            const g = new THREE.Group();
            const cone = new THREE.Mesh(new THREE.ConeGeometry(0.3, 0.8, 8), new THREE.MeshBasicMaterial({ color: 0xffff00, emissive: 0xffff00 })); cone.rotation.z = Math.PI;
            const ball = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({ color: 0xffff00, emissive: 0xffff00 })); ball.position.y = -0.6;
            g.add(cone); g.add(ball);
            const pos = new THREE.Vector3(); target.getWorldPosition(pos);
            g.position.set(pos.x, pos.y + 3.5, pos.z);
            scene.add(g); markers.push(g);
            g.userData.anim = () => { g.rotation.y += 0.05; g.position.y = pos.y + 3.5 + Math.sin(Date.now() * 0.005) * 0.2; };
        }

        function updateMarkers() {
            markers.forEach(m => scene.remove(m)); markers = [];
            let targetName = "";
            if (currentLevel === "LOBBY") {
                if (missionProgress === 0) targetName = "Comandante Motta";
                else if (missionProgress === 1) targetName = "Personaliza√ß√£o";
                else if (missionProgress === 2) targetName = "Agente J√∫lia";
                else if (missionProgress === 3) targetName = "Portal";
                else if (missionProgress === 6) targetName = "Comandante Motta";
                else if (missionProgress === 7) targetName = "Agente J√∫lia";
                else if (missionProgress === 8) targetName = "Portal";
            } else if (currentLevel === "CYBER_OPS") {
                if (missionProgress === 3) targetName = "Capit√£ Dados";
                else if (missionProgress === 4) targetName = "Terminal de Miss√£o";
                else if (missionProgress === 5) targetName = "Rob√¥ Fair Play";
                else if (missionProgress === 6) targetName = "Portal"; // Portal back
            }

            if (targetName) {
                // Search in interactables
                const target = interactables.find(i => i.userData.name === targetName);
                if (target) createQuestMarker(target);
            }
        }

        // --- HUMANOID (ARREDONDADO & ORGANICO) ---
        function createHair(styleId, colorHex) {
            if (styleId === 0) return null;
            const hairMat = new THREE.MeshStandardMaterial({ color: colorHex, roughness: 0.8 });
            let hairMesh;

            // Ajuste para cabe√ßa esf√©rica (raio 0.25)
            if (styleId === 1) { // Curto
                hairMesh = new THREE.Group();
                const base = new THREE.Mesh(new THREE.SphereGeometry(0.26, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2.5), hairMat);
                base.rotation.x = -Math.PI / 2; // Topo da cabe√ßa
                hairMesh.add(base);
                for (let i = 0; i < 6; i++) {
                    const spike = new THREE.Mesh(new THREE.ConeGeometry(0.04, 0.1, 4), hairMat);
                    spike.position.set((Math.random() - 0.5) * 0.3, 0.25, (Math.random() - 0.5) * 0.3);
                    spike.rotation.set((Math.random() - 0.5), (Math.random() - 0.5), (Math.random() - 0.5));
                    hairMesh.add(spike);
                }
            } else if (styleId === 2) { // M√©dio
                hairMesh = new THREE.Mesh(new THREE.SphereGeometry(0.27, 32, 16, 0, Math.PI * 2, 0, Math.PI / 1.8), hairMat);
                hairMesh.rotation.x = -Math.PI / 2;
            } else if (styleId === 3) { // Longo
                hairMesh = new THREE.Group();
                const top = new THREE.Mesh(new THREE.SphereGeometry(0.27, 32, 16, 0, Math.PI * 2, 0, Math.PI / 1.8), hairMat);
                top.rotation.x = -Math.PI / 2;
                hairMesh.add(top);
                const pony = new THREE.Mesh(new THREE.CapsuleGeometry(0.08, 0.4, 4, 8), hairMat);
                pony.position.set(0, -0.1, -0.25);
                pony.rotation.x = -0.3;
                hairMesh.add(pony);
            }
            return hairMesh;
        }

        function createHumanoid(color, hairStyle = 0, hairColor = CONFIG.colors.defaultHair) {
            const c = new THREE.Group(); c.scale.set(1.4, 1.4, 1.4);
            const mats = { skin: new THREE.MeshStandardMaterial({ color: CONFIG.colors.skin }), shirt: new THREE.MeshStandardMaterial({ color: color, emissive: color, emissiveIntensity: 0.3 }), pants: new THREE.MeshStandardMaterial({ color: 0x111 }), pack: new THREE.MeshStandardMaterial({ color: CONFIG.colors.backpack }) };

            // Corpo: Capsula
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.25, 0.5, 4, 8), mats.shirt);
            body.position.y = 1.0;
            c.add(body);

            const headG = new THREE.Group(); headG.position.y = 1.6;
            // Cabe√ßa: Esfera
            headG.add(new THREE.Mesh(new THREE.SphereGeometry(0.25, 32, 16), mats.skin));

            const hairMesh = createHair(hairStyle, hairColor);
            if (hairMesh) headG.add(hairMesh);

            // Rosto
            const eyeGeo = new THREE.SphereGeometry(0.035); const eyeMat = new THREE.MeshBasicMaterial({ color: 0 });
            const lEye = new THREE.Mesh(eyeGeo, eyeMat); lEye.position.set(0.1, 0.05, 0.22); headG.add(lEye);
            const rEye = new THREE.Mesh(eyeGeo, eyeMat); rEye.position.set(-0.1, 0.05, 0.22); headG.add(rEye);
            const mouth = new THREE.Mesh(new THREE.CapsuleGeometry(0.02, 0.1, 4, 8), eyeMat);
            mouth.rotation.z = Math.PI / 2;
            mouth.position.set(0, -0.1, 0.22);
            headG.add(mouth);

            // Capacete (Esfera maior transparente)
            const helmet = new THREE.Mesh(new THREE.SphereGeometry(0.3, 32, 16), new THREE.MeshStandardMaterial({ color: 0x00eaff, transparent: true, opacity: 0.4 }));
            helmet.visible = false; headG.add(helmet); c.add(headG);

            // Membros: Capsulas
            const limbG = new THREE.CapsuleGeometry(0.08, 0.6, 4, 8);
            const lArm = new THREE.Mesh(limbG, mats.shirt); lArm.position.set(0.35, 1.0, 0); c.add(lArm);
            const rArm = new THREE.Mesh(limbG, mats.shirt); rArm.position.set(-0.35, 1.0, 0); c.add(rArm);

            const legG = new THREE.CapsuleGeometry(0.09, 0.7, 4, 8);
            const lLeg = new THREE.Mesh(legG, mats.pants); lLeg.position.set(0.12, 0.35, 0); c.add(lLeg);
            const rLeg = new THREE.Mesh(legG, mats.pants); rLeg.position.set(-0.12, 0.35, 0); c.add(rLeg);

            const pack = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.4, 0.2), mats.pack); pack.position.set(0, 1.0, -0.25); c.add(pack);

            c.userData.parts = { body, head: headG, leftArm: lArm, rightArm: rArm, leftLeg: lLeg, rightLeg: rLeg, backpack: pack, helmet, hair: hairMesh };
            return c;
        }

        // --- INTERA√á√ÉO ---
        function createNPC(x, y, z, color, name, dialogs, hairStyle = 0, hairColor = CONFIG.colors.defaultHair, rot = 0) {
            const g = new THREE.Group(); g.position.set(x, y, z);
            g.rotation.y = rot;
            const char = createHumanoid(color, hairStyle, hairColor);
            char.position.y = 0; g.add(char);

            const ring = new THREE.Mesh(new THREE.RingGeometry(0.8, 0.9, 32), new THREE.MeshBasicMaterial({ color: color, side: THREE.DoubleSide }));
            ring.rotation.x = -Math.PI / 2; ring.position.y = 0.1; g.add(ring);

            // Floating exclamation mark or visor to indicate NPC
            const mark = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
            mark.position.y = 2.2;
            g.add(mark);

            g.userData = { isInteractable: true, name: name, dialogs: dialogs };
            scene.add(g); levelObjects.push(g); interactables.push(g);
            addCollisionBox(x, y, z, 1.5, 2, 1.5);
        }

        function createPlayer(id) {
            if (id === 1) {
                player = createRobot(CONFIG.colors.agent1);
            } else {
                player = createHumanoid(CONFIG.colors.agent2, playerState.hairStyle, playerState.hairColor);
            }
            scene.add(player); playerBody = new THREE.Box3();
        }

        function handleInteraction(obj) {
            if (!obj) return;
            const data = obj.userData;
            let dialogs = data.dialogs || [];

            if (data.type === "DOOR") {
                if (isTransitioning) return; // Previne spam
                if (data.target === "LOBBY") {
                    isTransitioning = true;
                    loadScene("LOBBY");
                    if (missionProgress === 6) { updateHUD("Miss√£o Completa!", "#fff"); startDialog("SISTEMA", ["Parab√©ns! Voc√™ √© um expert em seguran√ßa!"]); }
                } else if (data.target === "CYBER_OPS") {
                    if (missionProgress > 2) {
                        isTransitioning = true;
                        loadScene(data.target);
                        if (missionProgress <= 3) { missionProgress = 3; updateHUD("Fale com Capit√£ Dados", "#ff0055"); startDialog("SISTEMA", ["Acesso autorizado. Fale com a Capit√£ Dados."]); }
                    } else startDialog("SISTEMA", ["Portal trancado. Voc√™ precisa de autoriza√ß√£o para usar."]);
                } else if (data.target === "MAZE_LEVEL") {
                    // Logic for Maze Level
                    isTransitioning = true;
                    loadScene("MAZE_LEVEL");
                    updateHUD("Encontre a Sa√≠da do Labirinto", "#ffff00");
                }
                return;
            }

            if (data.type === "PC_CUSTOM") {
                document.getElementById('custom-name').value = playerState.name === "Agente" ? "" : playerState.name;
                document.getElementById('custom-backpack-color').value = '#' + playerState.backpackColor.toString(16).padStart(6, '0');
                document.getElementById('custom-helmet-toggle').checked = playerState.hasHelmet;
                document.getElementById('helmet-color-section').classList.toggle('hidden', !playerState.hasHelmet);
                document.getElementById('custom-helmet-color').value = '#' + playerState.helmetColor.toString(16).padStart(6, '0');
                uiSelectedHairStyleIndex = playerState.hairStyle;
                document.getElementById('hair-style-label').innerText = HAIR_STYLES[uiSelectedHairStyleIndex];
                document.getElementById('custom-hair-color').value = '#' + playerState.hairColor.toString(16).padStart(6, '0');
                document.getElementById('computer-overlay').style.display = 'flex';
                ['pc-view-login', 'pc-view-sequence', 'pc-view-social', 'pc-view-arcade', 'pc-view-desktop', 'social-app-window'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.classList.add('hidden');
                });
                document.getElementById('pc-view-custom').classList.remove('hidden');
                return;
            }

            if (data.type === "PC_MISSION") {
                if (missionProgress < 4) {
                    startDialog("SISTEMA", ["Acesso negado. Fale com a Capit√£ Dados primeiro!"]);
                } else {
                    document.getElementById('computer-overlay').style.display = 'flex';
                    ['pc-view-custom', 'pc-view-sequence', 'pc-view-social', 'pc-view-arcade', 'pc-view-desktop', 'social-app-window'].forEach(id => {
                        const el = document.getElementById(id); if (el) el.classList.add('hidden');
                    });
                    document.getElementById('pc-view-login').classList.remove('hidden');
                }
                return;
            }

            if (data.type === "ARCADE") { startArcadeGame(); return; }

            if (data.name === "Comandante Motta") {
                if (missionProgress === 0) {
                    dialogs = ["Bem-vindo! Fico muito feliz em te ver conosco!", "Todos os agentes novatos podem criar seu uniforme.", "V√° ao Globo Central para criar seu uniforme"];
                    missionProgress = 1; updateHUD("Personalize seu Agente", "#00ff88");
                } else if (missionProgress === 6) {
                    dialogs = [
                        "Orgulho da equipe! Continue protegendo seus amigos online.",
                        {
                            question: "Agora que voc√™ j√° √© um expert, que tal come√ßar uma nova miss√£o?",
                            options: [
                                { text: "Fazer depois", correct: false },
                                { text: "Iniciar nova miss√£o", correct: true }
                            ]
                        }
                    ];
                    // updateHUD("Fale com a agente J√∫lia para obter mais informa√ß√µes.", "#00ff88");
                }
            } else if (data.name === "Agente J√∫lia") {
                if (missionProgress < 2) {
                    dialogs = ["Fale primeiro com o Capit√£o Motta"];
                } else if (missionProgress === 2) {
                    dialogs = ["√ìtimo uniforme! O portal est√° aberto. Entre e procure a Capit√£ Dados."];
                    missionProgress = 3; updateHUD("Entre no Portal", "#d500f9");
                } else if (missionProgress === 7) {
                    dialogs = ["O vil√£o Dr. Malvado roubou os dados de v√°rios colegas!", `Precisamos de voc√™, agente ${playerState.name}!`, "J√° configurei o portal para voc√™ entrar na base secreta do Dr. Malvado", "Encontre a sala secreta dele e recupere nossos dados!"];
                    missionProgress = 8; updateHUD("Entre no Portal", "#d500f9");
                } else {
                    dialogs = ["Fico feliz em te ver aqui!", "N√£o passe informa√ß√µes pessoais em redes sociais ou jogos!"];
                }
            } else if (data.name === "Capit√£ Dados") {
                if (missionProgress === 3) {
                    dialogs = ["Parado a√≠! Antes de usar o computador, preciso saber se voc√™ √© seguro.", { question: "Algu√©m num jogo pediu seu endere√ßo. O que voc√™ faz?", options: [{ text: "Passo o endere√ßo", correct: false }, { text: "N√£o passo e aviso meus pais", correct: true }] }];
                } else {
                    dialogs = ["Voc√™ j√° passou no teste! Pode usar o computador."];
                }
            } else if (data.name === "Rob√¥ Fair Play") {
                if (missionProgress === 5) {
                    dialogs = ["Vi que voc√™ denunciou o golpe. Muito bem!", "Lembre-se: Jogo bom √© jogo com respeito. Se algu√©m for chato, bloqueie!", "Agora pode voltar para o Lobby."];
                    missionProgress = 6; updateHUD("Volte para o Lobby", "#fff");
                } else {
                    dialogs = ["Estou monitorando o respeito nas partidas. Sem xingamentos, ok?"];
                }
            }
            startDialog(data.name, dialogs);
            updateMarkers();
        }

        function startDialog(name, texts) {
            if (isDialogOpen) return;
            isDialogOpen = true;
            document.getElementById('dialog-box').style.display = 'block';
            document.getElementById('npc-name').innerText = name;
            currentDialogQueue = [...texts];
            advanceDialog();
        }

        function updateHUD(txt, col) {
            const h = document.getElementById('obj-text'); h.innerText = txt; h.style.color = col; h.style.textShadow = `0 0 10px ${col}`;
            updateMarkers();
        }

        function setupInputs() {
            const onK = (k, v) => { if (['w', 's', 'a', 'd', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(k.toLowerCase())) keys[k.toLowerCase().replace('arrow', '').replace('key', '')] = v; };
            document.addEventListener('keydown', e => { if (e.code === 'Space' || e.code === 'Enter') { const target = getNearestInteractable(); if (target) handleInteraction(target); } else onK(e.key, true); });
            document.addEventListener('keyup', e => onK(e.key, false));
            window.addEventListener('pointerdown', e => { if (!e.target.closest('.screen') && !e.target.closest('#joystick-zone')) { isMouseDown = true; dragStartX = e.clientX; isDraggingView = false; } });
            window.addEventListener('pointermove', e => {
                if (e.buttons === 0) isMouseDown = false;
                if (isMouseDown && Math.abs(e.clientX - dragStartX) > 5) { isDraggingView = true; cameraAngle -= (e.clientX - dragStartX) * 0.005; dragStartX = e.clientX; }
            });
            window.addEventListener('pointerup', e => {
                if (e.target.closest('.pc-window') || e.target.closest('.screen') || e.target.closest('#dialog-box') || e.target.closest('#joystick-zone') || e.target.closest('.hair-selector')) return;
                isMouseDown = false;
                if (!isDraggingView) { const target = getNearestInteractable(); if (target) handleInteraction(target); }
                isDraggingView = false;
            });
            window.addEventListener('pointerleave', () => { isMouseDown = false; isDraggingView = false; });

            const joy = document.getElementById('joystick-zone');
            if ('ontouchstart' in window) {
                const m = nipplejs.create({ zone: joy, mode: 'static', position: { left: '50%', top: '50%' }, color: 'cyan' });
                m.on('move', (e, d) => { if (d.vector) joystickVec.set(d.vector.x * d.force, 0, -d.vector.y * d.force); });
                m.on('end', () => joystickVec.set(0, 0, 0));
            } else joy.style.display = 'none';
        }

        function getNearestInteractable() {
            let n = null, md = 5;
            interactables.forEach(o => { const d = player.position.distanceTo(o.getWorldPosition(new THREE.Vector3())); if (d < md) { n = o; md = d; } });
            return n;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (player && clock) {
                const dt = clock.getDelta();

                // Anima√ß√µes de ambiente
                markers.forEach(m => { if (m.userData.anim) m.userData.anim(); });
                levelObjects.forEach(obj => { if (obj.userData.animate) obj.userData.animate(); });

                // Anima√ß√£o dos Drones
                drones.forEach(d => {
                    if (!d.userData.path) return;
                    const target = d.userData.path[d.userData.pathIndex];
                    const dir = new THREE.Vector3(target.x - d.position.x, 0, target.z - d.position.z);
                    if (dir.length() < 0.2) {
                        d.userData.pathIndex = (d.userData.pathIndex + 1) % d.userData.path.length;
                    } else {
                        dir.normalize();
                        d.position.add(dir.multiplyScalar(d.userData.speed * dt));
                        d.lookAt(target.x, d.position.y, target.z);
                    }

                    // Colis√£o Player-Drone
                    if (player.position.distanceTo(d.position) < 1.5) {
                        // Reset position logic
                        player.position.set(0, 0, 32);
                        player.rotation.y = Math.PI;
                    }
                });


                if (!isDialogOpen) {
                    const m = new THREE.Vector3(0, 0, 0);
                    if (keys.w) m.z -= 1; if (keys.s) m.z += 1; if (keys.a) m.x -= 1; if (keys.d) m.x += 1;
                    if (joystickVec.lengthSq() > 0) m.add(joystickVec);
                    let groundY = 0;
                    const rayOrigin = player.position.clone(); rayOrigin.y += 5;
                    groundRaycaster.set(rayOrigin, new THREE.Vector3(0, -1, 0));
                    const hits = groundRaycaster.intersectObjects(floors, false);
                    if (hits.length > 0) groundY = hits[0].point.y;

                    if (m.lengthSq() > 0) {
                        m.normalize().applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraAngle);
                        const np = player.position.clone().add(m.multiplyScalar(CONFIG.speed * dt));
                        const pBox = new THREE.Box3().setFromCenterAndSize(new THREE.Vector3(np.x, groundY + 1, np.z), new THREE.Vector3(0.7, 2, 0.7));
                        let col = false;
                        obstacles.forEach(o => { if (pBox.intersectsBox(o)) col = true; });
                        if (!col) {
                            player.position.copy(np);
                            player.rotation.y = Math.atan2(m.x, m.z);
                            walkTime += dt * 12;
                            player.userData.parts.body.position.y = 1.0 + Math.sin(walkTime) * 0.05;
                            player.userData.parts.leftLeg.rotation.x = -Math.sin(walkTime) * 0.6;
                            player.userData.parts.rightLeg.rotation.x = Math.sin(walkTime) * 0.6;
                            player.userData.parts.leftArm.rotation.x = Math.sin(walkTime) * 0.6;
                            player.userData.parts.rightArm.rotation.x = -Math.sin(walkTime) * 0.6;
                        }
                        interactables.forEach(obj => {
                            if (obj.userData.type === "DOOR") {
                                const portalPos = obj.getWorldPosition(new THREE.Vector3());
                                const dx = player.position.x - portalPos.x;
                                const dz = player.position.z - portalPos.z;
                                const dist2D = Math.sqrt(dx * dx + dz * dz);

                                if (dist2D < 1.5) { // Aumentei o raio de detec√ß√£o
                                    handleInteraction(obj);
                                }
                            }
                        });

                    } else {
                        player.userData.parts.body.position.y = 1.0;
                        player.userData.parts.leftLeg.rotation.x = 0; player.userData.parts.rightLeg.rotation.x = 0;
                        player.userData.parts.leftArm.rotation.x = 0; player.userData.parts.rightArm.rotation.x = 0;
                    }
                    player.position.y += (groundY - player.position.y) * 0.2;
                }

                // CAMERA LOGIC
                let targetCamPos;
                let targetLookAt;

                if (currentLevel === "MAZE_LEVEL") {
                    // First person / close third person logic
                    const offset = new THREE.Vector3(0, 3, -8); // Closer, lower, behind
                    offset.applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraAngle + Math.PI); // +PI because cameraAngle might be inverted relative to player face
                    // Actually player rotation is handled by movement direction.
                    // But for camera, let's base it on cameraAngle variable which controls view.

                    // Re-calculating offset based on cameraAngle to orbit properly
                    const dist = 6;
                    const height = 5;
                    const cx = player.position.x + Math.sin(cameraAngle) * dist;
                    const cz = player.position.z + Math.cos(cameraAngle) * dist;
                    const cy = player.position.y + height;

                    targetCamPos = new THREE.Vector3(cx, cy, cz);
                    targetLookAt = player.position.clone().add(new THREE.Vector3(0, 1, 0)); // Look slightly above feet
                } else {
                    // Standard Isometric View
                    const co = new THREE.Vector3(Math.sin(cameraAngle) * 25, 25, Math.cos(cameraAngle) * 25);
                    targetCamPos = player.position.clone().add(co);
                    targetLookAt = player.position.clone();
                }

                camera.position.lerp(targetCamPos, 0.1);
                camera.lookAt(targetLookAt);


                // --- VIS√ÉO RAIO-X (TRANSPAR√äNCIA) ---
                if (currentLevel !== "MAZE_LEVEL") {
                    wallRaycaster.set(camera.position, player.position.clone().sub(camera.position).normalize());
                    const distanceToPlayer = camera.position.distanceTo(player.position);
                    const intersects = wallRaycaster.intersectObjects(wallMeshes);
                    // Reseta todas para opaco
                    wallMeshes.forEach(w => w.material.opacity = 1.0);
                    // Deixa transparente o que bloqueia a vis√£o
                    intersects.forEach(hit => {
                        if (hit.distance < distanceToPlayer - 1) { // -1 para n√£o pegar o pr√≥prio player
                            hit.object.material.opacity = 0.3;
                        }
                    });
                } else {
                    // In maze level, we might want walls opaque to hide enemies?
                    // Or keep transparency for better UX? Let's keep opaque for maze challenge.
                    wallMeshes.forEach(w => w.material.opacity = 1.0);
                }

                composer.render();
            }
        }

        window.addEventListener('resize', () => {
            if (camera && renderer && composer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>

</html>