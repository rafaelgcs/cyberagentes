<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cyber Agentes - Miss√£o 01</title>

    <!-- Fontes -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Roboto:wght@300;400;700&display=swap');

        /* --- ESTILOS GERAIS --- */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            visibility: hidden;
            cursor: grab;
        }

        #game-container:active {
            cursor: grabbing;
        }

        /* --- SISTEMA DE TELAS (MENU) --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #2e7d32 0%, #004d40 100%);
            color: white;
            transition: opacity 0.5s;
        }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-size: 4rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 5px;
        }

        h2 {
            font-size: 2rem;
            color: #a5d6a7;
        }

        .btn {
            background: #fff;
            color: #2e7d32;
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background 0.2s;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: scale(1.05);
            background: #e8f5e9;
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #fff;
            color: #fff;
        }

        .credits-content {
            background: rgba(0, 0, 0, 0.3);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
            font-family: 'Roboto', sans-serif;
        }

        .agent-selector {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }

        .agent-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            width: 180px;
        }

        .agent-card:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .agent-card.selected {
            border-color: #ffd54f;
            background: rgba(255, 213, 79, 0.2);
            transform: translateY(-10px);
        }

        #agent-1 .agent-icon {
            color: #00eaff;
            text-shadow: 0 0 10px #00eaff;
        }

        #agent-2 .agent-icon {
            color: #d500f9;
            text-shadow: 0 0 10px #d500f9;
        }

        .agent-icon {
            font-size: 4rem;
            margin-bottom: 10px;
            display: block;
        }

        #game-ui {
            display: none;
        }

        #mission-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-left: 5px solid #2e7d32;
            padding: 15px;
            width: 250px;
            color: #333;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            border-radius: 0 8px 8px 0;
        }

        #mission-hud h4 {
            margin: 0 0 5px 0;
            color: #2e7d32;
            text-transform: uppercase;
            font-size: 14px;
        }

        #dialog-box {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 700px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 20px;
            display: none;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            z-index: 20;
            color: #333;
        }

        #npc-name {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
            display: block;
        }

        #joystick-zone {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            z-index: 20;
        }

        /* Tela de Transi√ß√£o (Loading) */
        #transition-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
            color: #00eaff;
            font-size: 2rem;
            font-family: 'Rajdhani', sans-serif;
        }

        /* --- INTERFACE DO COMPUTADOR (NOVO) --- */
        #computer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 60;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .pc-window {
            width: 800px;
            height: 600px;
            background: #1e1e2e;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            position: relative;
        }

        .pc-header {
            background: #2e2e3e;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            border-bottom: 2px solid #444;
        }

        .close-btn {
            color: #ff5555;
            cursor: pointer;
            font-weight: bold;
        }

        .pc-content {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        /* Tela de Login */
        .login-form input {
            padding: 15px;
            width: 300px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }

        .password-feedback {
            font-size: 12px;
            margin-top: 10px;
            color: #ff5555;
            min-height: 20px;
        }

        /* Puzzle de Mem√≥ria */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .memory-card {
            width: 80px;
            height: 80px;
            background: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .memory-card.flipped {
            background: #00eaff;
            color: #000;
        }

        .memory-card.matched {
            background: #2e7d32;
            opacity: 0.5;
            pointer-events: none;
        }

        /* Rede Social Falsa */
        .social-feed {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: #f0f2f5;
            color: #333;
            padding: 20px;
        }

        .post {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .post-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1877f2;
        }

        .fake-news-btn {
            background: #ff5555;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>

    <!-- Scripts -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
</head>

<body>

    <div id="screen-menu" class="screen">
        <h1>CYBER AGENTES</h1>
        <p style="letter-spacing: 2px; margin-bottom: 40px;">PROJETO EDUCACIONAL</p>
        <div>
            <button class="btn" onclick="goToSelect()">INICIAR</button>
            <button class="btn btn-secondary" onclick="goToCredits()">CR√âDITOS</button>
        </div>
    </div>

    <div id="screen-credits" class="screen hidden">
        <h2>EQUIPE & CR√âDITOS</h2>
        <div class="credits-content">
            <p><strong>Desenvolvimento:</strong> Equipe Cyber Agentes</p>
            <p><strong>Arte & Design:</strong> Baseado em conceitos modernos de UI.</p>
            <p><strong>Agradecimentos:</strong> A todos os mentores e professores.</p>
            <br>
            <p style="font-size: 0.9em; font-style: italic;">"Protegendo o futuro, um dado de cada vez."</p>
        </div>
        <button class="btn btn-secondary" onclick="goToMenu()" style="margin-top: 30px;">VOLTAR</button>
    </div>

    <div id="screen-select" class="screen hidden">
        <h2>SELECIONE SEU AGENTE</h2>
        <div class="agent-selector">
            <div class="agent-card" id="agent-1" onclick="selectAgent(1)">
                <div class="agent-icon">ü§ñ</div>
                <h3>AGENTE 01</h3>
                <small style="color: #00eaff;">Cor: Azul Cyber</small>
                <p style="font-size: 12px; margin-top: 5px;">Mochila T√°tica</p>
            </div>
            <div class="agent-card" id="agent-2" onclick="selectAgent(2)">
                <div class="agent-icon">üëæ</div>
                <h3>AGENTE 02</h3>
                <small style="color: #d500f9;">Cor: Roxo Neon</small>
                <p style="font-size: 12px; margin-top: 5px;">Mochila Hacker</p>
            </div>
        </div>
        <button id="btn-start-game" class="btn" style="opacity: 0.5; pointer-events: none;"
            onclick="launchGame()">ENTRAR NA MISS√ÉO</button>
        <br>
        <button class="btn btn-secondary" style="font-size: 1rem; padding: 10px 20px;"
            onclick="goToMenu()">VOLTAR</button>
    </div>

    <div id="game-container"></div>
    <div id="transition-screen">CARREGANDO...</div>

    <!-- INTERFACE DO COMPUTADOR -->
    <div id="computer-overlay">
        <div class="pc-window">
            <div class="pc-header">
                <span>CyberOS v2.0 - Acesso Restrito</span>
                <span class="close-btn" onclick="closePC()">X</span>
            </div>
            <div class="pc-content" id="pc-view-login">
                <h3 style="margin-bottom: 20px;">AUTENTICA√á√ÉO NECESS√ÅRIA</h3>
                <div class="login-form" style="text-align: center;">
                    <p style="font-size: 14px; margin-bottom: 10px; color: #aaa;">Dica: Use mai√∫sculas, n√∫meros e
                        s√≠mbolos.</p>
                    <input type="password" id="pc-pass-input" placeholder="Digite sua senha forte...">
                    <br>
                    <button class="btn" style="padding: 10px 30px; font-size: 1rem;"
                        onclick="checkPassword()">ENTRAR</button>
                    <div class="password-feedback" id="pass-feedback"></div>
                </div>
            </div>
            <div class="pc-content hidden" id="pc-view-puzzle">
                <h3 style="margin-bottom: 10px;">FIREWALL BLOQUEADO</h3>
                <p style="margin-bottom: 20px; font-size: 14px;">Encontre os pares de seguran√ßa para liberar o acesso.
                </p>
                <div class="memory-grid" id="memory-game">
                    <!-- Cards gerados via JS -->
                </div>
            </div>
            <div class="pc-content hidden" id="pc-view-social" style="padding: 0;">
                <div class="social-feed">
                    <div
                        style="background: #1877f2; color: white; padding: 10px; margin-bottom: 10px; font-weight: bold;">
                        FaceLook Feed</div>

                    <div class="post">
                        <div class="post-header">Gatinhos Fofos</div>
                        <p>Olha que foto linda do meu gato dormindo! üò∫üí§ #bomdia</p>
                    </div>

                    <div class="post">
                        <div class="post-header" style="color: #d32f2f;">URGENTE NOT√çCIAS ‚ö†Ô∏è</div>
                        <p>ATEN√á√ÉO! O governo vai proibir a internet amanh√£! Clique aqui para impedir agora!!! üò±üö´</p>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Link suspeito: www.fakenews-virus.com
                        </p>
                        <button class="fake-news-btn" onclick="reportFakeNews()">üö® DENUNCIAR FAKE NEWS</button>
                    </div>

                    <div class="post">
                        <div class="post-header">Escola Digital</div>
                        <p>As aulas de programa√ß√£o come√ßam semana que vem. N√£o percam!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-ui">
        <div id="mission-hud">
            <h4>OBJETIVO ATUAL</h4>
            <div style="font-size: 14px; display: flex; align-items: center;">
                <span style="color: #f9a825; margin-right: 5px;">‚¨§</span>
                <span id="obj-text">Fale com o Comandante</span>
            </div>
        </div>

        <div id="dialog-box" onclick="advanceDialog()">
            <span id="npc-name">SISTEMA</span>
            <div id="dialog-text">...</div>
            <div style="text-align: right; color: #999; font-size: 12px; margin-top: 10px;">[ Toque para continuar ]
            </div>
        </div>

        <div id="joystick-zone"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';

        // --- CONFIGURA√á√ÉO GLOBAL ---
        const CONFIG = {
            speed: 8,
            colors: {
                wall: 0xf5f5f5,
                outside: 0x2e7d32,
                sky: 0xe3f2fd,
                furniture: 0x5d4037,
                agent1: 0x00eaff,
                agent2: 0xd500f9,
                commander: 0xff6f00,
                npc: 0x388e3c,
                skin: 0xffdbac,
                backpack: 0x333333,
                doorFrame: 0x222222
            }
        };

        // Vari√°veis Globais
        let scene, camera, renderer, clock;
        let player, playerBody;
        let levelObjects = [];
        let obstacles = [];
        let interactables = [];

        let selectedAgentId = null;
        let missionProgress = 0;
        let currentLevel = "LOBBY";

        let isDialogOpen = false;
        let currentDialogQueue = [];

        let wallTextureBase = null;
        let doorTextureBase = null;

        let keys = { w: false, a: false, s: false, d: false };
        let joystickVec = new THREE.Vector3();
        let cameraAngle = 0;
        let isDraggingView = false;
        let dragStartX = 0;
        let isMouseDown = false;
        let walkTime = 0;

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // --- L√ìGICA DO COMPUTADOR ---
        window.checkPassword = () => {
            const pass = document.getElementById('pc-pass-input').value;
            const feedback = document.getElementById('pass-feedback');

            const hasUpper = /[A-Z]/.test(pass);
            const hasNumber = /[0-9]/.test(pass);
            const hasSpecial = /[!@#$%^&*]/.test(pass);
            const isLong = pass.length >= 8;

            if (isLong && hasUpper && hasNumber && hasSpecial) {
                feedback.style.color = "#00ff00";
                feedback.innerText = "SENHA FORTE ACEITA! INICIANDO SISTEMA...";
                setTimeout(() => {
                    document.getElementById('pc-view-login').classList.add('hidden');
                    document.getElementById('pc-view-puzzle').classList.remove('hidden');
                    startPuzzle();
                }, 1500);
            } else {
                feedback.style.color = "#ff5555";
                let msg = "Senha Fraca! ";
                if (!isLong) msg += "Use min 8 carateres. ";
                else if (!hasUpper) msg += "Falta letra Mai√∫scula. ";
                else if (!hasNumber) msg += "Falta um N√∫mero. ";
                else if (!hasSpecial) msg += "Falta S√≠mbolo (!@#$).";
                feedback.innerText = msg;
            }
        };

        // L√≥gica do Puzzle de Mem√≥ria
        let flippedCards = [];
        let matchedPairs = 0;
        const icons = ['üõ°Ô∏è', 'ü¶†', 'üîë', 'üíª'];

        window.startPuzzle = () => {
            const grid = document.getElementById('memory-game');
            grid.innerHTML = '';
            flippedCards = [];
            matchedPairs = 0;

            let deck = [...icons, ...icons];
            deck.sort(() => Math.random() - 0.5);

            deck.forEach((icon, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.icon = icon;
                card.innerText = '?';
                card.onclick = () => flipCard(card);
                grid.appendChild(card);
            });
        };

        function flipCard(card) {
            if (flippedCards.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) return;

            card.classList.add('flipped');
            card.innerText = card.dataset.icon;
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                setTimeout(checkMatch, 800);
            }
        }

        function checkMatch() {
            const [card1, card2] = flippedCards;
            if (card1.dataset.icon === card2.dataset.icon) {
                card1.classList.add('matched');
                card2.classList.add('matched');
                matchedPairs++;
                if (matchedPairs === 4) {
                    setTimeout(() => {
                        document.getElementById('pc-view-puzzle').classList.add('hidden');
                        document.getElementById('pc-view-social').classList.remove('hidden');
                    }, 500);
                }
            } else {
                card1.classList.remove('flipped');
                card1.innerText = '?';
                card2.classList.remove('flipped');
                card2.innerText = '?';
            }
            flippedCards = [];
        }

        window.reportFakeNews = () => {
            alert("PARAB√âNS! Voc√™ identificou a Fake News e protegeu a comunidade!");
            document.getElementById('computer-overlay').style.display = 'none';
            startDialog("COMANDANTE", ["Excelente trabalho, Agente!", "A amea√ßa foi contida.", "Retorne √† base para finalizar a miss√£o."]);

            // Atualizar miss√£o para retorno
            missionProgress = 4;
            updateHUD("Retorne √† Central de Comandos", "#00ff00");
        };

        window.closePC = () => {
            document.getElementById('computer-overlay').style.display = 'none';
        };

        // --- UI FUNCTIONS GERAIS ---
        window.goToSelect = () => {
            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-select').classList.remove('hidden');
        };
        window.goToCredits = () => {
            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-credits').classList.remove('hidden');
        };
        window.goToMenu = () => {
            document.getElementById('screen-credits').classList.add('hidden');
            document.getElementById('screen-select').classList.add('hidden');
            document.getElementById('screen-menu').classList.remove('hidden');
        };
        window.selectAgent = (id) => {
            selectedAgentId = id;
            document.getElementById('agent-1').classList.remove('selected');
            document.getElementById('agent-2').classList.remove('selected');
            if (id === 1) document.getElementById('agent-1').classList.add('selected');
            if (id === 2) document.getElementById('agent-2').classList.add('selected');
            const btn = document.getElementById('btn-start-game');
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
            btn.style.background = '#ffd54f';
            btn.style.color = '#333';
        };
        window.launchGame = () => {
            document.getElementById('screen-select').classList.add('hidden');
            document.getElementById('game-container').style.visibility = 'visible';
            document.getElementById('game-ui').style.display = 'block';
            initGame();
        };

        // --- TEXTURAS ---
        function createCheckerTexture() {
            const size = 512;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#466d85'; ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#2a4d61';
            const half = size / 2;
            ctx.fillRect(0, 0, half, half);
            ctx.fillRect(half, half, half, half);
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(20, 16);
            texture.magFilter = THREE.NearestFilter;
            texture.minFilter = THREE.NearestFilter;
            return texture;
        }

        function createWallTexture() {
            const size = 512;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#cccccc'; ctx.fillRect(0, 0, size, size);
            ctx.fillStyle = '#ffffff';
            const w = size / 4; const h = size / 4; const pad = 6;
            for (let y = 0; y < 4; y++) {
                for (let x = 0; x < 4; x++) {
                    ctx.fillRect(x * w + pad / 2, y * h + pad / 2, w - pad, h - pad);
                }
            }
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.magFilter = THREE.LinearFilter;
            return texture;
        }

        function createDoorTexture() {
            const size = 256;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size * 2;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#37474f';
            ctx.fillRect(0, 0, size, size * 2);
            ctx.fillStyle = '#263238';
            ctx.fillRect(size / 2 - 2, 0, 4, size * 2);
            ctx.strokeStyle = '#90a4ae';
            ctx.lineWidth = 10;
            for (let i = -size; i < size * 2; i += 40) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(size, i + size);
                ctx.stroke();
            }
            ctx.fillStyle = '#d500f9';
            ctx.fillRect(20, 20, size - 40, 30);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.fillRect(20, 20, size - 40, 5);
            return new THREE.CanvasTexture(canvas);
        }

        // --- ENGINE ---
        function initGame() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.sky);
            scene.fog = new THREE.Fog(CONFIG.colors.sky, 20, 60);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 20, 20);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('game-container').appendChild(renderer.domElement);

            const ambient = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambient);
            const sunLight = new THREE.DirectionalLight(0xfffae3, 1.2);
            sunLight.position.set(-15, 30, -20);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            scene.add(sunLight);

            clock = new THREE.Clock();
            wallTextureBase = createWallTexture();
            doorTextureBase = createDoorTexture();

            loadScene("LOBBY");
            createPlayer(selectedAgentId);
            setupInputs();

            animate();

            startDialog("SISTEMA", [
                "Agente, bem-vindo ao Centro de Opera√ß√µes.",
                "Aproxime-se da mesa central para falar com o Comandante.",
                "Use o mouse para girar a vis√£o."
            ]);
        }

        function clearLevel() {
            levelObjects.forEach(obj => scene.remove(obj));
            levelObjects = [];
            obstacles = [];
            interactables = [];
        }

        function loadScene(sceneName) {
            const overlay = document.getElementById('transition-screen');
            overlay.style.display = 'flex';

            setTimeout(() => {
                clearLevel();
                currentLevel = sceneName;

                if (sceneName === "LOBBY") {
                    createLobbyLevel();
                    // Se estiver voltando da miss√£o, nasce perto da porta
                    if (player) {
                        if (missionProgress >= 4) player.position.set(15, 0, 0);
                        else player.position.set(0, 0, 0);
                    }
                } else if (sceneName === "ROOM") {
                    createRoomLevel();
                    if (player) player.position.set(-8, 0, 0);
                }

                overlay.style.display = 'none';
            }, 500);
        }

        // --- CEN√ÅRIO 1: LOBBY ---
        function createLobbyLevel() {
            const floorGeo = new THREE.PlaneGeometry(50, 40);
            const floorTexture = createCheckerTexture();
            const floorMat = new THREE.MeshStandardMaterial({ map: floorTexture, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            levelObjects.push(floor);

            const panoramaGeo = new THREE.CylinderGeometry(40, 40, 30, 32, 1, true);
            const panoramaMat = new THREE.MeshBasicMaterial({ color: CONFIG.colors.outside, side: THREE.BackSide });
            const panorama = new THREE.Mesh(panoramaGeo, panoramaMat);
            panorama.position.y = 5;
            scene.add(panorama);
            levelObjects.push(panorama);

            for (let i = 0; i < 15; i++) {
                const tree = createSimpleTree();
                tree.position.set((Math.random() - 0.5) * 60, 0, -22 - Math.random() * 10);
                scene.add(tree);
                levelObjects.push(tree);
            }

            createWall(-15, 2.5, -19.5, 10, 5, 1);
            createWall(15, 2.5, -19.5, 10, 5, 1);

            const glassGeo = new THREE.BoxGeometry(20, 5, 0.2);
            const glassMat = new THREE.MeshPhysicalMaterial({ color: 0x88ccff, transmission: 0.5, opacity: 0.3, transparent: true, roughness: 0 });
            const glass = new THREE.Mesh(glassGeo, glassMat);
            glass.position.set(0, 2.5, -19.5);
            scene.add(glass);
            levelObjects.push(glass);
            obstacles.push(new THREE.Box3().setFromObject(glass));

            createWall(-20, 2.5, 0, 1, 5, 40);
            createWall(20, 2.5, -10, 1, 5, 20);
            createWall(20, 2.5, 10, 1, 5, 20);

            // Porta para o Quarto
            createDoor(19.5, 0, 0, "ROOM", -Math.PI / 2);

            createWall(-12, 2.5, 19.5, 16, 5, 1);
            createWall(12, 2.5, 19.5, 16, 5, 1);

            const tableGeo = new THREE.BoxGeometry(7, 1.2, 3);
            const tableMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.furniture });
            const table = new THREE.Mesh(tableGeo, tableMat);
            table.position.set(0, 0.6, -10);
            table.castShadow = true;
            scene.add(table);
            levelObjects.push(table);
            addCollisionBox(table);

            createNPC(0, -12, CONFIG.colors.commander, "Comandante Motta", [
                "Bom dia, Agente.",
                "Detectamos uma invas√£o no servidor do alojamento.",
                "Fale com a Agente J√∫lia para pegar o acesso."
            ]);

            createWorkstation(-10, -5);
            createWorkstation(-10, 5);
            createWorkstation(10, -5);
            createWorkstation(10, 5);

            createNPC(-10, -2, CONFIG.colors.npc, "Agente J√∫lia", []);
        }

        // --- CEN√ÅRIO 2: QUARTO ---
        function createRoomLevel() {
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(20, 15),
                new THREE.MeshStandardMaterial({ color: 0x5d4037, roughness: 0.6 })
            );
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            levelObjects.push(floor);

            createWall(0, 2.5, -7.5, 20, 5, 1);
            createWall(0, 2.5, 7.5, 20, 5, 1);
            createWall(10, 2.5, 0, 1, 5, 15);
            createWall(-10, 2.5, 0, 1, 5, 15);

            // Porta de VOLTA para o Lobby
            createDoor(-9.5, 0, 0, "LOBBY", Math.PI / 2);

            const bedBase = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 6), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            bedBase.position.set(5, 0.5, -3);
            bedBase.castShadow = true;
            scene.add(bedBase);
            levelObjects.push(bedBase);
            addCollisionBox(bedBase);

            const pillow = new THREE.Mesh(new THREE.BoxGeometry(3, 0.3, 1.5), new THREE.MeshStandardMaterial({ color: 0xcccccc }));
            pillow.position.set(5, 1.1, -5);
            scene.add(pillow);
            levelObjects.push(pillow);

            const desk = new THREE.Mesh(new THREE.BoxGeometry(4, 1.5, 2), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            desk.position.set(5, 0.75, 3);
            desk.castShadow = true;
            scene.add(desk);
            levelObjects.push(desk);
            addCollisionBox(desk);

            const pcScreen = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 0.2), new THREE.MeshStandardMaterial({ color: 0x000000 }));
            pcScreen.position.set(5, 1.8, 3);
            scene.add(pcScreen);
            levelObjects.push(pcScreen);

            const screenLight = new THREE.Mesh(new THREE.PlaneGeometry(1.3, 0.8), new THREE.MeshBasicMaterial({ color: 0x00ff00 }));
            screenLight.position.set(5, 1.8, 2.89);
            screenLight.rotation.y = Math.PI;
            scene.add(screenLight);
            levelObjects.push(screenLight);

            const pcHitbox = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), new THREE.MeshBasicMaterial({ visible: false }));
            pcHitbox.position.set(5, 1.5, 2);
            pcHitbox.userData = {
                isInteractable: true,
                name: "Computador Pessoal",
                dialogs: [],
                type: "PC"
            };
            scene.add(pcHitbox);
            levelObjects.push(pcHitbox);
            interactables.push(pcHitbox);
        }

        // --- OBJETOS ---
        function createDoor(x, y, z, targetScene, rotationY = 0) {
            const group = new THREE.Group();
            group.position.set(x, y, z);
            group.rotation.y = rotationY;

            const frameGeo = new THREE.BoxGeometry(4, 5, 0.5);
            const frameMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.doorFrame });
            const frame = new THREE.Mesh(frameGeo, frameMat);
            frame.position.y = 2.5;
            group.add(frame);

            const doorGeo = new THREE.PlaneGeometry(3, 4.5);
            const doorMat = new THREE.MeshStandardMaterial({
                map: doorTextureBase,
                roughness: 0.3,
                metalness: 0.7
            });
            const door = new THREE.Mesh(doorGeo, doorMat);
            door.position.set(0, 2.25, 0.3);
            group.add(door);

            const hitBox = new THREE.Mesh(new THREE.BoxGeometry(4, 5, 2), new THREE.MeshBasicMaterial({ visible: false }));
            hitBox.position.set(0, 2.5, 0);
            hitBox.userData = {
                isInteractable: true,
                name: "Porta de Acesso",
                type: "DOOR",
                target: targetScene
            };
            group.add(hitBox);

            scene.add(group);
            levelObjects.push(group);
            interactables.push(hitBox);
        }

        function createWall(x, y, z, w, h, d) {
            const geo = new THREE.BoxGeometry(w, h, d);
            const localTex = wallTextureBase.clone();
            localTex.wrapS = THREE.RepeatWrapping;
            localTex.wrapT = THREE.RepeatWrapping;
            const len = Math.max(w, d);
            localTex.repeat.set(len * 0.5, h * 0.5);
            localTex.needsUpdate = true;
            const mat = new THREE.MeshStandardMaterial({ map: localTex, roughness: 0.5 });
            const wall = new THREE.Mesh(geo, mat);
            wall.position.set(x, y, z);
            wall.castShadow = true;
            wall.receiveShadow = true;
            scene.add(wall);
            levelObjects.push(wall);
            addCollisionBox(wall);
        }

        function createWorkstation(x, z) {
            const desk = new THREE.Mesh(new THREE.BoxGeometry(5, 1.2, 2.5), new THREE.MeshStandardMaterial({ color: CONFIG.colors.furniture }));
            desk.position.set(x, 0.6, z);
            desk.castShadow = true;
            desk.receiveShadow = true;
            scene.add(desk);
            levelObjects.push(desk);
            addCollisionBox(desk);
            const screen = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 0.1), new THREE.MeshStandardMaterial({ color: 0x333333 }));
            screen.position.set(x, 1.6, z);
            scene.add(screen);
            levelObjects.push(screen);
        }

        // --- PERSONAGENS ---
        function createHumanoid(color, hasBackpack = true) {
            const character = new THREE.Group();
            character.scale.set(1.3, 1.3, 1.3);

            const skinMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.skin });
            const shirtMat = new THREE.MeshStandardMaterial({ color: color });
            const pantsMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
            const packMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.backpack });

            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.7, 0.35), shirtMat);
            body.position.y = 1.1; body.castShadow = true; character.add(body);

            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.45, 0.4), skinMat);
            head.position.y = 1.7; head.castShadow = true; character.add(head);

            const eyeGeo = new THREE.BoxGeometry(0.05, 0.05, 0.05);
            const eyeMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const lEye = new THREE.Mesh(eyeGeo, eyeMat); lEye.position.set(0.1, 1.75, 0.2); character.add(lEye);
            const rEye = lEye.clone(); rEye.position.set(-0.1, 1.75, 0.2); character.add(rEye);

            const armGeo = new THREE.BoxGeometry(0.15, 0.6, 0.15);
            const lArm = new THREE.Mesh(armGeo, shirtMat); lArm.position.set(0.4, 1.1, 0); lArm.castShadow = true; character.add(lArm);
            const rArm = new THREE.Mesh(armGeo, shirtMat); rArm.position.set(-0.4, 1.1, 0); rArm.castShadow = true; character.add(rArm);

            const legGeo = new THREE.BoxGeometry(0.2, 0.7, 0.2);
            const lLeg = new THREE.Mesh(legGeo, pantsMat); lLeg.position.set(0.15, 0.35, 0); lLeg.castShadow = true; character.add(lLeg);
            const rLeg = new THREE.Mesh(legGeo, pantsMat); rLeg.position.set(-0.15, 0.35, 0); rLeg.castShadow = true; character.add(rLeg);

            if (hasBackpack) {
                const pack = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.5, 0.25), packMat);
                pack.position.set(0, 1.15, -0.3); pack.castShadow = true; character.add(pack);
            }

            character.userData.parts = { body, head, leftArm: lArm, rightArm: rArm, leftLeg: lLeg, rightLeg: rLeg };
            return character;
        }

        function createNPC(x, z, color, name, dialogs) {
            const npc = createHumanoid(color, true);
            npc.position.set(x, 0, z);
            npc.userData = { isInteractable: true, name: name, dialogs: dialogs };
            scene.add(npc);
            levelObjects.push(npc);
            interactables.push(npc);

            const hitBox = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshBasicMaterial({ visible: false }));
            hitBox.position.set(x, 1, z);
            addCollisionBox(hitBox);
        }

        function createSimpleTree() {
            const group = new THREE.Group();
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 4), new THREE.MeshStandardMaterial({ color: 0x5d4037 }));
            trunk.position.y = 2; group.add(trunk);
            const leaves = new THREE.Mesh(new THREE.DodecahedronGeometry(3), new THREE.MeshStandardMaterial({ color: 0x4caf50 }));
            leaves.position.y = 5; group.add(leaves);
            return group;
        }

        function addCollisionBox(mesh) {
            obstacles.push(new THREE.Box3().setFromObject(mesh));
        }

        function createPlayer(agentId) {
            let color = CONFIG.colors.agent1;
            if (agentId === 2) color = CONFIG.colors.agent2;
            player = createHumanoid(color, true);
            scene.add(player);
            playerBody = new THREE.Box3();
        }

        // --- INPUTS E INTERA√á√ÉO ---
        function setupInputs() {
            document.addEventListener('keydown', (e) => {
                if (['KeyW', 'ArrowUp'].includes(e.code)) keys.w = true;
                if (['KeyS', 'ArrowDown'].includes(e.code)) keys.s = true;
                if (['KeyA', 'ArrowLeft'].includes(e.code)) keys.a = true;
                if (['KeyD', 'ArrowRight'].includes(e.code)) keys.d = true;
                if (e.code === 'Space' || e.code === 'Enter') checkInteraction();
            });
            document.addEventListener('keyup', (e) => {
                if (['KeyW', 'ArrowUp'].includes(e.code)) keys.w = false;
                if (['KeyS', 'ArrowDown'].includes(e.code)) keys.s = false;
                if (['KeyA', 'ArrowLeft'].includes(e.code)) keys.a = false;
                if (['KeyD', 'ArrowRight'].includes(e.code)) keys.d = false;
            });

            window.addEventListener('pointerdown', (e) => {
                if (e.target.closest('.screen')) return;
                if (e.target.closest('#joystick-zone') || e.target.closest('#dialog-box')) return;
                if (e.target.closest('#computer-overlay')) return;

                isMouseDown = true;
                dragStartX = e.clientX;
                isDraggingView = false;
            });

            window.addEventListener('pointermove', (e) => {
                if (isMouseDown) {
                    if (Math.abs(e.clientX - dragStartX) > 5) isDraggingView = true;
                    if (isDraggingView) {
                        cameraAngle -= (e.clientX - dragStartX) * 0.005;
                        dragStartX = e.clientX;
                    }
                }
            });

            window.addEventListener('pointerup', (e) => {
                isMouseDown = false;
                if (!isDraggingView) {
                    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                    raycaster.setFromCamera(mouse, camera);

                    const intersects = raycaster.intersectObjects(interactables, true);

                    if (intersects.length > 0) {
                        let target = intersects[0].object;
                        while (target.parent && !target.userData.isInteractable) {
                            target = target.parent;
                            if (target === scene) break;
                        }

                        if (target.userData && target.userData.isInteractable) {
                            if (player.position.distanceTo(target.getWorldPosition(new THREE.Vector3())) < 8) {
                                handleInteraction(target);
                            }
                        }
                    }
                }
                isDraggingView = false;
            });

            const joyZone = document.getElementById('joystick-zone');
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
                const manager = nipplejs.create({ zone: joyZone, mode: 'static', position: { left: '50%', top: '50%' }, color: 'white' });
                manager.on('move', (evt, data) => {
                    const angle = data.angle.radian;
                    const force = Math.min(data.force, 1.0);
                    joystickVec.set(Math.cos(angle) * force, 0, -Math.sin(angle) * force);
                });
                manager.on('end', () => joystickVec.set(0, 0, 0));
            } else {
                joyZone.style.display = 'none';
            }
        }

        function checkInteraction() {
            let nearest = null;
            let minDist = 5;
            interactables.forEach(obj => {
                const dist = player.position.distanceTo(obj.getWorldPosition(new THREE.Vector3()));
                if (dist < minDist) nearest = obj;
            });
            if (nearest) handleInteraction(nearest);
        }

        // --- L√ìGICA DE MISS√ÉO E DI√ÅLOGO ---
        function handleInteraction(obj) {
            const data = obj.userData;
            let dialogs = data.dialogs || [];

            if (data.type === "DOOR") {
                // Se for voltar para o Lobby (A qualquer momento)
                if (data.target === "LOBBY") {
                    loadScene("LOBBY");
                    return;
                }

                // Se for para o Quarto (Miss√£o)
                if (data.target === "ROOM") {
                    if (missionProgress >= 2) {
                        loadScene(data.target);
                        if (missionProgress < 3) {
                            startDialog("SISTEMA", ["Entrando na √°rea restrita..."]);
                            missionProgress = 3;
                            updateHUD("Acesse o Computador", "#e91e63");
                        }
                    } else {
                        startDialog("SISTEMA", ["Acesso negado. Voc√™ precisa de autoriza√ß√£o."]);
                    }
                    return;
                }
            }

            if (data.type === "PC") {
                if (missionProgress >= 3) { // Permite re-acessar se quiser
                    // Abre o Overlay do PC
                    document.getElementById('computer-overlay').style.display = 'flex';
                    document.getElementById('pc-view-login').classList.remove('hidden');
                    document.getElementById('pc-view-puzzle').classList.add('hidden');
                    document.getElementById('pc-view-social').classList.add('hidden');
                    document.getElementById('pc-pass-input').value = '';
                    document.getElementById('pass-feedback').innerText = '';
                } else {
                    startDialog("SISTEMA", ["Computador bloqueado."]);
                }
                return;
            }

            const npcName = data.name;
            if (npcName === "Comandante Motta") {
                if (missionProgress === 0) {
                    updateHUD("Pegue o Tablet com a Agente J√∫lia", "#388e3c");
                    missionProgress = 1;
                } else if (missionProgress === 4) {
                    dialogs = ["√ìtimo trabalho, Agente! A rede est√° segura por enquanto."];
                    updateHUD("Miss√£o 1 Completa - Aguarde", "#ffffff");
                } else {
                    dialogs = ["V√° pegar seu equipamento com a J√∫lia."];
                }
            } else if (npcName === "Agente J√∫lia") {
                if (missionProgress === 0) dialogs = ["Fale com o Comandante primeiro."];
                else if (missionProgress === 1) {
                    dialogs = ["Aqui est√°. V√° para o Setor 2 pela porta √† direita."];
                    updateHUD("Entre na Porta √† Direita", "#d500f9");
                    missionProgress = 2;
                } else {
                    dialogs = ["A porta est√° destrancada. V√°!"];
                }
            }

            startDialog(npcName, dialogs);
        }

        function updateHUD(text, color) {
            const hud = document.getElementById('obj-text');
            hud.innerText = text;
            hud.style.color = color;
            hud.parentElement.style.transform = "scale(1.1)";
            setTimeout(() => hud.parentElement.style.transform = "scale(1)", 200);
        }

        function startDialog(name, texts) {
            if (!texts || texts.length === 0) return;
            if (isDialogOpen) return;
            isDialogOpen = true;
            document.getElementById('dialog-box').style.display = 'block';
            document.getElementById('npc-name').innerText = name;
            currentDialogQueue = [...texts];
            advanceDialog();
        }

        window.advanceDialog = function () {
            if (!isDialogOpen) return;
            if (currentDialogQueue.length > 0) {
                document.getElementById('dialog-text').innerText = currentDialogQueue.shift();
            } else {
                document.getElementById('dialog-box').style.display = 'none';
                isDialogOpen = false;
            }
        }

        // --- LOOP ---
        function update(dt) {
            if (isDialogOpen) return;

            const move = new THREE.Vector3(0, 0, 0);
            if (keys.w) move.z -= 1;
            if (keys.s) move.z += 1;
            if (keys.a) move.x -= 1;
            if (keys.d) move.x += 1;
            if (joystickVec.lengthSq() > 0) move.add(new THREE.Vector3(joystickVec.x, 0, -joystickVec.z));

            if (move.lengthSq() > 0) {
                move.normalize();
                move.applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraAngle);

                const speed = CONFIG.speed * dt;
                const nextPos = player.position.clone().add(move.multiplyScalar(speed));

                playerBody.setFromCenterAndSize(nextPos, new THREE.Vector3(0.7, 2, 0.7));

                let collided = false;
                for (let box of obstacles) {
                    if (playerBody.intersectsBox(box)) {
                        collided = true;
                        break;
                    }
                }

                if (!collided) {
                    player.position.copy(nextPos);
                    player.rotation.y = Math.atan2(move.x, move.z);

                    walkTime += dt * 10;
                    player.userData.parts.body.position.y = 1.1 + Math.sin(walkTime) * 0.05;
                    player.userData.parts.head.position.y = 1.7 + Math.sin(walkTime) * 0.05;
                    player.userData.parts.leftArm.rotation.x = Math.sin(walkTime) * 0.5;
                    player.userData.parts.rightArm.rotation.x = -Math.sin(walkTime) * 0.5;
                    player.userData.parts.leftLeg.rotation.x = -Math.sin(walkTime) * 0.5;
                    player.userData.parts.rightLeg.rotation.x = Math.sin(walkTime) * 0.5;
                }
            } else {
                player.userData.parts.body.position.y = 1.1;
                player.userData.parts.head.position.y = 1.7;
                player.userData.parts.leftArm.rotation.x = 0;
                player.userData.parts.rightArm.rotation.x = 0;
                player.userData.parts.leftLeg.rotation.x = 0;
                player.userData.parts.rightLeg.rotation.x = 0;
            }

            const camDist = 20;
            const camHeight = 20;
            const offsetX = Math.sin(cameraAngle) * camDist;
            const offsetZ = Math.cos(cameraAngle) * camDist;

            const targetCamX = player.position.x + offsetX;
            const targetCamZ = player.position.z + offsetZ;

            camera.position.x += (targetCamX - camera.position.x) * 0.1;
            camera.position.z += (targetCamZ - camera.position.z) * 0.1;
            camera.position.y = camHeight;
            camera.lookAt(player.position);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (clock && player) {
                update(clock.getDelta());
                renderer.render(scene, camera);
            }
        }

        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

    </script>
</body>

</html>