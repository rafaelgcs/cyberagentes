<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cyber Agentes - Miss√£o Seguran√ßa</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Press+Start+2P&family=Roboto:wght@300;400;700&display=swap');

        /* --- ESTILOS GERAIS --- */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            visibility: hidden;
            cursor: grab;
        }

        #game-container:active {
            cursor: grabbing;
        }

        /* --- UI --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #240b36 0%, #8314c3 100%);
            color: white;
            transition: opacity 0.5s;
            background-image: url('./assets/img/bg_app.png'); 
        }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #00eaff;
            text-align: center;
            line-height: 1.5;
            color: #ff00ff;
        }

        .btn {
            background: rgba(0, 0, 0, 0.6);
            color: #00eaff;
            border: 2px solid #00eaff;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.4);
            transition: all 0.2s;
            text-transform: uppercase;
            backdrop-filter: blur(5px);
        }

        .btn:hover {
            transform: scale(1.1);
            background: #00eaff;
            color: #000;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.8);
        }

        .btn-secondary {
            border-color: #ff00ff;
            color: #ff00ff;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.4);
        }

        .btn-secondary:hover {
            background: #ff00ff;
            color: #fff;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.8);
        }

        .credits-content {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00eaff;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
            font-family: 'Roboto', sans-serif;
            box-shadow: 0 0 20px rgba(0, 234, 255, 0.2);
        }

        .agent-selector {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }

        .agent-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #444;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            width: 180px;
        }

        .agent-card:hover {
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .agent-card.selected {
            border-color: #ffd54f;
            background: rgba(255, 213, 79, 0.2);
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 0 25px #ffd54f;
        }

        #agent-1 .agent-icon { color: #00eaff; text-shadow: 0 0 15px #00eaff; }
        #agent-2 .agent-icon { color: #d500f9; text-shadow: 0 0 15px #d500f9; }

        .agent-icon {
            font-size: 4rem;
            margin-bottom: 10px;
            display: block;
        }

        #game-ui { display: none; }

        #mission-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 10, 30, 0.9);
            border: 2px solid #00eaff;
            padding: 15px;
            width: 280px;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.3);
            z-index: 10;
            border-radius: 10px;
            font-family: 'Rajdhani', sans-serif;
        }

        #mission-hud h4 {
            margin: 0 0 5px 0;
            color: #00eaff;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 234, 255, 0.3);
            padding-bottom: 5px;
        }

        #dialog-box {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 700px;
            background: rgba(10, 10, 40, 0.95);
            border: 2px solid #ff00ff;
            border-radius: 15px;
            padding: 20px;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.4);
            z-index: 20;
            color: #fff;
            cursor: pointer;
        }

        #npc-name {
            font-weight: bold;
            color: #ff00ff;
            margin-bottom: 5px;
            display: block;
            font-size: 1.2rem;
            text-shadow: 0 0 5px #ff00ff;
        }

        #dialog-text {
            font-size: 1.1rem;
            line-height: 1.4;
        }
        
        .quiz-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }
        
        .quiz-btn {
            background: #333;
            border: 1px solid #fff;
            color: #fff;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1rem;
        }
        .quiz-btn:hover { background: #00eaff; color: #000; border-color: #00eaff; }

        #joystick-zone {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            z-index: 20;
        }

        #transition-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
            color: #00eaff;
            font-size: 2rem;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 0 0 10px #00eaff;
        }

        #computer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 60;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .pc-window {
            width: 800px;
            height: 600px;
            background: #0d0d1a;
            border: 2px solid #00eaff;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(0, 234, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            position: relative;
        }

        .pc-header {
            background: linear-gradient(90deg, #00eaff 0%, #0077ff 100%);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #000;
            font-weight: bold;
            border-bottom: 1px solid #00eaff;
        }

        .close-btn {
            background: #ff0055;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        .pc-content {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #00eaff;
            background: repeating-linear-gradient(0deg,
                    rgba(0, 234, 255, 0.05) 0px,
                    rgba(0, 234, 255, 0.05) 1px,
                    transparent 1px,
                    transparent 20px);
            overflow-y: auto;
        }

        .login-form input {
            padding: 15px;
            width: 300px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 2px solid #00eaff;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .password-feedback {
            font-size: 14px;
            margin-top: 15px;
            color: #ff5555;
            min-height: 20px;
            text-shadow: 0 0 5px rgba(255, 85, 85, 0.5);
        }

        .sequence-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .seq-btn {
            width: 100px;
            height: 100px;
            border-radius: 15px;
            cursor: pointer;
            border: 4px solid #333;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .seq-btn:active { transform: scale(0.95); }
        .seq-btn.active { opacity: 1; box-shadow: 0 0 30px currentColor; border-color: white; transform: scale(1.1); }
        .seq-btn.red { background-color: #ff0055; color: #ff0055; }
        .seq-btn.green { background-color: #00ff88; color: #00ff88; }
        .seq-btn.blue { background-color: #00eaff; color: #00eaff; }
        .seq-btn.yellow { background-color: #ffd54f; color: #ffd54f; }

        .social-feed {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: #eef2f5;
            color: #333;
            padding: 20px;
        }

        .post {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        .post-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1877f2;
            display: flex;
            align-items: center;
        }

        .fake-news-btn {
            background: #ff0055;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 0, 85, 0.4);
            transition: transform 0.2s;
        }
        .fake-news-btn:hover { transform: scale(1.05); }

        .custom-interface {
            width: 100%;
            max-width: 600px;
            background: rgba(13, 13, 26, 0.9);
            border: 1px solid #00eaff;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .custom-interface h3 {
            margin: 0 0 25px 0;
            color: #fff;
            font-size: 1.8rem;
            text-shadow: 0 0 10px #00eaff;
            letter-spacing: 2px;
            border-bottom: 2px solid #00eaff;
            padding-bottom: 10px;
            width: 100%;
            text-align: center;
        }

        .custom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            margin-bottom: 30px;
        }

        .custom-section {
            background: rgba(0, 234, 255, 0.05);
            border: 1px solid rgba(0, 234, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .custom-section label {
            font-size: 0.9rem;
            color: #00eaff;
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .cyber-input {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #555;
            border-bottom: 2px solid #00eaff;
            color: #fff;
            padding: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            outline: none;
            transition: 0.3s;
        }
        .cyber-input:focus {
            border-color: #fff;
            background: rgba(0, 234, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.2);
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            background: none;
            padding: 0;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 2px solid #fff; border-radius: 50%; }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border: 1px solid #555;
            border-radius: 30px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 4px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 0 5px #fff;
        }
        input:checked+.slider { background-color: #00eaff; border-color: #00eaff; box-shadow: 0 0 15px #00eaff; }
        input:checked+.slider:before { transform: translateX(30px); background-color: #000; }

        .action-buttons {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }

        .cyber-btn {
            background: #00eaff;
            color: #000;
            border: none;
            font-weight: bold;
            padding: 12px 30px;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            cursor: pointer;
        }
        .cyber-btn:hover { background: #fff; box-shadow: 0 0 20px #00eaff; }

    </style>

    <!-- Scripts -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
</head>

<body>

    <div id="screen-menu" class="screen">
        <div>
            <img src="./assets/img/logo_cyber_agentes.png" width="350" alt="Cyber Agentes Logo" />
        </div>
        <h1>AVENTURA SEGURA</h1>
        <div>
            <button class="btn" onclick="goToSelect()">JOGAR</button>
            <button class="btn btn-secondary" onclick="goToCredits()">CR√âDITOS</button>
        </div>
    </div>

    <div id="screen-credits" class="screen hidden">
        <h2>QUEM FEZ O JOGO?</h2>
        <div class="credits-content">
            <p><strong>Cria√ß√£o:</strong> Time Cyber Agentes</p>
            <p><strong>Miss√£o:</strong> Ensinar seguran√ßa online para todos!</p>
            <br>
            <p style="font-size: 0.9em; font-style: italic; color: #ff00ff;">"Jogue seguro, jogue feliz!"</p>
        </div>
        <button class="btn btn-secondary" onclick="goToMenu()" style="margin-top: 30px;">VOLTAR</button>
    </div>

    <div id="screen-select" class="screen hidden">
        <h2>ESCOLHA SEU AGENTE</h2>
        <div class="agent-selector">
            <div class="agent-card" id="agent-1" onclick="selectAgent(1)">
                <div class="agent-icon">ü§ñ</div>
                <h3 style="color: #fff;">ROB√î AZUL</h3>
                <small style="color: #00eaff;">Defensor de Dados</small>
            </div>
            <div class="agent-card" id="agent-2" onclick="selectAgent(2)">
                <div class="agent-icon">üëæ</div>
                <h3 style="color: #fff;">ROB√î ROXO</h3>
                <small style="color: #d500f9;">Mestre dos Puzzles</small>
            </div>
        </div>
        <button id="btn-start-game" class="btn" style="opacity: 0.5; pointer-events: none;"
            onclick="launchGame()">COME√áAR MISS√ÉO</button>
        <br>
        <button class="btn btn-secondary" style="font-size: 1rem; padding: 10px 20px;"
            onclick="goToMenu()">VOLTAR</button>
    </div>

    <div id="game-container"></div>
    <div id="transition-screen">VIAJANDO PELA REDE...</div>

    <!-- Interface Computador -->
    <div id="computer-overlay">
        <div class="pc-window">
            <div class="pc-header">
                <span>üîí Sistema de Defesa Online</span>
                <span class="close-btn" onclick="closePC()">X</span>
            </div>

            <!-- 1. Customiza√ß√£o -->
            <div class="pc-content hidden" id="pc-view-custom" style="padding: 0;">
                <div class="custom-interface">
                    <h3>PERFIL DE AGENTE</h3>

                    <div class="custom-grid">
                        <div class="custom-section">
                            <label>CODINOME SECRETO</label>
                            <input type="text" id="custom-name" placeholder="Ex: Capit√£o Net" class="cyber-input">
                        </div>
                        <div class="custom-section">
                            <label>COR DA MOCHILA</label>
                            <div class="color-picker-container">
                                <input type="color" id="custom-backpack-color" value="#222222">
                            </div>
                        </div>
                        <div class="custom-section">
                            <label>USAR CAPACETE?</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="custom-helmet-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="custom-section">
                            <label>COR DO CAPACETE</label>
                            <div class="color-picker-container">
                                <input type="color" id="custom-helmet-color" value="#00eaff">
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn cyber-btn" onclick="applyCustomization()">SALVAR IDENTIDADE</button>
                    </div>
                </div>
            </div>

            <!-- 2. Login (Desafio de Senha) -->
            <div class="pc-content hidden" id="pc-view-login">
                <h3 style="margin-bottom: 20px; text-shadow: 0 0 10px #00eaff;">SENHA SUPER SECRETA</h3>
                <div class="login-form" style="text-align: center;">
                    <p style="font-size: 16px; margin-bottom: 20px; color: #fff;">
                        Crie uma senha que ningu√©m descubra!<br>
                        <small style="color:#aaa;">(Use 8 letras, 1 Mai√∫scula, 1 N√∫mero e 1 S√≠mbolo como ! ou @)</small>
                    </p>
                    <input type="password" id="pc-pass-input" placeholder="Digite aqui a senha...">
                    <br>
                    <button class="btn" style="padding: 10px 30px; font-size: 1rem; border-radius: 25px;"
                        onclick="checkPassword()">TESTAR SENHA</button>
                    <div class="password-feedback" id="pass-feedback"></div>
                </div>
            </div>

            <!-- 3. Puzzle (Sequ√™ncia / Simon Says) -->
            <div class="pc-content hidden" id="pc-view-sequence">
                <h3 style="margin-bottom: 10px; color: #ffd54f;">MEM√ìRIA DE FERRO</h3>
                <p style="margin-bottom: 20px;">Repita a sequ√™ncia de cores para provar que √© um rob√¥ esperto!</p>
                
                <div id="seq-status" style="height: 30px; color: #fff; font-weight: bold;">Prepare-se...</div>
                
                <div class="sequence-grid">
                    <div class="seq-btn red" id="btn-0" onclick="handleSeqInput(0)"></div>
                    <div class="seq-btn green" id="btn-1" onclick="handleSeqInput(1)"></div>
                    <div class="seq-btn blue" id="btn-2" onclick="handleSeqInput(2)"></div>
                    <div class="seq-btn yellow" id="btn-3" onclick="handleSeqInput(3)"></div>
                </div>
                
                <button id="btn-start-seq" class="btn" style="margin-top: 20px; padding: 10px 20px; font-size: 1rem;" onclick="startSequenceGame()">COME√áAR JOGO</button>
            </div>

            <!-- 4. Rede Social (Miss√£o Final) -->
            <div class="pc-content hidden" id="pc-view-social" style="padding: 0;">
                <div class="social-feed">
                    <div style="background: #1877f2; color: white; padding: 15px; margin-bottom: 15px; font-weight: bold; border-radius: 8px;">
                        FaceLook - Feed Seguro
                    </div>

                    <div class="post">
                        <div class="post-header"> <span style="margin-right: 5px;">üò∫</span> Clube dos Gatinhos</div>
                        <p>Olha que foto fofa! üí§ #soneca</p>
                    </div>

                    <div class="post" style="border: 2px solid #ff0055; background-color: #fff0f5;">
                        <div class="post-header" style="color: #d32f2f;">‚ö†Ô∏è CUIDADO: GOLPE!</div>
                        <p style="font-weight: bold;">"GANHE ROBUX E DIAMANTES GR√ÅTIS! Basta me passar sua senha!" üò±üö´</p>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Usu√°rio: Trapaceiro123</p>
                        <button class="fake-news-btn" onclick="reportFakeNews()">üö® DENUNCIAR GOLPE</button>
                    </div>

                    <div class="post">
                        <div class="post-header"><span style="margin-right: 5px;">üè´</span> Escola do Futuro</div>
                        <p>Amanh√£ teremos aula de seguran√ßa digital.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-ui">
        <div id="mission-hud">
            <h4>SUA MISS√ÉO</h4>
            <div style="font-size: 14px; display: flex; align-items: center; margin-top: 8px;">
                <span style="color: #00eaff; margin-right: 8px; font-size: 18px;">‚û§</span>
                <span id="obj-text">Fale com o Comandante</span>
            </div>
        </div>

        <div id="dialog-box">
            <span id="npc-name">SISTEMA</span>
            <div id="dialog-text">...</div>
            <div id="dialog-options" class="quiz-options hidden"></div>
            <div style="text-align: right; color: #aaa; font-size: 12px; margin-top: 10px;" id="dialog-click-hint">[ TOQUE PARA CONTINUAR ]</div>
        </div>

        <div id="joystick-zone"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- CONFIGURA√á√ÉO ---
        const CONFIG = {
            speed: 12,
            colors: {
                background: 0x050510,
                fog: 0x100020,
                floorGrid: 0x220044,
                agent1: 0x00eaff,
                agent2: 0xd500f9,
                commander: 0xff6f00,
                npc: 0x00ff88,
                skin: 0xffdbac,
                backpack: 0x111111,
                neonLight: 0x00eaff
            }
        };

        // Globais
        let scene, camera, renderer, clock, composer;
        let player, playerBody;
        let levelObjects = [], obstacles = [], interactables = [], floors = [], markers = [];
        let selectedAgentId = null, missionProgress = 0, currentLevel = "LOBBY";
        
        // Estado de Di√°logo
        let isDialogOpen = false, currentDialogQueue = [];
        let isQuizMode = false;

        let playerState = { name: "Agente", hasHelmet: false, backpackColor: 0x111111, helmetColor: 0x00eaff };
        let wallTextureBase, doorTextureBase, floorTextureBase, carpetTexture;
        let keys = { w: false, a: false, s: false, d: false };
        let joystickVec = new THREE.Vector3(), cameraAngle = 0;
        let isMouseDown = false, dragStartX = 0, isDraggingView = false, walkTime = 0;

        const raycaster = new THREE.Raycaster();
        const groundRaycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // --- FUN√á√ÉO COLIS√ÉO CORRIGIDA ---
        function addCollisionBox(x, y, z, w, h, d) {
            const box = new THREE.Box3();
            // Define a caixa baseada no centro e tamanho, garantindo posi√ß√£o correta
            box.setFromCenterAndSize(new THREE.Vector3(x, y + h/2, z), new THREE.Vector3(w, h, d));
            obstacles.push(box);
        }

        // --- SISTEMA DE DI√ÅLOGO E QUIZ ---
        window.advanceDialog = function () {
            if (!isDialogOpen || isQuizMode) return;
            
            if (currentDialogQueue.length > 0) { 
                const item = currentDialogQueue.shift();
                if(typeof item === 'object') showQuiz(item);
                else document.getElementById('dialog-text').innerText = item; 
            } else { 
                document.getElementById('dialog-box').style.display = 'none'; 
                isDialogOpen = false; 
            }
        }

        function showQuiz(quizData) {
            isQuizMode = true;
            document.getElementById('dialog-text').innerText = quizData.question;
            const optsDiv = document.getElementById('dialog-options');
            optsDiv.innerHTML = '';
            optsDiv.classList.remove('hidden');
            document.getElementById('dialog-click-hint').classList.add('hidden');

            quizData.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'quiz-btn';
                btn.innerText = opt.text;
                btn.onclick = (e) => { e.stopPropagation(); handleQuizAnswer(opt.correct); };
                optsDiv.appendChild(btn);
            });
        }

        function handleQuizAnswer(isCorrect) {
            const optsDiv = document.getElementById('dialog-options');
            optsDiv.classList.add('hidden');
            document.getElementById('dialog-click-hint').classList.remove('hidden');
            isQuizMode = false;

            if(isCorrect) {
                currentDialogQueue = ["Resposta Certa! Muito bem!", ...currentDialogQueue];
                if(missionProgress === 3) { missionProgress = 4; updateHUD("Use o Computador da Miss√£o", "#ff00ff"); }
            } else {
                currentDialogQueue = ["Hmm, n√£o √© bem isso. Tente pensar em seguran√ßa!", "Vamos tentar de novo depois."];
            }
            advanceDialog();
        }

        // --- JOGO DA SEQU√äNCIA ---
        let gameSequence = [], playerSequence = [], isPlayingSequence = false;
        window.startSequenceGame = () => {
            document.getElementById('btn-start-seq').style.display = 'none';
            gameSequence = []; playerSequence = []; isPlayingSequence = false;
            document.getElementById('seq-status').innerText = "Observe a sequ√™ncia...";
            addToSequence();
        };

        function addToSequence() {
            gameSequence.push(Math.floor(Math.random() * 4));
            playSequence();
        }

        function playSequence() {
            isPlayingSequence = false; let i = 0;
            const interval = setInterval(() => {
                lightUpBtn(gameSequence[i]); i++;
                if (i >= gameSequence.length) {
                    clearInterval(interval);
                    setTimeout(() => {
                        isPlayingSequence = true; playerSequence = [];
                        document.getElementById('seq-status').innerText = "Sua vez! Repita.";
                    }, 500);
                }
            }, 800);
        }

        function lightUpBtn(id) {
            const btn = document.getElementById(`btn-${id}`);
            btn.classList.add('active');
            setTimeout(() => btn.classList.remove('active'), 400);
        }

        window.handleSeqInput = (id) => {
            if (!isPlayingSequence) return;
            lightUpBtn(id); playerSequence.push(id);
            if (playerSequence[playerSequence.length - 1] !== gameSequence[playerSequence.length - 1]) {
                document.getElementById('seq-status').innerText = "Ops! Errou. Tente de novo!";
                document.getElementById('seq-status').style.color = "#ff5555";
                setTimeout(() => { document.getElementById('seq-status').style.color = "#fff"; window.startSequenceGame(); }, 1500);
                return;
            }
            if (playerSequence.length === gameSequence.length) {
                if (gameSequence.length >= 3) {
                    document.getElementById('seq-status').innerText = "PARAB√âNS! ACESSO LIBERADO!";
                    document.getElementById('seq-status').style.color = "#00ff88";
                    setTimeout(() => {
                        document.getElementById('pc-view-sequence').classList.add('hidden');
                        document.getElementById('pc-view-social').classList.remove('hidden');
                    }, 1500);
                } else {
                    document.getElementById('seq-status').innerText = "Muito bem! Pr√≥xima rodada...";
                    isPlayingSequence = false; setTimeout(addToSequence, 1000);
                }
            }
        };

        // --- UI GERAL E PC ---
        window.checkPassword = () => {
            const pass = document.getElementById('pc-pass-input').value;
            const feedback = document.getElementById('pass-feedback');
            const ok = pass.length >= 8 && /[A-Z]/.test(pass) && /[0-9]/.test(pass) && /[!@#$%^&*]/.test(pass);
            if (ok) {
                feedback.style.color = "#00ff88"; feedback.innerText = "SENHA SEGURA!";
                setTimeout(() => {
                    document.getElementById('pc-view-login').classList.add('hidden');
                    document.getElementById('pc-view-sequence').classList.remove('hidden');
                    document.getElementById('btn-start-seq').style.display = 'block';
                }, 1500);
            } else {
                feedback.style.color = "#ff5555"; feedback.innerText = "Senha fraca! Use Letras, N√∫meros e S√≠mbolos.";
            }
        };

        window.applyCustomization = () => {
            const newName = document.getElementById('custom-name').value;
            if (newName) playerState.name = newName;
            playerState.backpackColor = parseInt(document.getElementById('custom-backpack-color').value.replace('#', ''), 16);
            playerState.hasHelmet = document.getElementById('custom-helmet-toggle').checked;
            playerState.helmetColor = parseInt(document.getElementById('custom-helmet-color').value.replace('#', ''), 16);
            
            if (player && player.userData.parts) {
                if (player.userData.parts.backpack) player.userData.parts.backpack.material.color.setHex(playerState.backpackColor);
                if (player.userData.parts.helmet) {
                    player.userData.parts.helmet.visible = playerState.hasHelmet;
                    player.userData.parts.helmet.material.color.setHex(playerState.helmetColor);
                }
            }
            alert("Identidade Salva!");
            if (missionProgress === 1) { missionProgress = 2; updateHUD("Fale com a Agente J√∫lia", "#d500f9"); }
            closePC();
        };

        window.reportFakeNews = () => {
            alert("VOC√ä PEGOU O GOLPISTA! Bom trabalho!");
            closePC();
            startDialog("COMANDANTE", ["Excelente, Agente " + playerState.name + "!", "Voc√™ n√£o caiu no golpe do Robux Gr√°tis.", "Fale com o Rob√¥ Fair Play antes de sair."]);
            missionProgress = 5;
            updateHUD("Fale com o Rob√¥ Fair Play", "#00ff88");
        };

        window.closePC = () => { document.getElementById('computer-overlay').style.display = 'none'; };
        window.goToSelect = () => { document.getElementById('screen-menu').classList.add('hidden'); document.getElementById('screen-select').classList.remove('hidden'); };
        window.goToCredits = () => { document.getElementById('screen-menu').classList.add('hidden'); document.getElementById('screen-credits').classList.remove('hidden'); };
        window.goToMenu = () => { document.getElementById('screen-credits').classList.add('hidden'); document.getElementById('screen-select').classList.add('hidden'); document.getElementById('screen-menu').classList.remove('hidden'); };
        window.selectAgent = (id) => {
            selectedAgentId = id;
            document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('agent-' + id).classList.add('selected');
            const btn = document.getElementById('btn-start-game');
            btn.style.opacity = '1'; btn.style.pointerEvents = 'auto'; btn.style.background = '#ffd54f'; btn.style.color = '#000';
        };
        window.launchGame = () => {
            document.getElementById('screen-select').classList.add('hidden');
            document.getElementById('game-container').style.visibility = 'visible';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('dialog-box').onclick = advanceDialog;
            initGame();
        };

        // --- THREE.JS ENGINE ---
        function initGame() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(CONFIG.colors.background);
            scene.fog = new THREE.FogExp2(CONFIG.colors.fog, 0.02);
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 35, 40); camera.lookAt(0, 0, 0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('game-container').appendChild(renderer.domElement);

            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.2; bloomPass.strength = 1.2; bloomPass.radius = 0.5;
            composer = new EffectComposer(renderer); composer.addPass(renderScene); composer.addPass(bloomPass);

            const ambient = new THREE.AmbientLight(0xffffff, 0.3); scene.add(ambient);
            const lights = [[-10, 15, -10, 0x00eaff], [10, 15, 10, 0xff00ff]].forEach(l => {
                const light = new THREE.PointLight(l[3], 1, 40); light.position.set(l[0], l[1], l[2]); scene.add(light);
            });
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6); dirLight.position.set(0, 30, 15); dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048; scene.add(dirLight);

            clock = new THREE.Clock();
            createTextures();
            loadScene("LOBBY");
            createPlayer(selectedAgentId);
            setupInputs();
            animate();
            startDialog("SISTEMA", ["Bem-vindo, Recruta!", "Sua miss√£o √© aprender a se defender na internet.", "Fale com o Comandante Motta para come√ßar."]);
        }

        function createTextures() {
            const ctx = document.createElement('canvas').getContext('2d');
            const createTex = (w, h, drawFn) => { ctx.canvas.width = w; ctx.canvas.height = h; drawFn(ctx); const t = new THREE.CanvasTexture(ctx.canvas); t.magFilter = THREE.NearestFilter; t.wrapS = t.wrapT = THREE.RepeatWrapping; return t; };
            
            wallTextureBase = createTex(512, 512, (c) => {
                c.fillStyle = '#1f3b51'; c.fillRect(0,0,512,512); c.fillStyle = '#3e6582';
                for(let y=0; y<8; y++) for(let x=-1; x<4; x++) c.fillRect((x*128)+(y%2?0:64)+2, (y*64)+2, 124, 60);
            });
            floorTextureBase = createTex(512, 512, (c) => {
                c.fillStyle = '#5a7d9a'; c.fillRect(0,0,256,256); c.fillRect(256,256,256,256);
                c.fillStyle = '#34566d'; c.fillRect(256,0,256,256); c.fillRect(0,256,256,256);
            });
            floorTextureBase.repeat.set(10,10);
            
            doorTextureBase = createTex(256, 512, (c) => {
                c.fillStyle = '#222'; c.fillRect(0,0,256,512);
                c.fillStyle = '#00eaff'; c.fillRect(126,0,4,512);
                c.strokeStyle = '#444'; c.lineWidth = 10;
                for(let i=0; i<600; i+=40) { c.beginPath(); c.moveTo(0,i); c.lineTo(256, i+256); c.stroke(); }
            });

            carpetTexture = createTex(512, 512, (c) => {
                c.fillStyle = '#4a148c'; c.fillRect(0,0,512,512);
                for(let i=0; i<1000; i++) { c.fillStyle = Math.random()>0.5?'#6a1b9a':'#38006b'; c.fillRect(Math.random()*512, Math.random()*512, 4, 4); }
            });
        }

        function clearLevel() {
            levelObjects.forEach(obj => scene.remove(obj));
            markers.forEach(m => scene.remove(m));
            levelObjects = []; obstacles = []; interactables = []; floors = []; markers = [];
        }

        function loadScene(sceneName) {
            document.getElementById('transition-screen').style.display = 'flex';
            setTimeout(() => {
                clearLevel(); currentLevel = sceneName;
                if (sceneName === "LOBBY") createLobbyLevel();
                else if (sceneName === "CYBER_OPS") createRoomLevel();
                document.getElementById('transition-screen').style.display = 'none';
            }, 500);
        }

        // --- CRIA√á√ÉO DE CEN√ÅRIOS ---
        function createLobbyLevel() {
            createFloor(0, 0, 16, 30, floorTextureBase);
            createFloor(-16, -1.5, 16, 30, carpetTexture);
            createFloor(16, -1.5, 16, 30, carpetTexture);
            
            // Rampas F√≠sicas
            const r1 = new THREE.Mesh(new THREE.BoxGeometry(4, 0.2, 6), new THREE.MeshBasicMaterial({visible:false})); 
            r1.position.set(-8, -0.75, 0); r1.rotation.z = 0.4; 
            scene.add(r1); levelObjects.push(r1); floors.push(r1);

            const r2 = new THREE.Mesh(new THREE.BoxGeometry(4, 0.2, 6), new THREE.MeshBasicMaterial({visible:false})); 
            r2.position.set(8, -0.75, 0); r2.rotation.z = -0.4; 
            scene.add(r2); levelObjects.push(r2); floors.push(r2);

            // Rampas Visuais
            const rvL = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, 6), new THREE.MeshStandardMaterial({color: 0x444})); 
            rvL.position.set(-8, -0.75, 0); rvL.rotation.z = 0.5; 
            scene.add(rvL); levelObjects.push(rvL);

            const rvR = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, 6), new THREE.MeshStandardMaterial({color: 0x444})); 
            rvR.position.set(8, -0.75, 0); rvR.rotation.z = -0.5; 
            scene.add(rvR); levelObjects.push(rvR);

            // Paredes
            createWall(0, 3, -15, 48, 8, 1); createWall(0, 3, 15, 48, 8, 1);
            createWall(-24, 3, 0, 1, 8, 30); createWall(24, 3, 0, 1, 8, 30);
            createWall(-8, 1, 9, 0.5, 5, 12); createWall(-8, 1, -9, 0.5, 5, 12);
            createWall(8, 1, 9, 0.5, 5, 12); createWall(8, 1, -9, 0.5, 5, 12);

            // Objetos
            const desk = new THREE.Mesh(new THREE.CylinderGeometry(3, 2, 1.2, 8), new THREE.MeshStandardMaterial({ color: 0x111 }));
            desk.position.set(0, 0.6, 0); scene.add(desk); levelObjects.push(desk); addCollisionBox(0, 0.6, 0, 3, 1.2, 3);
            
            const globe = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), new THREE.MeshBasicMaterial({ color: 0x00eaff, wireframe: true }));
            globe.position.set(0, 2.5, 0); scene.add(globe); levelObjects.push(globe);
            
            const pcHit = new THREE.Mesh(new THREE.BoxGeometry(4,4,4), new THREE.MeshBasicMaterial({visible:false}));
            pcHit.position.set(0,1,0); pcHit.userData = { isInteractable:true, type:"PC_CUSTOM", name:"Personaliza√ß√£o" };
            scene.add(pcHit); levelObjects.push(pcHit); interactables.push(pcHit);

            createDoor(0, 0, -14.5, "CYBER_OPS", 0);

            createNPC(-19, -1.5, CONFIG.colors.commander, "Comandante Motta", null);
            createNPC(16, -1.5, CONFIG.colors.npc, "Agente J√∫lia", null);
            
            // M√≥veis com colis√£o corrigida
            createChair(-20, -1.5, -5, Math.PI/2);
            createTable(-22, -1.5, -5, Math.PI/2);
            
            createNPC(-5, 0, 0xffff00, "Agente Blindado", ["Minha senha √© t√£o forte que nem eu lembro!"]);
            createTipTotem(-10, 0, 5, "Dica #1: N√£o fale com estranhos!");
            createTipTotem(10, 0, 5, "Dica #2: N√£o clique em links suspeitos!");

            if(player) player.position.set(0,0,5);
        }

        function createRoomLevel() {
            createFloor(0, 0, 30, 20, floorTextureBase);
            createWall(0, 4, -10, 30, 8, 1); createWall(0, 4, 10, 30, 8, 1);
            createWall(15, 4, 0, 1, 8, 20); createWall(-15, 4, 0, 1, 8, 20);
            
            createDoor(-14.5, 0, 0, "LOBBY", Math.PI/2);

            createServerRack(5, -8, 0); createServerRack(10, -8, 0);
            createServerRack(5, 8, Math.PI); createServerRack(10, 8, Math.PI);

            const desk = new THREE.Mesh(new THREE.BoxGeometry(6, 1.5, 3), new THREE.MeshStandardMaterial({ color: 0x001133 }));
            desk.position.set(10, 0.75, 0); scene.add(desk); levelObjects.push(desk); addCollisionBox(10, 0.75, 0, 6, 1.5, 3);
            
            const screen = new THREE.Mesh(new THREE.PlaneGeometry(2, 1), new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide }));
            screen.position.set(10, 2.5, 0); scene.add(screen); levelObjects.push(screen);
            
            const pcHit = new THREE.Mesh(new THREE.BoxGeometry(4,4,4), new THREE.MeshBasicMaterial({visible:false}));
            pcHit.position.set(10,1.5,0); pcHit.userData = { isInteractable:true, type:"PC_MISSION", name:"Terminal de Miss√£o" };
            scene.add(pcHit); levelObjects.push(pcHit); interactables.push(pcHit);

            createNPC(6, 0, 0xff0055, "Capit√£ Dados", null);
            createNPC(0, -5, 0x0000ff, "Rob√¥ Fair Play", null);

            const tableX = -5, tableZ = 5;
            createTable(tableX, 0, tableZ, 0);
            createChair(tableX, 0, tableZ + 1.5, Math.PI);
            createChair(tableX, 0, tableZ - 1.5, 0);
            createChair(tableX + 2, 0, tableZ, -Math.PI/2);
            createChair(tableX - 2, 0, tableZ, Math.PI/2);

            if(player) { player.position.set(-8, 0, 0); player.rotation.y = -Math.PI/2; }
        }

        // --- MARCADORES DE MISS√ÉO ---
        function createQuestMarker(target) {
            const g = new THREE.Group();
            const cone = new THREE.Mesh(new THREE.ConeGeometry(0.3, 0.8, 8), new THREE.MeshBasicMaterial({color: 0xffff00, emissive: 0xffff00}));
            cone.rotation.z = Math.PI; cone.position.y = 0;
            const ball = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color: 0xffff00, emissive: 0xffff00}));
            ball.position.y = -0.6;
            g.add(cone); g.add(ball);
            
            // Posiciona acima do alvo
            const pos = new THREE.Vector3();
            target.getWorldPosition(pos);
            g.position.set(pos.x, pos.y + 3.5, pos.z);
            
            scene.add(g); markers.push(g);
            
            // Anima√ß√£o
            const anim = () => { 
                if(g && g.parent) { 
                    g.rotation.y += 0.05; 
                    g.position.y = pos.y + 3.5 + Math.sin(Date.now()*0.005)*0.2; 
                    requestAnimationFrame(anim); 
                } 
            };
            anim();
        }

        function updateMarkers() {
            markers.forEach(m => scene.remove(m)); markers = [];
            let targetName = "";
            
            if (currentLevel === "LOBBY") {
                if (missionProgress === 0) targetName = "Comandante Motta";
                else if (missionProgress === 1) targetName = "Personaliza√ß√£o";
                else if (missionProgress === 2) targetName = "Agente J√∫lia";
                else if (missionProgress === 5) targetName = "Comandante Motta"; // Reportar final
            } else if (currentLevel === "CYBER_OPS") {
                if (missionProgress === 3) targetName = "Capit√£ Dados";
                else if (missionProgress === 4) targetName = "Terminal de Miss√£o";
                else if (missionProgress === 5) targetName = "Rob√¥ Fair Play";
            }

            if(targetName) {
                const target = interactables.find(i => i.userData.name === targetName);
                if(target) createQuestMarker(target);
            }
        }

        // --- OBJETOS 3D ---
        function createFloor(x, y, w, h, tex) {
            const m = new THREE.Mesh(new THREE.PlaneGeometry(w, h), new THREE.MeshStandardMaterial({ map: tex, roughness: 0.5 }));
            m.rotation.x = -Math.PI/2; m.position.set(x, y, 0); m.receiveShadow = true;
            scene.add(m); levelObjects.push(m); floors.push(m);
        }

        function createWall(x, y, z, w, h, d) {
            const m = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshStandardMaterial({ map: wallTextureBase }));
            m.position.set(x, y, z); m.castShadow = true; m.receiveShadow = true;
            scene.add(m); levelObjects.push(m); addCollisionBox(x, y, z, w, h, d);
        }

        function createServerRack(x, z, rot) {
            const g = new THREE.Group();
            const rack = new THREE.Mesh(new THREE.BoxGeometry(3,6,2), new THREE.MeshStandardMaterial({color:0x111}));
            rack.position.y = 3; g.add(rack);
            for(let i=0; i<5; i++) {
                const l = new THREE.Mesh(new THREE.PlaneGeometry(2.5, 0.2), new THREE.MeshBasicMaterial({color:0x00ff00}));
                l.position.set(0, 1+i, 1.01); g.add(l);
            }
            g.position.set(x,0,z); g.rotation.y = rot;
            scene.add(g); levelObjects.push(g); addCollisionBox(x, 0, z, 3, 6, 2);
        }

        function createChair(x, y, z, rot) {
            const g = new THREE.Group();
            const seat = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.2, 1.2), new THREE.MeshStandardMaterial({color:0x333}));
            seat.position.y = 1; g.add(seat);
            const leg = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 1), new THREE.MeshStandardMaterial({color:0x888}));
            leg.position.y = 0.5; g.add(leg);
            const back = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.5, 0.2), new THREE.MeshStandardMaterial({color:0x333}));
            back.position.set(0, 1.8, -0.5); g.add(back);
            const neon = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1, 0.22), new THREE.MeshBasicMaterial({color:0x00eaff}));
            neon.position.set(0, 1.8, -0.5); g.add(neon);

            g.position.set(x, y, z); g.rotation.y = rot;
            scene.add(g); levelObjects.push(g); addCollisionBox(x, y, z, 1.5, 2, 1.5);
        }

        function createTable(x, y, z, rot) {
            const g = new THREE.Group();
            const top = new THREE.Mesh(new THREE.BoxGeometry(4, 0.2, 2.5), new THREE.MeshStandardMaterial({color:0x222}));
            top.position.y = 1.5; g.add(top);
            const leg1 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.5, 2), new THREE.MeshStandardMaterial({color:0x555}));
            leg1.position.set(-1.8, 0.75, 0); g.add(leg1);
            const leg2 = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.5, 2), new THREE.MeshStandardMaterial({color:0x555}));
            leg2.position.set(1.8, 0.75, 0); g.add(leg2);
            
            g.position.set(x, y, z); g.rotation.y = rot;
            scene.add(g); levelObjects.push(g); addCollisionBox(x, y, z, 4, 1.5, 2.5);
        }

        function createTipTotem(x, y, z, text) {
            const g = new THREE.Group();
            const post = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 3), new THREE.MeshStandardMaterial({color:0x555}));
            post.position.y = 1.5; g.add(post);
            const box = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshBasicMaterial({color:0x00eaff, wireframe:true}));
            box.position.y = 3; g.add(box);
            const animateBox = () => { if(box) { box.rotation.y += 0.02; box.rotation.x += 0.01; requestAnimationFrame(animateBox); }};
            animateBox();
            g.position.set(x, y, z); g.userData = { isInteractable:true, name:"Dica de Seguran√ßa", dialogs:[text] };
            scene.add(g); levelObjects.push(g); interactables.push(g);
        }

        function createNPC(x, y, color, name, dialogs) {
            const g = new THREE.Group(); g.position.set(x, y, 0);
            const char = createHumanoid(color); char.position.y = 0; g.add(char);
            const ring = new THREE.Mesh(new THREE.RingGeometry(0.8, 0.9, 32), new THREE.MeshBasicMaterial({ color: color, side: THREE.DoubleSide })); 
            ring.rotation.x = -Math.PI/2; ring.position.y = 0.1; g.add(ring);
            const visor = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.15, 0.1), new THREE.MeshBasicMaterial({ color: 0xffffff })); 
            visor.position.set(0, 2.2, 0); g.add(visor);
            g.userData = { isInteractable: true, name: name, dialogs: dialogs };
            scene.add(g); levelObjects.push(g); interactables.push(g);
            addCollisionBox(x, y, 0, 2, 4, 2); // NPC Hitbox
        }

        function createHumanoid(color) {
            const c = new THREE.Group(); c.scale.set(1.4, 1.4, 1.4);
            const mats = { skin: new THREE.MeshStandardMaterial({ color: CONFIG.colors.skin }), shirt: new THREE.MeshStandardMaterial({ color: color, emissive: color, emissiveIntensity: 0.3 }), pants: new THREE.MeshStandardMaterial({ color: 0x111 }), pack: new THREE.MeshStandardMaterial({ color: CONFIG.colors.backpack }) };
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.7, 0.35), mats.shirt); body.position.y = 1.1; c.add(body);
            const headG = new THREE.Group(); headG.position.y = 1.7;
            headG.add(new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.45, 0.4), mats.skin));
            const eyeGeo = new THREE.BoxGeometry(0.08, 0.08, 0.05); const eyeMat = new THREE.MeshBasicMaterial({color:0});
            const lEye = new THREE.Mesh(eyeGeo, eyeMat); lEye.position.set(0.1, 0.05, 0.2); headG.add(lEye);
            const rEye = new THREE.Mesh(eyeGeo, eyeMat); rEye.position.set(-0.1, 0.05, 0.2); headG.add(rEye);
            const mouth = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.03, 0.05), eyeMat); mouth.position.set(0, -0.1, 0.2); headG.add(mouth);
            const helmet = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({color:0x00eaff})); 
            helmet.visible = false; headG.add(helmet); c.add(headG);
            const limbG = new THREE.BoxGeometry(0.15, 0.6, 0.15);
            const lArm = new THREE.Mesh(limbG, mats.shirt); lArm.position.set(0.4, 1.1, 0); c.add(lArm);
            const rArm = new THREE.Mesh(limbG, mats.shirt); rArm.position.set(-0.4, 1.1, 0); c.add(rArm);
            const legG = new THREE.BoxGeometry(0.2, 0.7, 0.2);
            const lLeg = new THREE.Mesh(legG, mats.pants); lLeg.position.set(0.15, 0.35, 0); c.add(lLeg);
            const rLeg = new THREE.Mesh(legG, mats.pants); rLeg.position.set(-0.15, 0.35, 0); c.add(rLeg);
            const pack = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.5, 0.25), mats.pack); pack.position.set(0, 1.15, -0.3); c.add(pack);
            c.userData.parts = { body, head: headG, leftArm: lArm, rightArm: rArm, leftLeg: lLeg, rightLeg: rLeg, backpack: pack, helmet };
            return c;
        }

        function createDoor(x, y, z, target, rot) {
            const g = new THREE.Group(); g.position.set(x, y, z); g.rotation.y = rot;
            const f = new THREE.Mesh(new THREE.BoxGeometry(4.2, 6.2, 0.6), new THREE.MeshStandardMaterial({ color: 0x111, emissive: 0x00eaff, emissiveIntensity: 0.5 })); 
            f.position.y = 3; g.add(f);
            const d = new THREE.Mesh(new THREE.PlaneGeometry(3.5, 5.5), new THREE.MeshPhysicalMaterial({ color: 0x00eaff, metalness: 0.1, roughness: 0.1, transparent: true, opacity: 0.5, side: THREE.DoubleSide, emissive: 0x00eaff, emissiveIntensity: 0.2 })); 
            d.position.set(0, 3, 0); g.add(d);
            const h = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 2), new THREE.MeshBasicMaterial({ visible: false }));
            h.position.set(0, 3, 0); h.userData = { isInteractable: true, type: "DOOR", target: target }; g.add(h);
            scene.add(g); levelObjects.push(g); interactables.push(h);
        }

        function createPlayer(id) {
            player = createHumanoid(id === 2 ? CONFIG.colors.agent2 : CONFIG.colors.agent1);
            scene.add(player); playerBody = new THREE.Box3();
        }

        function handleInteraction(obj) {
            if (!obj) return;
            const data = obj.userData;
            let dialogs = data.dialogs || [];

            if (data.type === "DOOR") {
                if (data.target === "LOBBY") {
                    loadScene("LOBBY");
                    if (missionProgress === 5) { missionProgress = 6; updateHUD("Miss√£o Completa!", "#fff"); startDialog("SISTEMA", ["Parab√©ns! Voc√™ √© um expert em seguran√ßa!"]); }
                } else if (data.target === "CYBER_OPS") {
                    if (missionProgress >= 2) {
                        loadScene(data.target);
                        if(missionProgress < 3) { missionProgress = 3; updateHUD("Fale com Capit√£ Dados", "#ff0055"); startDialog("SISTEMA", ["Acesso autorizado. Fale com a Capit√£ Dados."]); }
                    } else startDialog("SISTEMA", ["Portal trancado. Fale com a Agente J√∫lia."]);
                }
                return;
            }

            if (data.type === "PC_CUSTOM") {
                document.getElementById('computer-overlay').style.display = 'flex';
                document.getElementById('pc-view-custom').classList.remove('hidden');
                document.getElementById('pc-view-login').classList.add('hidden');
                document.getElementById('pc-view-sequence').classList.add('hidden');
                document.getElementById('pc-view-social').classList.add('hidden');
                return;
            }

            if (data.type === "PC_MISSION") {
                if(missionProgress < 4) {
                    startDialog("SISTEMA", ["Acesso negado. Fale com a Capit√£ Dados primeiro!"]);
                } else {
                    document.getElementById('computer-overlay').style.display = 'flex';
                    document.getElementById('pc-view-login').classList.remove('hidden');
                    document.getElementById('pc-view-custom').classList.add('hidden');
                    document.getElementById('pc-view-sequence').classList.add('hidden');
                    document.getElementById('pc-view-social').classList.add('hidden');
                }
                return;
            }

            if (data.name === "Comandante Motta") {
                if(missionProgress === 0) {
                    dialogs = ["Bem-vindo! V√° ao Globo Central para criar seu uniforme."];
                    missionProgress = 1; updateHUD("Personalize seu Agente", "#00ff88");
                } else if (missionProgress === 6) {
                    dialogs = ["Orgulho da equipe! Continue protegendo seus amigos online."];
                }
            } else if (data.name === "Agente J√∫lia") {
                if(missionProgress === 2) {
                    dialogs = ["√ìtimo uniforme! O portal est√° aberto. Entre e procure a Capit√£ Dados."];
                }
            } else if (data.name === "Capit√£ Dados") {
                if(missionProgress === 3) {
                    dialogs = [
                        "Parado a√≠! Antes de usar o computador, preciso saber se voc√™ √© seguro.",
                        { question: "Algu√©m num jogo pediu seu endere√ßo. O que voc√™ faz?", options: [ { text: "Passo o endere√ßo", correct: false }, { text: "N√£o passo e aviso meus pais", correct: true } ] }
                    ];
                } else {
                    dialogs = ["Voc√™ j√° passou no teste! Pode usar o computador."];
                }
            } else if (data.name === "Rob√¥ Fair Play") {
                if(missionProgress === 5) {
                    dialogs = ["Vi que voc√™ denunciou o golpe. Muito bem!", "Lembre-se: Jogo bom √© jogo com respeito. Se algu√©m for chato, bloqueie!", "Agora pode voltar para o Lobby."];
                    updateHUD("Volte para o Lobby", "#fff");
                } else {
                    dialogs = ["Estou monitorando o respeito nas partidas. Sem xingamentos, ok?"];
                }
            }
            startDialog(data.name, dialogs);
            updateMarkers(); // Atualiza marcadores ap√≥s intera√ß√£o
        }

        function startDialog(name, texts) {
            if(isDialogOpen) return;
            isDialogOpen = true;
            document.getElementById('dialog-box').style.display = 'block';
            document.getElementById('npc-name').innerText = name;
            currentDialogQueue = [...texts];
            advanceDialog();
        }

        function updateHUD(txt, col) { 
            const h = document.getElementById('obj-text'); h.innerText = txt; h.style.color = col; h.style.textShadow = `0 0 10px ${col}`; 
            updateMarkers();
        }

        function setupInputs() {
            const onK = (k, v) => { if(['w','s','a','d','arrowup','arrowdown','arrowleft','arrowright'].includes(k.toLowerCase())) keys[k.toLowerCase().replace('arrow','').replace('key','')] = v; };
            document.addEventListener('keydown', e => { if(e.code==='Space'||e.code==='Enter') { const target = getNearestInteractable(); if(target) handleInteraction(target); } else onK(e.key, true); });
            document.addEventListener('keyup', e => onK(e.key, false));
            
            window.addEventListener('pointerdown', e => { if(!e.target.closest('.screen') && !e.target.closest('#joystick-zone')) { isMouseDown = true; dragStartX = e.clientX; isDraggingView = false; }});
            window.addEventListener('pointermove', e => { 
                if (e.buttons === 0) isMouseDown = false; // Safety check
                if(isMouseDown && Math.abs(e.clientX-dragStartX)>5) { isDraggingView = true; cameraAngle -= (e.clientX-dragStartX)*0.005; dragStartX = e.clientX; }
            });
            window.addEventListener('pointerup', e => { 
                if(e.target.closest('.pc-window') || e.target.closest('.screen') || e.target.closest('#dialog-box') || e.target.closest('#joystick-zone')) return;
                isMouseDown = false; 
                if(!isDraggingView) { const target = getNearestInteractable(); if(target) handleInteraction(target); }
                isDraggingView = false; 
            });
            window.addEventListener('pointerleave', () => { isMouseDown = false; isDraggingView = false; });
            
            const joy = document.getElementById('joystick-zone');
            if('ontouchstart' in window) {
                const m = nipplejs.create({ zone: joy, mode: 'static', position: { left: '50%', top: '50%' }, color: 'cyan' });
                m.on('move', (e, d) => joystickVec.set(Math.cos(d.angle.radian)*Math.min(d.force,1), 0, -Math.sin(d.angle.radian)*Math.min(d.force,1)));
                m.on('end', () => joystickVec.set(0,0,0));
            } else joy.style.display = 'none';
        }

        function getNearestInteractable() {
            let n = null, md = 5;
            interactables.forEach(o => { const d = player.position.distanceTo(o.getWorldPosition(new THREE.Vector3())); if(d<md) { n = o; md = d; } });
            return n;
        }

        function animate() {
            requestAnimationFrame(animate);
            if(player && clock) {
                const dt = clock.getDelta();
                if(!isDialogOpen) {
                    const m = new THREE.Vector3(0,0,0);
                    if(keys.w) m.z -= 1; if(keys.s) m.z += 1; if(keys.a) m.x -= 1; if(keys.d) m.x += 1;
                    if(joystickVec.lengthSq()>0) m.add(new THREE.Vector3(joystickVec.x, 0, -joystickVec.z));
                    
                    let groundY = 0;
                    // Corre√ß√£o de Flutua√ß√£o: Ignorar o pr√≥prio jogador no raycast
                    const rayOrigin = player.position.clone(); rayOrigin.y += 5;
                    groundRaycaster.set(rayOrigin, new THREE.Vector3(0, -1, 0));
                    const hits = groundRaycaster.intersectObjects(floors, false); // false = apenas os meshes do ch√£o
                    if(hits.length > 0) groundY = hits[0].point.y;

                    if(m.lengthSq()>0) {
                        m.normalize().applyAxisAngle(new THREE.Vector3(0,1,0), cameraAngle);
                        const np = player.position.clone().add(m.multiplyScalar(CONFIG.speed*dt));
                        const pBox = new THREE.Box3().setFromCenterAndSize(new THREE.Vector3(np.x, groundY + 1, np.z), new THREE.Vector3(0.7, 2, 0.7));
                        let col = false;
                        obstacles.forEach(o => { if(pBox.intersectsBox(o)) col = true; });
                        if(!col) {
                            player.position.copy(np); 
                            player.rotation.y = Math.atan2(m.x, m.z);
                            walkTime += dt * 12;
                            player.userData.parts.body.position.y = 1.1 + Math.sin(walkTime)*0.05;
                            player.userData.parts.leftLeg.rotation.x = -Math.sin(walkTime)*0.6;
                            player.userData.parts.rightLeg.rotation.x = Math.sin(walkTime)*0.6;
                        }
                    } else {
                         player.userData.parts.body.position.y = 1.1;
                         player.userData.parts.leftLeg.rotation.x = 0; player.userData.parts.rightLeg.rotation.x = 0;
                    }
                    
                    // Suaviza√ß√£o da altura
                    player.position.y += (groundY - player.position.y) * 0.2;
                }
                
                const co = new THREE.Vector3(Math.sin(cameraAngle)*25, 25, Math.cos(cameraAngle)*25);
                const tp = player.position.clone().add(co);
                camera.position.lerp(tp, 0.1); camera.lookAt(player.position);
                composer.render();
            }
        }

        window.addEventListener('resize', () => { 
            if (camera && renderer && composer) {
                camera.aspect = window.innerWidth / window.innerHeight; 
                camera.updateProjectionMatrix(); 
                renderer.setSize(window.innerWidth, window.innerHeight); 
                composer.setSize(window.innerWidth, window.innerHeight); 
            }
        });
    </script>
</body>
</html>