<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cyber Agentes - Opera√ß√£o Cyber Ops</title>

    <!-- Fontes -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Press+Start+2P&family=Roboto:wght@300;400;700&display=swap');

        /* --- ESTILOS GERAIS --- */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }

        #game-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            visibility: hidden;
            cursor: grab;
        }

        #game-container:active {
            cursor: grabbing;
        }

        /* --- UI --- */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #240b36 0%, #b40c9e 50%, #8314c3 100%);
            color: white;
            transition: opacity 0.5s;
            /* background-image: url('./assets/img/bg_app.png'); */
        }

        .hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 1rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #42026d;
            text-align: center;
            line-height: 1.5;
            color: #00ccff;
        }

        .btn {
            background: rgba(0, 0, 0, 0.6);
            color: #00eaff;
            border: 2px solid #00eaff;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-family: 'Rajdhani', sans-serif;
            font-weight: bold;
            margin: 10px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.4);
            transition: all 0.2s;
            text-transform: uppercase;
            backdrop-filter: blur(5px);
        }

        .btn:hover {
            transform: scale(1.1);
            background: #00eaff;
            color: #000;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.8);
        }

        .btn-secondary {
            border-color: #ff00ff;
            color: #ff00ff;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.4);
        }

        .btn-secondary:hover {
            background: #ff00ff;
            color: #fff;
            box-shadow: 0 0 30px rgba(255, 0, 255, 0.8);
        }

        .credits-content {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00eaff;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 600px;
            line-height: 1.6;
            font-family: 'Roboto', sans-serif;
            box-shadow: 0 0 20px rgba(0, 234, 255, 0.2);
        }

        .agent-selector {
            display: flex;
            gap: 20px;
            margin: 30px 0;
        }

        .agent-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #444;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            width: 180px;
        }

        .agent-card:hover {
            border-color: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .agent-card.selected {
            border-color: #ffd54f;
            background: rgba(255, 213, 79, 0.2);
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 0 25px #ffd54f;
        }

        #agent-1 .agent-icon {
            color: #00eaff;
            text-shadow: 0 0 15px #00eaff;
        }

        #agent-2 .agent-icon {
            color: #d500f9;
            text-shadow: 0 0 15px #d500f9;
        }

        .agent-icon {
            font-size: 4rem;
            margin-bottom: 10px;
            display: block;
        }

        #game-ui {
            display: none;
        }

        #mission-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(10, 10, 30, 0.9);
            border: 2px solid #00eaff;
            padding: 15px;
            width: 280px;
            color: #fff;
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.3);
            z-index: 10;
            border-radius: 10px;
            font-family: 'Rajdhani', sans-serif;
        }

        #mission-hud h4 {
            margin: 0 0 5px 0;
            color: #00eaff;
            text-transform: uppercase;
            font-size: 16px;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0, 234, 255, 0.3);
            padding-bottom: 5px;
        }

        #dialog-box {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 700px;
            background: rgba(10, 10, 40, 0.95);
            border: 2px solid #ff00ff;
            border-radius: 15px;
            padding: 20px;
            display: none;
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.4);
            z-index: 20;
            color: #fff;
        }

        #npc-name {
            font-weight: bold;
            color: #ff00ff;
            margin-bottom: 5px;
            display: block;
            font-size: 1.2rem;
            text-shadow: 0 0 5px #ff00ff;
        }

        #dialog-text {
            font-size: 1.1rem;
            line-height: 1.4;
        }

        #joystick-zone {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            z-index: 20;
        }

        #transition-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
            color: #00eaff;
            font-size: 2rem;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 0 0 10px #00eaff;
        }

        /* --- COMPUTADOR --- */
        #computer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 60;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .pc-window {
            width: 800px;
            height: 600px;
            background: #0d0d1a;
            border: 2px solid #00eaff;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(0, 234, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-family: 'Roboto', sans-serif;
            position: relative;
        }

        .pc-header {
            background: linear-gradient(90deg, #00eaff 0%, #0077ff 100%);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #000;
            font-weight: bold;
            border-bottom: 1px solid #00eaff;
        }

        .close-btn {
            background: #ff0055;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            text-align: center;
            line-height: 25px;
            cursor: pointer;
            font-size: 14px;
        }

        .pc-content {
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #00eaff;
            background: repeating-linear-gradient(0deg,
                    rgba(0, 234, 255, 0.05) 0px,
                    rgba(0, 234, 255, 0.05) 1px,
                    transparent 1px,
                    transparent 20px);
            overflow-y: auto;
        }

        /* Tela de Login */
        .login-form input {
            padding: 15px;
            width: 300px;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 2px solid #00eaff;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            font-size: 16px;
            outline: none;
        }

        .password-feedback {
            font-size: 14px;
            margin-top: 15px;
            color: #ff5555;
            min-height: 20px;
            text-shadow: 0 0 5px rgba(255, 85, 85, 0.5);
        }

        /* Puzzle de Mem√≥ria */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .memory-card {
            width: 80px;
            height: 80px;
            background: #1a1a2e;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            cursor: pointer;
            border-radius: 10px;
            transition: transform 0.2s, border-color 0.2s;
        }

        .memory-card:hover {
            border-color: #00eaff;
            box-shadow: 0 0 10px #00eaff;
        }

        .memory-card.flipped {
            background: #00eaff;
            color: #000;
            border-color: #fff;
        }

        .memory-card.matched {
            background: #00ff88;
            border-color: #00ff88;
            opacity: 0.8;
            pointer-events: none;
        }

        /* Rede Social Falsa */
        .social-feed {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: #eef2f5;
            color: #333;
            padding: 20px;
        }

        .post {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #ddd;
        }

        .post-header {
            font-weight: bold;
            margin-bottom: 5px;
            color: #1877f2;
            display: flex;
            align-items: center;
        }

        .fake-news-btn {
            background: #ff0055;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 0, 85, 0.4);
            transition: transform 0.2s;
        }

        .fake-news-btn:hover {
            transform: scale(1.05);
        }

        /* --- NOVA UI: CUSTOMIZA√á√ÉO DE AGENTE --- */
        .custom-interface {
            width: 100%;
            max-width: 600px;
            background: rgba(13, 13, 26, 0.9);
            border: 1px solid #00eaff;
            box-shadow: 0 0 30px rgba(0, 234, 255, 0.2), inset 0 0 20px rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .custom-interface h3 {
            margin: 0 0 25px 0;
            color: #fff;
            font-size: 1.8rem;
            text-shadow: 0 0 10px #00eaff;
            letter-spacing: 2px;
            border-bottom: 2px solid #00eaff;
            padding-bottom: 10px;
            width: 100%;
            text-align: center;
        }

        .custom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            margin-bottom: 30px;
        }

        .custom-section {
            background: rgba(0, 234, 255, 0.05);
            border: 1px solid rgba(0, 234, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .custom-section label {
            font-size: 0.9rem;
            color: #00eaff;
            margin-bottom: 10px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* Input de Texto Estilizado */
        .cyber-input {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #555;
            border-bottom: 2px solid #00eaff;
            color: #fff;
            padding: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.1rem;
            outline: none;
            transition: 0.3s;
        }

        .cyber-input:focus {
            border-color: #fff;
            background: rgba(0, 234, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 234, 255, 0.2);
        }

        /* Container de Cor */
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            background: none;
            padding: 0;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 2px solid #fff;
            border-radius: 50%;
        }

        /* Toggle Switch Futurista */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border: 1px solid #555;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 0 5px #fff;
        }

        input:checked + .slider {
            background-color: #00eaff;
            border-color: #00eaff;
            box-shadow: 0 0 15px #00eaff;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
            background-color: #000;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            width: 100%;
            justify-content: center;
        }

        .cyber-btn {
            background: #00eaff;
            color: #000;
            border: none;
            font-weight: bold;
            padding: 12px 30px;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }
        .cyber-btn:hover {
            background: #fff;
            box-shadow: 0 0 20px #00eaff;
        }

        .cyber-btn-sec {
            background: transparent;
            color: #ff0055;
            border: 1px solid #ff0055;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }
        .cyber-btn-sec:hover {
            background: #ff0055;
            color: #fff;
            box-shadow: 0 0 20px #ff0055;
        }

    </style>

    <!-- Scripts -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
</head>

<body>

    <div id="screen-menu" class="screen">
        <div>
            <img src="./assets/img/logo_cyber_agentes.png" width="350" />
        </div>
        <h1>Aventura digital</h1>
        <!-- <p style="letter-spacing: 2px; margin-bottom: 40px; color: #00eaff; text-shadow: 0 0 5px #00eaff;">AVENTURA
            DIGITAL</p> -->
        <div>
            <button class="btn" onclick="goToSelect()">INICIAR</button>
            <button class="btn btn-secondary" onclick="goToCredits()">CR√âDITOS</button>
        </div>
    </div>

    <div id="screen-credits" class="screen hidden">
        <h2>EQUIPE & CR√âDITOS</h2>
        <div class="credits-content">
            <p><strong>Desenvolvimento:</strong> Equipe Cyber Agentes</p>
            <p><strong>Arte & Design:</strong> Baseado em Cyberpunk Infantil</p>
            <p><strong>Agradecimentos:</strong> A todos os mentores e professores.</p>
            <br>
            <p style="font-size: 0.9em; font-style: italic; color: #ff00ff;">"Protegendo o futuro, um pixel de cada
                vez."</p>
        </div>
        <button class="btn btn-secondary" onclick="goToMenu()" style="margin-top: 30px;">VOLTAR</button>
    </div>

    <div id="screen-select" class="screen hidden">
        <h2>ESCOLHA SEU AVATAR</h2>
        <div class="agent-selector">
            <div class="agent-card" id="agent-1" onclick="selectAgent(1)">
                <div class="agent-icon">ü§ñ</div>
                <h3 style="color: #fff;">AGENTE 01</h3>
                <small style="color: #00eaff;">Estilo: T√°tico Cyber</small>
                <p style="font-size: 12px; margin-top: 5px; color: #aaa;">Mochila Azul</p>
            </div>
            <div class="agent-card" id="agent-2" onclick="selectAgent(2)">
                <div class="agent-icon">üëæ</div>
                <h3 style="color: #fff;">AGENTE 02</h3>
                <small style="color: #d500f9;">Estilo: Hacker Neon</small>
                <p style="font-size: 12px; margin-top: 5px; color: #aaa;">Mochila Roxa</p>
            </div>
        </div>
        <button id="btn-start-game" class="btn" style="opacity: 0.5; pointer-events: none;"
            onclick="launchGame()">ENTRAR NA REDE</button>
        <br>
        <button class="btn btn-secondary" style="font-size: 1rem; padding: 10px 20px;"
            onclick="goToMenu()">VOLTAR</button>
    </div>

    <div id="game-container"></div>
    <div id="transition-screen">CARREGANDO MUNDO...</div>

    <!-- Interface Computador -->
    <div id="computer-overlay">
        <div class="pc-window">
            <div class="pc-header">
                <span>üîí CyberOS Kids - Acesso Seguro</span>
                <span class="close-btn" onclick="closePC()">X</span>
            </div>
            
            <!-- 1. Customiza√ß√£o (UI Melhorada) -->
            <div class="pc-content hidden" id="pc-view-custom" style="padding: 0;">
                <div class="custom-interface">
                    <h3>CONFIGURA√á√ÉO DE AGENTE</h3>
                    
                    <div class="custom-grid">
                        <!-- Nome -->
                        <div class="custom-section">
                            <label>IDENTIDADE (NOME)</label>
                            <input type="text" id="custom-name" placeholder="Digite seu codinome..." class="cyber-input">
                        </div>
                        
                        <!-- Mochila -->
                        <div class="custom-section">
                            <label>COR DA MOCHILA</label>
                            <div class="color-picker-container">
                                <input type="color" id="custom-backpack-color" value="#222222">
                                <span style="font-size: 0.8em; color: #aaa;">Clique para alterar</span>
                            </div>
                        </div>

                        <!-- Capacete Toggle -->
                        <div class="custom-section">
                            <label>CAPACETE T√ÅTICO</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="custom-helmet-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- Capacete Cor -->
                        <div class="custom-section">
                            <label>COR DO CAPACETE</label>
                            <div class="color-picker-container">
                                <input type="color" id="custom-helmet-color" value="#00eaff">
                                <span style="font-size: 0.8em; color: #aaa;">Clique para alterar</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn cyber-btn" onclick="applyCustomization()">SALVAR PERFIL</button>
                    </div>
                </div>
            </div>

            <!-- 2. Login (Para a Miss√£o) -->
            <div class="pc-content hidden" id="pc-view-login">
                <h3 style="margin-bottom: 20px; text-shadow: 0 0 10px #00eaff;">AUTENTICA√á√ÉO NECESS√ÅRIA</h3>
                <div class="login-form" style="text-align: center;">
                    <p style="font-size: 14px; margin-bottom: 10px; color: #aaa;">Crie uma senha forte (Mai√∫scula,
                        N√∫mero, S√≠mbolo).</p>
                    <input type="password" id="pc-pass-input" placeholder="Senha...">
                    <br>
                    <button class="btn" style="padding: 10px 30px; font-size: 1rem; border-radius: 25px;"
                        onclick="checkPassword()">ENTRAR</button>
                    <div class="password-feedback" id="pass-feedback"></div>
                </div>
            </div>

            <!-- 3. Puzzle (Para a Miss√£o) -->
            <div class="pc-content hidden" id="pc-view-puzzle">
                <h3 style="margin-bottom: 10px; color: #ff0055;">‚ö†Ô∏è FIREWALL ATIVO</h3>
                <p style="margin-bottom: 20px; font-size: 14px;">Conecte os √≠cones de seguran√ßa para desbloquear.</p>
                <div class="memory-grid" id="memory-game"></div>
            </div>

            <!-- 4. Rede Social (Para a Miss√£o) -->
            <div class="pc-content hidden" id="pc-view-os" style="padding: 0;">
                <div class="social-feed">
                    <div
                        style="background: #1877f2; color: white; padding: 15px; margin-bottom: 15px; font-weight: bold; border-radius: 8px;">
                        FaceLook Feed</div>

                    <div class="post">
                        <div class="post-header"> <span style="margin-right: 5px;">üò∫</span> Gatinhos Fofos</div>
                        <p>Olha que foto linda do meu gato dormindo! üí§ #bomdia</p>
                    </div>

                    <div class="post" style="border: 2px solid #ff0055;">
                        <div class="post-header" style="color: #d32f2f;">‚ö†Ô∏è URGENTE!!!</div>
                        <p style="font-weight: bold;">ATEN√á√ÉO! O governo vai proibir a internet amanh√£! Clique aqui para
                            impedir agora!!! üò±üö´</p>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Link suspeito: www.virus-gratis.com
                        </p>
                        <button class="fake-news-btn" onclick="reportFakeNews()">üö® DENUNCIAR FAKE NEWS</button>
                    </div>

                    <div class="post">
                        <div class="post-header"><span style="margin-right: 5px;">üè´</span> Escola Digital</div>
                        <p>As aulas de programa√ß√£o come√ßam semana que vem. N√£o percam!</p>
                    </div>
                </div>
            </div>

            <!-- 5. Rede Social (Para a Miss√£o) -->
            <div class="pc-content hidden" id="pc-view-social" style="padding: 0;">
                <div class="social-feed">
                    <div
                        style="background: #1877f2; color: white; padding: 15px; margin-bottom: 15px; font-weight: bold; border-radius: 8px;">
                        FaceLook Feed</div>

                    <div class="post">
                        <div class="post-header"> <span style="margin-right: 5px;">üò∫</span> Gatinhos Fofos</div>
                        <p>Olha que foto linda do meu gato dormindo! üí§ #bomdia</p>
                    </div>

                    <div class="post" style="border: 2px solid #ff0055;">
                        <div class="post-header" style="color: #d32f2f;">‚ö†Ô∏è URGENTE!!!</div>
                        <p style="font-weight: bold;">ATEN√á√ÉO! O governo vai proibir a internet amanh√£! Clique aqui para
                            impedir agora!!! üò±üö´</p>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Link suspeito: www.virus-gratis.com
                        </p>
                        <button class="fake-news-btn" onclick="reportFakeNews()">üö® DENUNCIAR FAKE NEWS</button>
                    </div>

                    <div class="post">
                        <div class="post-header"><span style="margin-right: 5px;">üè´</span> Escola Digital</div>
                        <p>As aulas de programa√ß√£o come√ßam semana que vem. N√£o percam!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-ui">
        <div id="mission-hud">
            <h4>MISS√ÉO ATUAL</h4>
            <div style="font-size: 14px; display: flex; align-items: center; margin-top: 8px;">
                <span style="color: #00eaff; margin-right: 8px; font-size: 18px;">‚û§</span>
                <span id="obj-text">Fale com o Comandante</span>
            </div>
        </div>

        <div id="dialog-box" onclick="advanceDialog()">
            <span id="npc-name">SISTEMA</span>
            <div id="dialog-text">...</div>
            <div style="text-align: right; color: #aaa; font-size: 12px; margin-top: 10px;">[ CLIQUE PARA CONTINUAR ]
            </div>
        </div>

        <div id="joystick-zone"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- CONFIGURA√á√ÉO VISUAL ---
        const CONFIG = {
            speed: 12, 
            colors: {
                background: 0x050510,
                fog: 0x100020,
                floorGrid: 0x220044,
                floorLine: 0x00eaff,
                wallBase: 0x111111,
                wallDetail: 0xff00ff,
                furniture: 0x222233,
                agent1: 0x00eaff,
                agent2: 0xd500f9,
                commander: 0xff6f00,
                npc: 0x00ff88,
                skin: 0xffdbac,
                backpack: 0x111111,
                doorFrame: 0x444444,
                neonLight: 0x00eaff // Cor extra para luzes
            }
        };

        // Vari√°veis Globais
        let scene, camera, renderer, clock, composer;
        let player, playerBody;
        let levelObjects = [];
        let obstacles = [];
        let interactables = [];
        let floors = [];

        let selectedAgentId = null;
        let missionProgress = 0;
        let currentLevel = "LOBBY";

        let isDialogOpen = false;
        let currentDialogQueue = [];

        // Estado do Jogador (Para personaliza√ß√£o)
        let playerState = {
            name: "Agente",
            hasHelmet: false,
            backpackColor: CONFIG.colors.backpack,
            helmetColor: 0x00eaff
        };

        let wallTextureBase, doorTextureBase, floorTextureBase, brickFloorTexture, carpetTexture;

        let keys = { w: false, a: false, s: false, d: false };
        let joystickVec = new THREE.Vector3();
        let cameraAngle = 0;
        let isDraggingView = false;
        let dragStartX = 0;
        let isMouseDown = false;
        let walkTime = 0;

        const raycaster = new THREE.Raycaster();
        const groundRaycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // --- LOGICA DO PC E UI ---
        window.checkPassword = () => {
            const pass = document.getElementById('pc-pass-input').value;
            const feedback = document.getElementById('pass-feedback');
            const hasUpper = /[A-Z]/.test(pass);
            const hasNumber = /[0-9]/.test(pass);
            const hasSpecial = /[!@#$%^&*]/.test(pass);
            const isLong = pass.length >= 8;

            if (isLong && hasUpper && hasNumber && hasSpecial) {
                feedback.style.color = "#00ff88";
                feedback.innerText = "ACESSO PERMITIDO! CARREGANDO...";
                setTimeout(() => {
                    document.getElementById('pc-view-login').classList.add('hidden');
                    document.getElementById('pc-view-puzzle').classList.remove('hidden');
                    startPuzzle();
                }, 1500);
            } else {
                feedback.style.color = "#ff5555";
                let msg = "‚ö†Ô∏è SENHA FRACA: ";
                if (!isLong) msg += "M√≠nimo 8 caracteres. ";
                else if (!hasUpper) msg += "Use uma Mai√∫scula. ";
                else if (!hasNumber) msg += "Use um N√∫mero. ";
                else if (!hasSpecial) msg += "Use um S√≠mbolo (!@#).";
                feedback.innerText = msg;
            }
        };

        let flippedCards = [];
        let matchedPairs = 0;
        const icons = ['üõ°Ô∏è', 'üëæ', 'üîë', 'üíæ'];

        window.startPuzzle = () => {
            const grid = document.getElementById('memory-game');
            grid.innerHTML = '';
            flippedCards = [];
            matchedPairs = 0;
            let deck = [...icons, ...icons];
            deck.sort(() => Math.random() - 0.5);
            deck.forEach((icon, index) => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.dataset.icon = icon;
                card.innerText = '?';
                card.onclick = () => flipCard(card);
                grid.appendChild(card);
            });
        };

        function flipCard(card) {
            if (flippedCards.length >= 2 || card.classList.contains('flipped') || card.classList.contains('matched')) return;
            card.classList.add('flipped');
            card.innerText = card.dataset.icon;
            flippedCards.push(card);
            if (flippedCards.length === 2) setTimeout(checkMatch, 800);
        }

        function checkMatch() {
            const [card1, card2] = flippedCards;
            if (card1.dataset.icon === card2.dataset.icon) {
                card1.classList.add('matched');
                card2.classList.add('matched');
                matchedPairs++;
                if (matchedPairs === 4) {
                    setTimeout(() => {
                        document.getElementById('pc-view-puzzle').classList.add('hidden');
                        document.getElementById('pc-view-social').classList.remove('hidden');
                    }, 500);
                }
            } else {
                card1.classList.remove('flipped');
                card1.innerText = '?';
                card2.classList.remove('flipped');
                card2.innerText = '?';
            }
            flippedCards = [];
        }

        // Fun√ß√£o de Aplicar Customiza√ß√£o
        window.applyCustomization = () => {
            const newName = document.getElementById('custom-name').value;
            const backpackHex = document.getElementById('custom-backpack-color').value;
            const hasHelmet = document.getElementById('custom-helmet-toggle').checked;
            const helmetHex = document.getElementById('custom-helmet-color').value;

            if(newName) playerState.name = newName;
            playerState.backpackColor = parseInt(backpackHex.replace('#', ''), 16);
            playerState.hasHelmet = hasHelmet;
            playerState.helmetColor = parseInt(helmetHex.replace('#', ''), 16);

            // Atualizar visual do Player
            if(player && player.userData.parts) {
                // Mochila
                if(player.userData.parts.backpack) {
                    player.userData.parts.backpack.material.color.setHex(playerState.backpackColor);
                }
                // Capacete
                if(player.userData.parts.helmet) {
                    player.userData.parts.helmet.visible = playerState.hasHelmet;
                    player.userData.parts.helmet.material.color.setHex(playerState.helmetColor);
                }
            }

            alert("Perfil Atualizado! Agora fale com a Agente J√∫lia.");
            if(missionProgress === 1) {
                missionProgress = 2;
                updateHUD("Fale com a Agente J√∫lia", "#d500f9");
            }
            closePC();
        };

        window.reportFakeNews = () => {
            alert("FAKE NEWS DETECTADA! Voc√™ salvou a rede!");
            document.getElementById('computer-overlay').style.display = 'none';
            startDialog("COMANDANTE", ["Excelente, Agente " + playerState.name + "!", "Amea√ßa neutralizada.", "Retorne √† base pela porta de teleporte."]);
            missionProgress = 5;
            updateHUD("Volte para o Lobby", "#00ff88");
        };

        window.closePC = () => {
            document.getElementById('computer-overlay').style.display = 'none';
        };

        // --- UI GERAL (MANTIDA) ---
        window.goToSelect = () => {
            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-select').classList.remove('hidden');
        };
        window.goToCredits = () => {
            document.getElementById('screen-menu').classList.add('hidden');
            document.getElementById('screen-credits').classList.remove('hidden');
        };
        window.goToMenu = () => {
            document.getElementById('screen-credits').classList.add('hidden');
            document.getElementById('screen-select').classList.add('hidden');
            document.getElementById('screen-menu').classList.remove('hidden');
        };
        window.selectAgent = (id) => {
            selectedAgentId = id;
            document.getElementById('agent-1').classList.remove('selected');
            document.getElementById('agent-2').classList.remove('selected');
            if (id === 1) document.getElementById('agent-1').classList.add('selected');
            if (id === 2) document.getElementById('agent-2').classList.add('selected');
            const btn = document.getElementById('btn-start-game');
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
            btn.style.background = '#ffd54f';
            btn.style.color = '#000';
            btn.style.boxShadow = '0 0 20px #ffd54f';
        };
        window.launchGame = () => {
            document.getElementById('screen-select').classList.add('hidden');
            document.getElementById('game-container').style.visibility = 'visible';
            document.getElementById('game-ui').style.display = 'block';
            initGame();
        };

        // --- TEXTURAS ORIGINAIS (Pixel Art / Canvas) ---
        function createFloorTileTexture() {
            const size = 512; const ctx = document.createElement('canvas').getContext('2d');
            ctx.canvas.width = size; ctx.canvas.height = size;
            ctx.fillStyle = '#5a7d9a'; ctx.fillRect(0, 0, size / 2, size / 2); ctx.fillRect(size / 2, size / 2, size / 2, size / 2);
            ctx.fillStyle = '#34566d'; ctx.fillRect(size / 2, 0, size / 2, size / 2); ctx.fillRect(0, size / 2, size / 2, size / 2);
            const t = new THREE.CanvasTexture(ctx.canvas); t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(10, 10); t.magFilter = THREE.NearestFilter; return t;
        }
        function createWallTileTexture() {
            const size = 512; const ctx = document.createElement('canvas').getContext('2d');
            ctx.canvas.width = size; ctx.canvas.height = size;
            ctx.fillStyle = '#1f3b51'; ctx.fillRect(0, 0, size, size); ctx.fillStyle = '#3e6582';
            const bw = size / 4, bh = size / 8, gap = 4;
            for (let y = 0; y < 8; y++) {
                const off = (y % 2 === 0) ? 0 : bw / 2;
                for (let x = -1; x < 4; x++) ctx.fillRect((x * bw) + off + gap / 2, (y * bh) + gap / 2, bw - gap, bh - gap);
            }
            const t = new THREE.CanvasTexture(ctx.canvas); t.wrapS = t.wrapT = THREE.RepeatWrapping; t.magFilter = THREE.NearestFilter; return t;
        }
        function createDoorTexture() {
            const size = 256; const ctx = document.createElement('canvas').getContext('2d');
            ctx.canvas.width = size; ctx.canvas.height = size * 2;
            ctx.fillStyle = '#222'; ctx.fillRect(0, 0, size, size * 2);
            ctx.fillStyle = '#00eaff'; ctx.fillRect(size / 2 - 2, 0, 4, size * 2);
            ctx.strokeStyle = '#444'; ctx.lineWidth = 10;
            for (let i = -size; i < size * 2; i += 40) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(size, i + size); ctx.stroke(); }
            ctx.fillStyle = '#d500f9'; ctx.fillRect(20, 20, size - 40, 30);
            return new THREE.CanvasTexture(ctx.canvas);
        }
        function createBrickFloorTexture() {
            const s = 512; const c = document.createElement('canvas').getContext('2d'); c.canvas.width = s; c.canvas.height = s;
            c.fillStyle = '#333'; c.fillRect(0, 0, s, s); c.fillStyle = '#444';
            const bw = s / 8, bh = s / 16, g = 2; for (let y = 0; y < 16; y++) { let o = (y % 2) * bw / 2; for (let x = -1; x < 8; x++) c.fillRect((x * bw) + o + g, (y * bh) + g, bw - g * 2, bh - g * 2); }
            const t = new THREE.CanvasTexture(c.canvas); t.wrapS = t.wrapT = THREE.RepeatWrapping; t.repeat.set(6, 6); t.magFilter = THREE.NearestFilter; return t;
        }
        function createCarpetTexture() {
            const s = 512; const c = document.createElement('canvas').getContext('2d'); c.canvas.width = s; c.canvas.height = s;
            c.fillStyle = '#4a148c'; c.fillRect(0, 0, s, s);
            for (let i = 0; i < 5000; i++) { c.fillStyle = Math.random() > 0.5 ? '#6a1b9a' : '#38006b'; c.fillRect(Math.random() * s, Math.random() * s, 2, 2); }
            return new THREE.CanvasTexture(c.canvas);
        }

        // --- GAME ENGINE (COM BLOOM INJETADO) ---
        function initGame() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.background);
            scene.fog = new THREE.FogExp2(CONFIG.colors.fog, 0.02);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 35, 40);
            camera.lookAt(0, 0, 0);

            // Renderizador
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.getElementById('game-container').appendChild(renderer.domElement);

            // --- BLOOM SETUP ---
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.2;
            bloomPass.strength = 1.2;
            bloomPass.radius = 0.5;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // Luzes
            const ambient = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambient);
            const blueLight = new THREE.PointLight(0x00eaff, 1, 40); blueLight.position.set(-10, 15, -10); scene.add(blueLight);
            const pinkLight = new THREE.PointLight(0xff00ff, 1, 40); pinkLight.position.set(10, 15, 10); scene.add(pinkLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6); dirLight.position.set(0, 30, 15); dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048; dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            clock = new THREE.Clock();

            // Texturas Originais
            wallTextureBase = createWallTileTexture();
            floorTextureBase = createFloorTileTexture();
            doorTextureBase = createDoorTexture();
            brickFloorTexture = createBrickFloorTexture();
            carpetTexture = createCarpetTexture();

            loadScene("LOBBY");
            createPlayer(selectedAgentId);
            setupInputs();

            animate();

            startDialog("SISTEMA", [
                "Agente Iniciado.",
                "Bem-vindo √† Central de Comando.",
                "Fale com o Comandante para iniciar."
            ]);
        }

        function clearLevel() {
            levelObjects.forEach(obj => scene.remove(obj));
            levelObjects = [];
            obstacles = [];
            interactables = [];
            floors = [];
        }

        function loadScene(sceneName) {
            const overlay = document.getElementById('transition-screen');
            overlay.style.display = 'flex';

            setTimeout(() => {
                clearLevel();
                currentLevel = sceneName;

                if (sceneName === "LOBBY") {
                    createLobbyLevel();
                    if (player) {
                        if (missionProgress >= 5) { player.position.set(0, 0, -12); player.rotation.y = Math.PI; }
                        else player.position.set(0, 0, 5);
                    }
                } else if (sceneName === "CYBER_OPS") { // NOVA SALA
                    createRoomLevel();
                    if (player) { player.position.set(-8, 0, 0); player.rotation.y = -Math.PI / 2; }
                }

                overlay.style.display = 'none';
            }, 500);
        }

        // --- FUN√á√ïES DE OBJETOS MELHORADOS ---
        
        function createHoloWindow(x, y, z, rotY) {
            const geo = new THREE.PlaneGeometry(6, 4);
            const mat = new THREE.MeshBasicMaterial({
                color: CONFIG.colors.neonLight,
                side: THREE.DoubleSide,
                transparent: true, opacity: 0.2,
                blending: THREE.AdditiveBlending,
                wireframe: true
            });
            const win = new THREE.Mesh(geo, mat);
            win.position.set(x, y, z);
            win.rotation.y = rotY;
            const light = new THREE.PointLight(CONFIG.colors.neonLight, 2, 15);
            light.position.set(x, y, z);
            scene.add(win); scene.add(light);
            levelObjects.push(win); levelObjects.push(light);
        }

        function createCyberBookshelf(x, z, rotY) {
            const group = new THREE.Group();
            const frame = new THREE.Mesh(new THREE.BoxGeometry(3, 5, 1), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            frame.position.y = 2.5; group.add(frame);
            const bookGeo = new THREE.BoxGeometry(0.2, 0.6, 0.8);
            for(let i=0; i<10; i++) {
                const isNeon = Math.random() > 0.6;
                const col = isNeon ? (Math.random() > 0.5 ? 0xff00ff : 0x00eaff) : 0x555555;
                const book = new THREE.Mesh(bookGeo, new THREE.MeshStandardMaterial({
                    color: col, 
                    emissive: isNeon ? col : 0x000000,
                    emissiveIntensity: 1.5 
                }));
                book.position.set((Math.random()-0.5)*2, Math.random()*4 + 0.5, 0.2);
                group.add(book);
            }
            group.position.set(x, 0, z); group.rotation.y = rotY;
            scene.add(group); levelObjects.push(group);
            addCollisionBox(frame, group.position);
        }

        // NOVO: Rack de Servidor Cyberpunk
        function createServerRack(x, z, rotY) {
            const group = new THREE.Group();
            // Rack Principal
            const rack = new THREE.Mesh(
                new THREE.BoxGeometry(3, 6, 2),
                new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.2 })
            );
            rack.position.y = 3;
            group.add(rack);

            // Luzes de Servidor
            for(let i=0; i<5; i++) {
                const lightStrip = new THREE.Mesh(
                    new THREE.PlaneGeometry(2.5, 0.2),
                    new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide })
                );
                lightStrip.position.set(0, 1 + i, 1.01);
                group.add(lightStrip);
            }

            group.position.set(x, 0, z);
            group.rotation.y = rotY;
            scene.add(group); levelObjects.push(group);
            addCollisionBox(rack, group.position);
        }

        // --- CEN√ÅRIOS ---
        function createLobbyLevel() {
            const floorCenter = new THREE.Mesh(new THREE.PlaneGeometry(16, 30), new THREE.MeshStandardMaterial({ map: floorTextureBase, roughness: 0.5 }));
            floorCenter.rotation.x = -Math.PI/2; floorCenter.receiveShadow=true; scene.add(floorCenter); levelObjects.push(floorCenter); floors.push(floorCenter);

            const floorLeft = new THREE.Mesh(new THREE.PlaneGeometry(16, 30), new THREE.MeshStandardMaterial({ map: carpetTexture, roughness: 0.8 }));
            floorLeft.rotation.x = -Math.PI/2; floorLeft.position.set(-16, -1.5, 0); floorLeft.receiveShadow=true; scene.add(floorLeft); levelObjects.push(floorLeft); floors.push(floorLeft);

            const floorRight = new THREE.Mesh(new THREE.PlaneGeometry(16, 30), new THREE.MeshStandardMaterial({ map: carpetTexture, roughness: 0.8 }));
            floorRight.rotation.x = -Math.PI/2; floorRight.position.set(16, -1.5, 0); floorRight.receiveShadow=true; scene.add(floorRight); levelObjects.push(floorRight); floors.push(floorRight);

            const r1 = new THREE.Mesh(new THREE.BoxGeometry(4, 0.2, 6), new THREE.MeshBasicMaterial({visible:false})); r1.position.set(-8, -0.75, 0); r1.rotation.z = 0.4; scene.add(r1); levelObjects.push(r1); floors.push(r1);
            const r2 = new THREE.Mesh(new THREE.BoxGeometry(4, 0.2, 6), new THREE.MeshBasicMaterial({visible:false})); r2.position.set(8, -0.75, 0); r2.rotation.z = -0.4; scene.add(r2); levelObjects.push(r2); floors.push(r2);
            const rampVisL = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, 6), new THREE.MeshStandardMaterial({color: 0x444})); rampVisL.position.set(-8, -0.75, 0); rampVisL.rotation.z = 0.5; scene.add(rampVisL); levelObjects.push(rampVisL);
            const rampVisR = new THREE.Mesh(new THREE.BoxGeometry(2, 0.2, 6), new THREE.MeshStandardMaterial({color: 0x444})); rampVisR.position.set(8, -0.75, 0); rampVisR.rotation.z = -0.5; scene.add(rampVisR); levelObjects.push(rampVisR);

            createWall(0, 3, -15, 48, 8, 1); createWall(0, 3, 15, 48, 8, 1);
            createWall(-24, 3, 0, 1, 8, 30); createWall(24, 3, 0, 1, 8, 30);
            createWall(-8, 1, 9, 0.5, 5, 12); createWall(-8, 1, -9, 0.5, 5, 12);
            createWall(8, 1, 9, 0.5, 5, 12); createWall(8, 1, -9, 0.5, 5, 12);

            createHoloWindow(-23.4, 4, 0, Math.PI/2);
            createHoloWindow(23.4, 4, 0, -Math.PI/2);

            const centralDesk = new THREE.Mesh(new THREE.CylinderGeometry(3, 2, 1.2, 8), new THREE.MeshStandardMaterial({ color: 0x111 }));
            centralDesk.position.set(0, 0.6, 0); scene.add(centralDesk); levelObjects.push(centralDesk); addCollisionBox(centralDesk);
            
            const holoGlobe = new THREE.Mesh(new THREE.SphereGeometry(1.5, 16, 16), new THREE.MeshBasicMaterial({ color: 0x00eaff, wireframe: true, emissive: 0x00eaff, emissiveIntensity: 0.5 }));
            holoGlobe.position.set(0, 2.5, 0); scene.add(holoGlobe); levelObjects.push(holoGlobe);
            const animateGlobe = () => { if (holoGlobe) holoGlobe.rotation.y += 0.01; requestAnimationFrame(animateGlobe); }; animateGlobe();

            // PC LOBBY: Apenas Customiza√ß√£o
            const pcHitbox = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), new THREE.MeshBasicMaterial({ visible: false }));
            pcHitbox.position.set(0, 1, 0); pcHitbox.userData = { isInteractable: true, name: "Terminal de Customiza√ß√£o", type: "PC_CUSTOM" };
            scene.add(pcHitbox); levelObjects.push(pcHitbox); interactables.push(pcHitbox);

            createWall(-16, 3, -15, 16, 8, 1); createWall(16, 3, -15, 16, 8, 1);
            createWall(-4, 3, -15, 4, 8, 1); createWall(4, 3, -15, 4, 8, 1);
            createDoor(0, 0, -14.5, "CYBER_OPS", 0);

            const table = new THREE.Mesh(new THREE.BoxGeometry(4, 1, 8), new THREE.MeshStandardMaterial({ color: 0x333 }));
            table.position.set(-16, -1.0, 0); scene.add(table); levelObjects.push(table); addCollisionBox(table);
            createCyberBookshelf(-23, -5, Math.PI/2);
            createNPC(-19, -1.5, CONFIG.colors.commander, "Comandante Motta", ["Acesse o Terminal Central para preparar seu equipamento."]);

            createProp('Sofa', 16, -13, -1.5);
            createCyberBookshelf(23, 5, -Math.PI/2);
            createNPC(16, -1.5, CONFIG.colors.npc, "Agente J√∫lia", ["Prepare-se e entre no Portal."]);
        }

        // NOVA SALA: CYBER OPS (SERVIDOR)
        function createRoomLevel() {
            // Piso Escuro Tecnol√≥gico
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(30, 20), new THREE.MeshStandardMaterial({ color: 0x050510, roughness: 0.2 }));
            floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true; scene.add(floor); levelObjects.push(floor); floors.push(floor);
            
            // Paredes Escuras
            createWall(0, 4, -10, 30, 8, 1); createWall(0, 4, 10, 30, 8, 1);
            createWall(15, 4, 0, 1, 8, 20); createWall(-15, 4, 0, 1, 8, 20);
            
            // Portal de Volta
            createDoor(-14.5, 0, 0, "LOBBY", Math.PI / 2);

            // Servidores (Cyberpunk)
            createServerRack(5, -8, 0);
            createServerRack(10, -8, 0);
            createServerRack(5, 8, Math.PI);
            createServerRack(10, 8, Math.PI);

            // Terminal de Miss√£o Principal
            const desk = new THREE.Mesh(new THREE.BoxGeometry(6, 1.5, 3), new THREE.MeshStandardMaterial({ color: 0x001133, emissive: 0x001133, emissiveIntensity: 0.2 }));
            desk.position.set(10, 0.75, 0); scene.add(desk); levelObjects.push(desk); addCollisionBox(desk);
            
            // Telas flutuantes
            const screen1 = new THREE.Mesh(new THREE.PlaneGeometry(2, 1), new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide }));
            screen1.position.set(10, 2.5, 0); scene.add(screen1); levelObjects.push(screen1);

            const pcHitbox = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), new THREE.MeshBasicMaterial({ visible: false }));
            pcHitbox.position.set(10, 1.5, 0); pcHitbox.userData = { isInteractable: true, name: "Terminal de Miss√£o", type: "PC_MISSION" };
            scene.add(pcHitbox); levelObjects.push(pcHitbox); interactables.push(pcHitbox);
        }

        function createProp(type, x, z, y = 1.5) {
            let yBase = 0; if (Math.abs(x) > 8) yBase = 1.5; if (y != yBase) yBase = y;
            if (type === 'Sofa') {
                const mesh = new THREE.Mesh(new THREE.BoxGeometry(6, 1, 2), new THREE.MeshStandardMaterial({ color: 0x550000 }));
                mesh.position.set(x, yBase + 0.5, z);
                const neon = new THREE.Mesh(new THREE.BoxGeometry(6.1, 0.1, 0.1), new THREE.MeshBasicMaterial({ color: 0xff00ff }));
                neon.position.y = 0.5; neon.position.z = 1;
                mesh.add(neon);
                scene.add(mesh); levelObjects.push(mesh); addCollisionBox(mesh);
            }
        }

        function createDoor(x, y, z, targetScene, rotationY = 0) {
            const group = new THREE.Group(); group.position.set(x, y, z); group.rotation.y = rotationY;
            const frame = new THREE.Mesh(new THREE.BoxGeometry(4.2, 6.2, 0.6), new THREE.MeshStandardMaterial({ color: 0x00eaff, emissive: 0x00eaff, emissiveIntensity: 0.5 }));
            frame.position.y = 3; group.add(frame);
            const doorGeo = new THREE.PlaneGeometry(3.5, 5.5); const doorMat = new THREE.MeshStandardMaterial({ map: doorTextureBase, emissive: 0x222222 });
            const door = new THREE.Mesh(doorGeo, doorMat); door.position.set(0, 3, 0.4); group.add(door);
            const hitBox = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 2), new THREE.MeshBasicMaterial({ visible: false }));
            hitBox.position.set(0, 3, 0); hitBox.userData = { isInteractable: true, name: "Portal", type: "DOOR", target: targetScene }; group.add(hitBox);
            scene.add(group); levelObjects.push(group); interactables.push(hitBox);
        }

        function createWall(x, y, z, w, h, d) {
            const geo = new THREE.BoxGeometry(w, h, d);
            const localTex = wallTextureBase.clone(); localTex.wrapS = THREE.RepeatWrapping; localTex.wrapT = THREE.RepeatWrapping; localTex.repeat.set(w * 0.25, h * 0.25); localTex.needsUpdate = true;
            const mat = new THREE.MeshStandardMaterial({ map: localTex, roughness: 0.8 });
            const wall = new THREE.Mesh(geo, mat); wall.position.set(x, y, z); wall.castShadow = true; wall.receiveShadow = true;
            scene.add(wall); levelObjects.push(wall); addCollisionBox(wall);
        }

        // --- PLAYER & NPC ---
        function createHumanoid(color, hasBackpack = true) {
            const character = new THREE.Group(); character.scale.set(1.4, 1.4, 1.4);
            const skinMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.skin });
            const shirtMat = new THREE.MeshStandardMaterial({ color: color, emissive: color, emissiveIntensity: 0.4 });
            const pantsMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
            const packMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.backpack });
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.7, 0.35), shirtMat); body.position.y = 1.1; character.add(body);
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.45, 0.4), skinMat); head.position.y = 1.7; character.add(head);
            const helmetGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5); const helmetMat = new THREE.MeshStandardMaterial({ color: 0x00eaff, roughness: 0.2 }); const helmet = new THREE.Mesh(helmetGeo, helmetMat); helmet.position.y = 1.7; helmet.visible = false; character.add(helmet);
            const armGeo = new THREE.BoxGeometry(0.15, 0.6, 0.15); const lArm = new THREE.Mesh(armGeo, shirtMat); lArm.position.set(0.4, 1.1, 0); character.add(lArm); const rArm = new THREE.Mesh(armGeo, shirtMat); rArm.position.set(-0.4, 1.1, 0); character.add(rArm);
            const legGeo = new THREE.BoxGeometry(0.2, 0.7, 0.2); const lLeg = new THREE.Mesh(legGeo, pantsMat); lLeg.position.set(0.15, 0.35, 0); character.add(lLeg); const rLeg = new THREE.Mesh(legGeo, pantsMat); rLeg.position.set(-0.15, 0.35, 0); character.add(rLeg);
            let backpack = null; if (hasBackpack) { backpack = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.5, 0.25), packMat); backpack.position.set(0, 1.15, -0.3); character.add(backpack); }
            character.userData.parts = { body, head, leftArm: lArm, rightArm: rArm, leftLeg: lLeg, rightLeg: rLeg, backpack, helmet };
            return character;
        }

        function createNPC(x, y, color, name, dialogs) {
            const group = new THREE.Group(); group.position.set(x, y, 0);
            const charGroup = createHumanoid(color, true); charGroup.position.y = 0; group.add(charGroup);
            const ring = new THREE.Mesh(new THREE.RingGeometry(0.8, 0.9, 32), new THREE.MeshBasicMaterial({ color: color, side: THREE.DoubleSide })); ring.rotation.x = -Math.PI/2; ring.position.y = 0.1; group.add(ring);
            const visor = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.15, 0.1), new THREE.MeshBasicMaterial({ color: 0xccffff })); visor.position.set(0, 1.8, 0.25); group.add(visor);
            group.userData = { isInteractable: true, name: name, dialogs: dialogs };
            scene.add(group); levelObjects.push(group); interactables.push(group);
            const hitBox = new THREE.Mesh(new THREE.BoxGeometry(2, 4, 2), new THREE.MeshBasicMaterial({ visible: false })); hitBox.position.set(x, y + 1, 0); addCollisionBox(hitBox);
        }

        function addCollisionBox(mesh, posOverride) {
            const box = new THREE.Box3().setFromObject(mesh);
            obstacles.push(box);
        }

        function createPlayer(agentId) {
            let color = CONFIG.colors.agent1; if (agentId === 2) color = CONFIG.colors.agent2;
            player = createHumanoid(color, true);
            scene.add(player);
            playerBody = new THREE.Box3();
        }

        function setupInputs() {
            document.addEventListener('keydown', (e) => { if (['KeyW', 'ArrowUp'].includes(e.code)) keys.w = true; if (['KeyS', 'ArrowDown'].includes(e.code)) keys.s = true; if (['KeyA', 'ArrowLeft'].includes(e.code)) keys.a = true; if (['KeyD', 'ArrowRight'].includes(e.code)) keys.d = true; if (e.code === 'Space' || e.code === 'Enter') checkInteraction(); });
            document.addEventListener('keyup', (e) => { if (['KeyW', 'ArrowUp'].includes(e.code)) keys.w = false; if (['KeyS', 'ArrowDown'].includes(e.code)) keys.s = false; if (['KeyA', 'ArrowLeft'].includes(e.code)) keys.a = false; if (['KeyD', 'ArrowRight'].includes(e.code)) keys.d = false; });
            window.addEventListener('pointerdown', (e) => { if (e.target.closest('.screen') || e.target.closest('#joystick-zone') || e.target.closest('#dialog-box') || e.target.closest('#computer-overlay')) return; isMouseDown = true; dragStartX = e.clientX; isDraggingView = false; });
            window.addEventListener('pointermove', (e) => { if (isMouseDown) { if (Math.abs(e.clientX - dragStartX) > 5) isDraggingView = true; if (isDraggingView) { cameraAngle -= (e.clientX - dragStartX) * 0.005; dragStartX = e.clientX; } } });
            window.addEventListener('pointerup', (e) => { isMouseDown = false; if (!isDraggingView) { mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; raycaster.setFromCamera(mouse, camera); const intersects = raycaster.intersectObjects(interactables, true); if (intersects.length > 0) { let target = intersects[0].object; while (target.parent && !target.userData.isInteractable) { target = target.parent; if (target === scene) break; } if (target.userData && target.userData.isInteractable && player.position.distanceTo(target.getWorldPosition(new THREE.Vector3())) < 15) handleInteraction(target); } } isDraggingView = false; });
            const joyZone = document.getElementById('joystick-zone');
            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) { const manager = nipplejs.create({ zone: joyZone, mode: 'static', position: { left: '50%', top: '50%' }, color: 'cyan' }); manager.on('move', (evt, data) => { const angle = data.angle.radian; const force = Math.min(data.force, 1.0); joystickVec.set(Math.cos(angle) * force, 0, -Math.sin(angle) * force); }); manager.on('end', () => joystickVec.set(0, 0, 0)); } else { joyZone.style.display = 'none'; }
        }

        function checkInteraction() {
            let nearest = null; let minDist = 4;
            interactables.forEach(obj => {
                const dist = player.position.distanceTo(obj.getWorldPosition(new THREE.Vector3()));
                if (dist < minDist) nearest = obj;
            });
            if (nearest) handleInteraction(nearest);
        }

        function handleInteraction(obj) {
            const data = obj.userData;
            let dialogs = data.dialogs || [];
            
            if (data.type === "DOOR") {
                if (data.target === "LOBBY") {
                    loadScene("LOBBY");
                    if (missionProgress === 4) { missionProgress = 5; updateHUD("Fim de Jogo", "#ffffff"); startDialog("SISTEMA", ["Bem-vindo de volta, Agente.", "Miss√£o 01 registrada com sucesso."]); }
                    return;
                }
                if (data.target === "CYBER_OPS") {
                    if (missionProgress >= 2) {
                        loadScene(data.target);
                        if (missionProgress < 3) { startDialog("SISTEMA", ["Acessando √°rea segura..."]); missionProgress = 3; updateHUD("Acesse o Terminal de Miss√£o", "#ff00ff"); }
                    } else { startDialog("SISTEMA", ["Acesso Bloqueado. Fale com a Agente J√∫lia."]); }
                    return;
                }
            }
            
            if (data.type === "PC_CUSTOM") {
                document.getElementById('computer-overlay').style.display = 'flex';
                document.getElementById('pc-view-custom').classList.remove('hidden');
                document.getElementById('pc-view-login').classList.add('hidden');
                document.getElementById('pc-view-puzzle').classList.add('hidden');
                document.getElementById('pc-view-social').classList.add('hidden');
                
                // Load custom state
                document.getElementById('custom-name').value = playerState.name;
                document.getElementById('custom-backpack-color').value = '#' + playerState.backpackColor.toString(16).padStart(6, '0');
                return;
            }

            if (data.type === "PC_MISSION") {
                document.getElementById('computer-overlay').style.display = 'flex';
                document.getElementById('pc-view-login').classList.remove('hidden');
                document.getElementById('pc-view-custom').classList.add('hidden');
                document.getElementById('pc-view-puzzle').classList.add('hidden');
                document.getElementById('pc-view-social').classList.add('hidden');
                return;
            }

            const npcName = data.name;
            if (npcName === "Comandante Motta") {
                if (missionProgress === 0) { updateHUD("Acesse o Terminal de Customiza√ß√£o", "#00ff88"); missionProgress = 1; }
                else if (missionProgress === 5) { dialogs = ["Excelente trabalho!"]; }
                else { dialogs = ["V√° falar com a J√∫lia ap√≥s se equipar."]; }
            } else if (npcName === "Agente J√∫lia") {
                if (missionProgress < 1) dialogs = ["Fale com o Comandante primeiro."];
                else if (missionProgress >= 1) { 
                    dialogs = ["Abrindo portal para Cyber Ops."]; 
                    updateHUD("Entre no Portal", "#d500f9"); 
                    missionProgress = 2; 
                }
            }
            startDialog(npcName, dialogs);
        }

        function updateHUD(text, color) {
            const hud = document.getElementById('obj-text');
            hud.innerText = text; hud.style.color = color; hud.style.textShadow = `0 0 10px ${color}`;
        }

        function startDialog(name, texts) {
            if (!texts || texts.length === 0) return;
            if (isDialogOpen) return;
            isDialogOpen = true;
            document.getElementById('dialog-box').style.display = 'block';
            document.getElementById('npc-name').innerText = name;
            currentDialogQueue = [...texts];
            advanceDialog();
        }

        window.advanceDialog = function () {
            if (!isDialogOpen) return;
            if (currentDialogQueue.length > 0) { document.getElementById('dialog-text').innerText = currentDialogQueue.shift(); } else { document.getElementById('dialog-box').style.display = 'none'; isDialogOpen = false; }
        }

        function update(dt) {
            if (isDialogOpen) return;
            const move = new THREE.Vector3(0, 0, 0);
            if (keys.w) move.z -= 1; if (keys.s) move.z += 1; if (keys.a) move.x -= 1; if (keys.d) move.x += 1;
            if (joystickVec.lengthSq() > 0) move.add(new THREE.Vector3(joystickVec.x, 0, -joystickVec.z));

            let groundY = 0; let onGround = false;
            if (player) {
                const rayOrigin = player.position.clone(); rayOrigin.y += 5;
                groundRaycaster.set(rayOrigin, new THREE.Vector3(0, -1, 0));
                const intersections = groundRaycaster.intersectObjects(floors, true);
                if (intersections.length > 0) { groundY = intersections[0].point.y; onGround = true; } else { onGround = false; }
            }

            if (move.lengthSq() > 0) {
                move.normalize(); move.applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraAngle);
                const speed = CONFIG.speed * dt;
                const nextPos = player.position.clone().add(move.multiplyScalar(speed));
                const checkOrigin = nextPos.clone(); checkOrigin.y += 5;
                groundRaycaster.set(checkOrigin, new THREE.Vector3(0, -1, 0));
                const nextGround = groundRaycaster.intersectObjects(floors, true);
                let canMove = true;
                if (nextGround.length === 0) canMove = false;
                playerBody.setFromCenterAndSize(nextPos, new THREE.Vector3(0.7, 2, 0.7));
                for (let box of obstacles) { if (playerBody.intersectsBox(box)) { canMove = false; break; } }
                if (canMove) {
                    player.position.copy(nextPos);
                    player.rotation.y = Math.atan2(move.x, move.z);
                    walkTime += dt * 12;
                    player.userData.parts.body.position.y = 1.1 + Math.sin(walkTime) * 0.05;
                    player.userData.parts.head.position.y = 1.7 + Math.sin(walkTime) * 0.05;
                    if(player.userData.parts.helmet) player.userData.parts.helmet.position.y = 1.7 + Math.sin(walkTime) * 0.05;
                    
                    player.userData.parts.leftArm.rotation.x = Math.sin(walkTime) * 0.6;
                    player.userData.parts.rightArm.rotation.x = -Math.sin(walkTime) * 0.6;
                    player.userData.parts.leftLeg.rotation.x = -Math.sin(walkTime) * 0.6;
                    player.userData.parts.rightLeg.rotation.x = Math.sin(walkTime) * 0.6;
                }
            } else {
                player.userData.parts.body.position.y = 1.1; player.userData.parts.head.position.y = 1.7;
                if(player.userData.parts.helmet) player.userData.parts.helmet.position.y = 1.7;
                player.userData.parts.leftArm.rotation.x = 0; player.userData.parts.rightArm.rotation.x = 0;
                player.userData.parts.leftLeg.rotation.x = 0; player.userData.parts.rightLeg.rotation.x = 0;
            }
            if (onGround) { player.position.y += (groundY - player.position.y) * 0.2; }
            const camDist = 25; const camHeight = 25;
            const offsetX = Math.sin(cameraAngle) * camDist; const offsetZ = Math.cos(cameraAngle) * camDist;
            const targetCamX = player.position.x + offsetX; const targetCamZ = player.position.z + offsetZ;
            camera.position.x += (targetCamX - camera.position.x) * 0.1;
            camera.position.z += (targetCamZ - camera.position.z) * 0.1;
            camera.position.y = camHeight;
            camera.lookAt(player.position);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (clock && player) {
                update(clock.getDelta());
                if (composer) composer.render(); 
                else renderer.render(scene, camera);
            }
        }

        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                if (composer) composer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>

</html>